import{a as _t,u as ft,r as d,s as u,l as V,j as s,p as yt}from"./main-DdaZa2uw.js";import{C as bt}from"./card-B5qOXzCs.js";import{B as D}from"./button-C8tPcSnA.js";import{B as xt}from"./badge-BIkuT5Lr.js";import{S as wt,a as Ct,b as St,c as jt,d as y}from"./select-CtQC0DVu.js";import{C as Dt}from"./checkbox-DkgSq4Mg.js";import"./tabs-C0jNhETU.js";import"./progress-oAkFP1UE.js";import{D as kt,g as f}from"./DashboardHeader-CzmIe9wt.js";import{S as b}from"./StatsCard-Cz7qpUAY.js";import"./input-1LHkCxOt.js";import"./dropdown-menu-BtcRZYAO.js";import"./label-C86gYWIM.js";import{u as At}from"./use-toast-BHHozLsU.js";import{a as Tt}from"./addDays-pVIPqqUr.js";import{B as Et}from"./bell-Dqfi8UjP.js";import{D as Ft}from"./download-CBaSo5wG.js";import{C as Nt}from"./calendar-BgLSegFA.js";import{F as Gt}from"./funnel-BiF3iJ2N.js";import{U as $t}from"./users-CL6i5PZL.js";import{C as Pt}from"./clipboard-list-e7I1pS1G.js";import{C as Mt}from"./clock-BPO994B-.js";import{C as Bt}from"./circle-alert-BEpCgrrb.js";import{T as Rt}from"./trending-up-Be37agIa.js";import{C as It}from"./circle-check-big-BzoCEh5i.js";import{f as C}from"./format-BcFT9btV.js";import"./SidebarPremium-DVCiHgHT.js";import"./house-BuCVh-jt.js";import"./book-open-BB96wzR_.js";import"./file-text-KG1EARAT.js";import"./graduation-cap-BXMQrtzB.js";import"./chart-column-fsDJzCSk.js";import"./message-circle-D6wHM5-f.js";import"./settings-Lxan3lFe.js";import"./index-Aqr4bB4c.js";import"./proxy-cOiZ72Cz.js";import"./chevron-right-D-Gd8Ev0.js";import"./x-Dfn-8env.js";import"./index-B7hVVF4G.js";import"./index-BbNaVbvl.js";import"./index-DljWCpXy.js";import"./index-Bjez3Xzb.js";import"./chevron-down-CKhbRXKe.js";import"./check-D-al-kKT.js";import"./chevron-up-CREhvnGD.js";import"./index-Chp0GnAd.js";import"./en-US-B6HbAA6N.js";function S(x,p,k){return Tt(x,-p,k)}const Re=()=>{const{user:x}=_t(),{toast:p}=At();ft();const[k,$]=d.useState(!0),[h,P]=d.useState("30"),[o,M]=d.useState([]),[Q,W]=d.useState(["all"]),[H,J]=d.useState(["graded"]),[A,X]=d.useState(!1),[Y,qt]=d.useState(!0),[w,Z]=d.useState([]),[c,T]=d.useState({totalStudents:0,totalActivities:0,pendingCorrections:0,avgGrade:0,onTimeRate:0,openActivities:0}),[tt,et]=d.useState([]),[st,B]=d.useState([]),[zt,R]=d.useState([]),[Ot,I]=d.useState([]),[at,E]=d.useState([]),[Ut,F]=d.useState(null),[Lt,it]=d.useState(null);d.useEffect(()=>{N()},[x,h,o,Q,H]),d.useEffect(()=>{let t;return A&&(t=setInterval(N,300*1e3)),()=>clearInterval(t)},[A]);const N=async()=>{if(x?.id){$(!0);try{if(await nt(),Y){const{data:t}=await u.auth.getSession(),a=t?.session?.access_token,i=await fetch("https://wapbwaimkurbuihatmix.supabase.co/functions/v1/get-teacher-analytics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({period:h,selectedClasses:o.length>0?o:w.map(r=>r.id)})});if(!i.ok)throw new Error("Erro ao carregar analytics");const e=await i.json(),n=e.data;T(n.kpis),E(n.topStudents||[]),await Promise.all([q(),z(),O(),U(),L(),K()]),e.cached&&p({title:"‚ö° Cache",description:"Dados carregados do cache (5min)",duration:2e3})}else await Promise.all([ot(),q(),z(),O(),U(),rt(),L(),K()])}catch(t){V.error("Erro ao carregar analytics:",t),p({title:"Erro",description:"N√£o foi poss√≠vel carregar os dados de analytics",variant:"destructive"})}finally{$(!1)}}},nt=async()=>{const{data:t,error:a}=await u.from("classes").select("id, name, subject, color").eq("created_by",x.id).eq("is_active",!0);!a&&t&&(Z(t),o.length===0&&M(t.map(i=>i.id)))},ot=async()=>{if(o.length===0){T({totalStudents:0,totalActivities:0,pendingCorrections:0,avgGrade:0,onTimeRate:0,openActivities:0});return}const t=h==="all"?null:C(S(new Date,parseInt(h)),"yyyy-MM-dd"),{data:a}=await u.from("class_members").select("user_id").in("class_id",o).eq("role","student"),i=new Set(a?.map(_=>_.user_id)||[]).size;let e=u.from("activity_class_assignments").select("activity_id, activities!inner(id, created_at, status)").in("class_id",o);t&&(e=e.gte("activities.created_at",t));const{data:n}=await e,r=new Set(n?.map(_=>_.activity_id)||[]).size,{data:l}=await u.from("submissions").select("id, activity_id, activities!inner(id, activity_class_assignments!inner(class_id))").eq("status","submitted").in("activities.activity_class_assignments.class_id",o),v=l?.length||0;let g=u.from("submissions").select("grade, activity_id, activities!inner(id, activity_class_assignments!inner(class_id))").not("grade","is",null).in("activities.activity_class_assignments.class_id",o);t&&(g=g.gte("graded_at",t));const{data:m}=await g,j=m?.length>0?(m.reduce((_,ht)=>_+(ht.grade||0),0)/m.length).toFixed(1):0,{data:G}=await u.from("submissions").select("submitted_at, activity_id, activities!inner(due_date, activity_class_assignments!inner(class_id))").eq("status","submitted").in("activities.activity_class_assignments.class_id",o).not("submitted_at","is",null).not("activities.due_date","is",null),mt=G?.filter(_=>new Date(_.submitted_at)<=new Date(_.activities.due_date)).length||0,gt=G?.length>0?Math.round(mt/G.length*100):0,{data:pt}=await u.from("activity_class_assignments").select("activity_id, activities!inner(status, due_date)").in("class_id",o).eq("activities.status","active").gte("activities.due_date",new Date().toISOString()),vt=pt?.length||0;T({totalStudents:i,totalActivities:r,pendingCorrections:v,avgGrade:parseFloat(j),onTimeRate:gt,openActivities:vt})},q=async()=>{const t=h==="all"?90:parseInt(h),a=C(S(new Date,t),"yyyy-MM-dd"),{data:i}=await u.from("submissions").select("grade, graded_at, activity_id, activities!inner(activity_class_assignments!inner(class_id))").not("grade","is",null).in("activities.activity_class_assignments.class_id",o).gte("graded_at",a).order("graded_at",{ascending:!0}),e={};i?.forEach(r=>{const l=C(new Date(r.graded_at),"dd/MM");e[l]||(e[l]=[]),e[l].push(r.grade)});const n=Object.entries(e).map(([r,l])=>({date:r,media:parseFloat((l.reduce((v,g)=>v+g,0)/l.length).toFixed(2)),submissoes:l.length}));et(n.slice(-30))},z=async()=>{if(o.length===0){B([]);return}const{data:t}=await u.from("submissions").select("grade, activity_id, activities!inner(activity_class_assignments!inner(class_id))").not("grade","is",null).in("activities.activity_class_assignments.class_id",o),a=[];for(const i of w.filter(e=>o.includes(e.id))){const e=t?.filter(v=>v.activities?.activity_class_assignments?.some(g=>g.class_id===i.id))||[],n=e.length>0?e.reduce((v,g)=>v+g.grade,0)/e.length:0;a.push({name:i.name,media:parseFloat(n.toFixed(2)),alunos:0,atividades:0,color:i.color||"#3B82F6"})}B(a.sort((i,e)=>e.media-i.media))},O=async()=>{if(o.length===0){R([]);return}const{data:t}=await u.from("submissions").select("grade, activity_id, activities!inner(activity_class_assignments!inner(class_id))").not("grade","is",null).in("activities.activity_class_assignments.class_id",o).limit(1e3),a=[{range:"0-2",count:0,color:"#EF4444"},{range:"2-4",count:0,color:"#F97316"},{range:"4-6",count:0,color:"#F59E0B"},{range:"6-8",count:0,color:"#3B82F6"},{range:"8-10",count:0,color:"#10B981"}];t?.forEach(({grade:i})=>{i<2?a[0].count++:i<4?a[1].count++:i<6?a[2].count++:i<8?a[3].count++:a[4].count++}),R(a)},U=async()=>{if(o.length===0){I([]);return}const t=C(S(new Date,84),"yyyy-MM-dd"),{data:a}=await u.from("submissions").select("submitted_at, activity_id, activities!inner(due_date, activity_class_assignments!inner(class_id))").eq("status","submitted").in("activities.activity_class_assignments.class_id",o).gte("submitted_at",t).limit(1e3),i=[];for(let e=0;e<12;e++){const n=S(new Date,(12-e)*7),r=S(new Date,(11-e)*7),l=a?.filter(m=>{const j=new Date(m.submitted_at);return j>=n&&j<=r})||[],v=l.filter(m=>m.activities?.due_date&&new Date(m.submitted_at)<=new Date(m.activities.due_date)).length,g=l.filter(m=>m.activities?.due_date&&new Date(m.submitted_at)>new Date(m.activities.due_date)).length;i.push({week:`S${12-e}`,noPrazo:v,atrasadas:g,total:l.length})}I(i)},rt=async()=>{if(o.length===0){E([]);return}const{data:t}=await u.from("submissions").select(`
        grade,
        student_id,
        student:profiles!submissions_student_id_fkey(id, full_name, avatar_url),
        activity_id,
        activities!inner(activity_class_assignments!inner(class_id))
      `).not("grade","is",null).in("activities.activity_class_assignments.class_id",o).limit(500),a={};t?.forEach(e=>{a[e.student_id]||(a[e.student_id]={student:e.student,grades:[],total:0}),a[e.student_id].grades.push(e.grade),a[e.student_id].total++});const i=Object.entries(a).map(([e,n])=>({id:e,name:n.student?.full_name||"Sem nome",avatar:n.student?.avatar_url,avgGrade:n.grades.reduce((r,l)=>r+l,0)/n.grades.length,activities:n.total})).sort((e,n)=>n.avgGrade-e.avgGrade).slice(0,10);E(i)},L=async()=>{if(o.length===0){F(null);return}const{data:t}=await u.from("plagiarism_checks").select(`
        plagiarism_percentage,
        ai_generated,
        submission_id,
        submissions!inner(activity_id, activities!inner(activity_class_assignments!inner(class_id)))
      `).in("submissions.activities.activity_class_assignments.class_id",o).limit(500);if(!t||t.length===0){F(null);return}const a=t.reduce((e,n)=>e+(100-(n.plagiarism_percentage||0)),0)/t.length,i=t.filter(e=>100-e.plagiarism_percentage<70).length;F({avgOriginality:Math.round(a),totalChecks:t.length,casesDetected:i,aiDetected:t.filter(e=>e.ai_generated).length})},K=async()=>{it({uniqueAccess:0,avgSessionTime:0,returnRate:0,interactions:0})},ct=async()=>{try{const t=[];t.push("TamanduAI - Analytics Dashboard"),t.push(`Per√≠odo: √öltimos ${h} dias`),t.push(`Data de Exporta√ß√£o: ${new Date().toLocaleString("pt-BR")}`),t.push(""),t.push("KPIs Principais"),t.push("Indicador,Valor"),t.push(`Total de Alunos,${c.totalStudents}`),t.push(`Total de Atividades,${c.totalActivities}`),t.push(`Corre√ß√µes Pendentes,${c.pendingCorrections}`),t.push(`M√©dia Geral,${c.avgGrade.toFixed(2)}`),t.push(`Taxa de Entrega no Prazo,${c.onTimeRate.toFixed(1)}%`),t.push(""),t.push("Evolu√ß√£o de Notas"),t.push("Per√≠odo,M√©dia"),tt.forEach(r=>{t.push(`${r.period},${r.avg}`)}),t.push(""),t.push("Compara√ß√£o de Turmas"),t.push("Turma,M√©dia"),st.forEach(r=>{t.push(`${r.name},${r.avg}`)}),t.push(""),t.push("Top 10 Alunos"),t.push("Posi√ß√£o,Nome,M√©dia,Atividades"),at.forEach((r,l)=>{t.push(`${l+1},${r.name},${r.avg},${r.count}`)});const a=t.join(`
`),i=new Blob([a],{type:"text/csv;charset=utf-8;"}),e=URL.createObjectURL(i),n=document.createElement("a");n.setAttribute("href",e),n.setAttribute("download",`analytics-dashboard-${C(new Date,"yyyy-MM-dd")}.csv`),document.body.appendChild(n),n.click(),document.body.removeChild(n),p({title:"‚úÖ Dashboard exportado!",description:"Arquivo CSV baixado com sucesso"})}catch(t){V.error("Erro ao exportar:",t),p({title:"‚ùå Erro ao exportar",description:t.message,variant:"destructive"})}},lt=()=>{const t=[];c.avgGrade<6&&t.push("‚ö†Ô∏è M√©dia da turma est√° abaixo de 6.0"),c.pendingCorrections>10&&t.push(`‚ö†Ô∏è ${c.pendingCorrections} corre√ß√µes pendentes`),c.onTimeRate<70&&t.push(`‚ö†Ô∏è Taxa de entrega no prazo est√° em ${c.onTimeRate.toFixed(1)}%`),t.length>0?p({title:"üîî Alertas Ativos",description:t.join(" ‚Ä¢ "),duration:5e3}):p({title:"‚úÖ Tudo certo!",description:"Nenhum alerta ativo no momento"})},dt=()=>{N(),p({title:"Filtros aplicados"})},ut=()=>{P("30"),M(w.map(t=>t.id)),W(["all"]),J(["graded"]),p({title:"Filtros limpos"})};return k?s.jsx("div",{className:"flex items-center justify-center min-h-screen",children:s.jsx(yt,{size:"lg"})}):s.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 p-6",children:[s.jsx(kt,{title:"Analytics e Insights",subtitle:"An√°lise completa de desempenho e tend√™ncias",role:"teacher",actions:s.jsxs("div",{className:"flex gap-2",children:[s.jsxs(D,{variant:"outline",onClick:lt,children:[s.jsx(Et,{className:"w-4 h-4 mr-2"}),"Configurar Alertas"]}),s.jsxs(D,{variant:"outline",onClick:ct,children:[s.jsx(Ft,{className:"w-4 h-4 mr-2"}),"Exportar Dashboard"]})]})}),s.jsxs(bt,{className:"p-6 mb-6 sticky top-0 z-10 bg-white dark:bg-slate-900 shadow-lg",children:[s.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[s.jsxs("div",{className:"flex-1 min-w-[200px]",children:[s.jsxs("label",{className:"block text-sm font-medium mb-2",children:[s.jsx(Nt,{className:"w-4 h-4 inline mr-2"}),"Per√≠odo"]}),s.jsxs(wt,{value:h,onValueChange:P,children:[s.jsx(Ct,{children:s.jsx(St,{})}),s.jsxs(jt,{children:[s.jsx(y,{value:"7",children:"√öltimos 7 dias"}),s.jsx(y,{value:"15",children:"√öltimos 15 dias"}),s.jsx(y,{value:"30",children:"√öltimos 30 dias"}),s.jsx(y,{value:"60",children:"√öltimos 60 dias"}),s.jsx(y,{value:"90",children:"√öltimos 90 dias"}),s.jsx(y,{value:"180",children:"√öltimos 180 dias"}),s.jsx(y,{value:"all",children:"Todo o Per√≠odo"})]})]})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs(D,{onClick:dt,children:[s.jsx(Gt,{className:"w-4 h-4 mr-2"}),"Aplicar Filtros"]}),s.jsx(D,{variant:"outline",onClick:ut,children:"Limpar"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Dt,{checked:A,onCheckedChange:X,id:"auto-refresh"}),s.jsx("label",{htmlFor:"auto-refresh",className:"text-sm cursor-pointer",children:"Auto-atualizar (5min)"})]})]}),o.length<w.length&&s.jsxs(xt,{className:"mt-3",children:[o.length," de ",w.length," turmas selecionadas"]})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-8",children:[s.jsx(b,{title:"Total de Alunos",value:c.totalStudents,icon:$t,gradient:f.primary,bgColor:"bg-blue-50 dark:bg-blue-950/30"}),s.jsx(b,{title:"Atividades Postadas",value:c.totalActivities,icon:Pt,gradient:f.info,bgColor:"bg-cyan-50 dark:bg-cyan-950/30"}),s.jsx(b,{title:"Atividades Abertas",value:c.openActivities,icon:Mt,gradient:f.warning,bgColor:"bg-yellow-50 dark:bg-yellow-950/30"}),s.jsx(b,{title:"Aguardando Corre√ß√£o",value:c.pendingCorrections,icon:Bt,gradient:f.danger,bgColor:"bg-red-50 dark:bg-red-950/30"}),s.jsx(b,{title:"Nota M√©dia Geral",value:c.avgGrade.toFixed(1),icon:Rt,gradient:c.avgGrade>=7?f.success:c.avgGrade>=5?f.warning:f.danger,bgColor:c.avgGrade>=7?"bg-green-50 dark:bg-green-950/30":"bg-yellow-50 dark:bg-yellow-950/30"}),s.jsx(b,{title:"Taxa Entrega no Prazo",value:`${c.onTimeRate}%`,icon:It,gradient:f.success,bgColor:"bg-green-50 dark:bg-green-950/30"})]}),s.jsx("div",{className:"text-center py-12 text-slate-500",children:s.jsx("p",{className:"text-sm",children:"Demais se√ß√µes em implementa√ß√£o..."})})]})};export{Re as default};
