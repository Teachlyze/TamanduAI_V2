import{s as o}from"./main-XRKQFEIr.js";import{N as g}from"./notificationOrchestrator-CAq-rZNW.js";const $={async getClasses({teacherId:e,studentId:r,activeOnly:t=!0}={}){try{let s=o.from("classes").select(`
          *,
          members:class_members(*, user:profiles(*)),
          meetings:meetings(*)
        `).order("name",{ascending:!0});e&&(s=s.eq("created_by",e)),t&&(s=s.eq("is_active",!0));const a=s,n=new Promise((u,l)=>setTimeout(()=>l(new Error("Query timeout")),5e3)),{data:c,error:d}=await Promise.race([a,n]);return d?(console.error("Error fetching classes:",d),[]):r?(c||[]).filter(u=>u.members?.some(l=>l.user_id===r&&l.role==="student")):c||[]}catch(s){return console.error("Error or timeout fetching classes:",s.message),[]}},async getClassById(e){try{const r=o.from("classes").select(`
          *,
          members:class_members(*, user:profiles(*)),
          meetings:meetings(*)
        `).eq("id",e).single(),t=new Promise((n,c)=>setTimeout(()=>c(new Error("Query timeout")),5e3)),{data:s,error:a}=await Promise.race([r,t]);return a?(console.error(`Error fetching class ${e}:`,a),null):s}catch(r){return console.error(`Error or timeout fetching class ${e}:`,r.message),null}},async createClass(e,r=[]){const{name:t,description:s,teacher_id:a,subject:n,course:c,period:d,grade_level:u,academic_year:l,color:y,student_capacity:h,school_id:b,is_school_managed:p,grading_system:v}=e;try{const i=o.from("profiles").select("id").eq("id",a).maybeSingle(),C=new Promise((_,q)=>setTimeout(()=>q(new Error("Profile check timeout")),3e3)),{data:E,error:S}=await Promise.race([i,C]);if(!E&&!S){console.log("Profile not found for teacher, creating one...");const{error:_}=await o.from("profiles").insert([{id:a,role:"teacher",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]);if(_&&(console.error("Error creating teacher profile:",_),_.code!=="23505"))throw new Error(`Erro ao criar perfil do professor: ${_.message}`)}}catch(i){console.warn("Profile check timed out, continuing without profile verification:",i.message)}const w={name:t,description:s||null,created_by:a,subject:n||null,course:c||null,period:d||null,grade_level:u||null,academic_year:(()=>{const i=parseInt(l,10);return Number.isFinite(i)?i:new Date().getFullYear()})(),grading_system:v||"0-10",color:y||"#6366f1",student_capacity:typeof h=="number"?h:30,room_number:e.room_number||null,is_online:!!e.is_online,meeting_link:e.meeting_link||null,chatbot_enabled:!!e.chatbot_enabled,school_id:b||null,is_school_managed:!!p,is_active:!0};console.log("Creating class with data:",w);const{data:f,error:m}=await o.from("classes").insert([w]).select().single();if(m)throw console.error("Error creating class:",m),console.error("Error details:",{code:m.code,message:m.message,details:m.details,hint:m.hint}),new Error(`Erro ao criar turma: ${m.message}. Detalhes: ${m.hint||m.details||"Nenhum detalhe adicional"}`);console.log("Class created successfully:",f);try{await g.send("classCreated",{userId:a,variables:{className:t},channelOverride:"push",metadata:{classId:f.id}})}catch(i){console.warn("Falha ao notificar criação de turma:",i)}try{const{error:i}=await o.from("class_members").insert([{class_id:f.id,user_id:a,role:"teacher",joined_at:new Date().toISOString()}]);i&&i.code!=="23505"&&console.warn("Erro ao adicionar professor como membro:",i)}catch(i){console.warn("Falha ao adicionar professor como membro da turma:",i)}if(r&&r.length>0)try{await this.addStudentsToClass(f.id,r)}catch(i){console.warn("Falha ao adicionar alunos:",i)}try{const{error:i}=await o.from("chatbot_configurations").upsert({class_id:f.id,enabled:!0,keywords:[],themes:[],scope_restrictions:[],created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{onConflict:"class_id"});i?console.warn("Erro ao garantir configuração do chatbot:",i):console.log("Chatbot configuration ensured for class:",f.id)}catch(i){console.warn("Falha ao garantir chatbot para a turma:",i)}return this.getClassById(f.id)},async updateClass(e,r,t){const s={...r||{}};if(Object.prototype.hasOwnProperty.call(s,"academic_year")){const n=parseInt(s.academic_year,10);s.academic_year=Number.isFinite(n)?n:new Date().getFullYear()}const{error:a}=await o.from("classes").update({...s,updated_at:new Date().toISOString()}).eq("id",e);if(a)throw console.error(`Error updating class ${e}:`,a),a;if(Array.isArray(t)){const{data:n}=await o.from("class_members").select("user_id").eq("class_id",e).eq("role","student"),c=(n||[]).map(l=>l.user_id),d=t.filter(l=>!c.includes(l)),u=c.filter(l=>!t.includes(l));await Promise.all([this.addStudentsToClass(e,d),this.removeStudentsFromClass(e,u)])}return this.getClassById(e)},async deleteClass(e){const{error:r}=await o.from("classes").update({is_active:!1,updated_at:new Date().toISOString()}).eq("id",e);if(r)throw console.error(`Error deleting class ${e}:`,r),r;return!0},async addStudentsToClass(e,r){if(!r||r.length===0)return[];const{data:t,error:s}=await o.from("class_members").insert(r.map(a=>({class_id:e,user_id:a,role:"student",joined_at:new Date().toISOString()}))).select();if(s)throw console.error(`Error adding students to class ${e}:`,s),s;try{const[{data:a},{data:n}]=await Promise.all([o.from("classes").select("id, name, created_by").eq("id",e).single(),o.from("profiles").select("id, full_name").in("id",r)]);if(a?.created_by&&n?.length)for(const c of n)await g.send("studentAddedToClass",{userId:a.created_by,variables:{studentName:c.full_name||"Aluno",className:a.name||"Turma"},channelOverride:"push",metadata:{classId:e,studentId:c.id}})}catch(a){console.warn("Falha ao notificar alunos adicionados:",a)}return t},async removeStudentsFromClass(e,r){if(!r||r.length===0)return!0;const{error:t}=await o.from("class_members").delete().eq("class_id",e).in("user_id",r).eq("role","student");if(t)throw console.error(`Error removing students from class ${e}:`,t),t;try{const[{data:s},{data:a}]=await Promise.all([o.from("classes").select("id, name").eq("id",e).single(),o.from("profiles").select("id, full_name").in("id",r)]);for(const n of a||[])await g.send("studentRemovedFromClass",{userId:n.id,email:void 0,variables:{className:s?.name||"Turma"},metadata:{classId:e}})}catch(s){console.warn("Falha ao notificar alunos removidos:",s)}return!0},async searchClasses(e,{onlyActive:r=!0}={}){let t=o.from("classes").select("*").or(`name.ilike.%${e}%,description.ilike.%${e}%`);r&&(t=t.eq("is_active",!0));const{data:s,error:a}=await t;if(a)throw console.error("Error searching classes:",a),a;return s},async updateClassSchedule(e,r){const{data:t,error:s}=await o.from("classes").update({vacation_start:r.vacation_start||null,vacation_end:r.vacation_end||null,cancelled_dates:r.cancelled_dates||null,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(s)throw console.error(`Error updating class schedule ${e}:`,s),s;return t},async getClassStats(e){try{const{data:r,error:t}=await o.from("class_members").select("user_id, role").eq("class_id",e);if(t)throw t;const{count:s,error:a}=await o.from("activity_class_assignments").select("*",{count:"exact",head:!0}).eq("class_id",e);if(a)throw a;const{data:n,error:c}=await o.from("submissions").select("id, activity_id").eq("status","pending").in("activity_id",o.from("activity_class_assignments").select("activity_id").eq("class_id",e)),d=r?.filter(l=>l.role==="student").length||0,u=r?.filter(l=>l.role==="teacher").length||0;return{studentCount:d,teacherCount:u,activitiesCount:s||0,pendingCorrections:n?.length||0,totalMembers:r?.length||0}}catch(r){return console.error(`Error getting stats for class ${e}:`,r),{studentCount:0,teacherCount:0,activitiesCount:0,pendingCorrections:0,totalMembers:0}}},async generateInviteCode(e){const r="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let t="";for(let n=0;n<8;n++)t+=r.charAt(Math.floor(Math.random()*r.length));const{data:s,error:a}=await o.from("classes").update({invite_code:t,updated_at:new Date().toISOString()}).eq("id",e).select("invite_code").single();if(a)throw console.error(`Error generating invite code for class ${e}:`,a),a;return s.invite_code},async archiveClass(e){const{error:r}=await o.from("classes").update({is_active:!1,updated_at:new Date().toISOString()}).eq("id",e);if(r)throw console.error(`Error archiving class ${e}:`,r),r;return!0},async getClassMembers(e,{role:r=null}={}){let t=o.from("class_members").select(`
        *,
        user:profiles(*)
      `).eq("class_id",e).order("joined_at",{ascending:!1});r&&(t=t.eq("role",r));const{data:s,error:a}=await t;if(a)throw console.error(`Error fetching members for class ${e}:`,a),a;return s},async joinClassByCode(e,r){const{data:t,error:s}=await o.from("classes").select("*").eq("invite_code",e).eq("is_active",!0).single();if(s||!t)throw new Error("Código de turma inválido ou turma não encontrada");const{data:a}=await o.from("class_members").select("id").eq("class_id",t.id).eq("user_id",r).single();if(a)throw new Error("Você já é membro desta turma");const{data:n,error:c}=await o.from("class_members").insert({class_id:t.id,user_id:r,role:"student",joined_at:new Date().toISOString()}).select().single();if(c)throw console.error("Error joining class:",c),new Error("Erro ao entrar na turma");try{const{data:d}=await o.from("profiles").select("full_name").eq("id",r).single();await g.send("studentJoinedClass",{userId:t.created_by,variables:{studentName:d?.full_name||"Novo aluno",className:t.name},channelOverride:"push",metadata:{classId:t.id,studentId:r}})}catch(d){console.warn("Failed to notify teacher:",d)}return t},async getClassByInviteCode(e){const{data:r,error:t}=await o.from("classes").select(`
        *,
        teacher:profiles!classes_created_by_fkey(id, full_name, name, avatar_url)
      `).eq("invite_code",e).eq("is_active",!0).single();if(t||!r)throw new Error("Código de turma inválido");return r},subscribeToClasses(e){const r=o.channel("classes_changes").on("postgres_changes",{event:"*",schema:"public",table:"classes"},t=>{e(t)}).subscribe();return()=>{o.removeChannel(r)}}};export{$ as C};
