import{r as d,j as e,h as M,u as X,s as W,l as J,q as Y}from"./main-DuZ82yZp.js";import{B as S}from"./button-Bb_PT1Zw.js";import{C as D}from"./card-Y5GuAOBh.js";import{B as Q}from"./badge-CYDBAKPn.js";import{u as q}from"./use-toast--Kt9lPdf.js";import{c as U,D as ee}from"./DashboardHeader-tZN5fEm4.js";import{I as te}from"./input-CNTeUzfK.js";import"./dropdown-menu-bsHScCX3.js";import{L as V}from"./label-CSZx0yin.js";import{Z as se}from"./zap-Dam69ooS.js";import{S as ae}from"./sparkles-Cm3KW2On.js";import{S as re}from"./save-RZiqvH4S.js";import{X as ie}from"./x-BmzKUBis.js";import{c as ne,a as le,g as oe}from"./autoGradingService-CQY59QA_.js";import{A as de}from"./arrow-left-DsSoZ4ff.js";import{U as ce}from"./user-B3viVWFP.js";import{F as me}from"./file-text-Ds7d3BVP.js";import{C as ue}from"./index-BxUCIcQa.js";import{C as xe}from"./chevron-right-CEvqiGs0.js";import"./proxy-CHWBjvZ-.js";import"./index-D_uLVLL-.js";import"./index-CKfYXJSH.js";import"./index-BDaM9qEV.js";import"./Combination-C8JUOhgz.js";import"./SidebarPremium-DYZaD6CT.js";import"./house-CFiJxlWl.js";import"./users-BE0uReGI.js";import"./book-open-eUF-sl3F.js";import"./graduation-cap-CgmDIIy4.js";import"./calendar-D_hx0NAw.js";import"./chart-column-sFA7nJXK.js";import"./message-circle-EiX5rzcs.js";import"./settings-CD03lnZ4.js";import"./brain-DGA-WCwF.js";import"./index-Uqsq8EqP.js";import"./index-DyWjD93x.js";import"./check-RJxRYmjs.js";const be=({maxGrade:c=10,initialGrade:v=null,initialFeedback:f="",onSave:O,onCancel:A,onAutoGrade:R,onAISuggestion:E,loading:t=!1,canUseAutoGrade:G=!1,canUseAI:b=!1})=>{const[u,p]=d.useState(v?.toString()||""),[C,g]=d.useState(f),[w,h]=d.useState({}),[_,L]=d.useState(!1),[F,z]=d.useState(!1),H=()=>{const r={};if(!u||u.trim()==="")r.grade="Nota é obrigatória";else{const x=parseFloat(u);isNaN(x)?r.grade="Nota deve ser um número":x<0?r.grade="Nota não pode ser negativa":x>c&&(r.grade=`Nota não pode ser maior que ${c}`)}return h(r),Object.keys(r).length===0},P=r=>{if(r.preventDefault(),!H())return;const x=parseFloat(u);O({grade:x,feedback:C})},T=r=>{const x=r.target.value;(x===""||/^\d*\.?\d*$/.test(x))&&(p(x),w.grade&&h({...w,grade:null}))};return e.jsx(D,{className:"p-6 bg-white dark:bg-slate-900",children:e.jsxs("form",{onSubmit:P,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs(V,{htmlFor:"grade",className:"text-sm font-semibold mb-2 block",children:["Nota (0 - ",c,")"]}),e.jsxs("div",{className:"relative",children:[e.jsx(te,{id:"grade",type:"text",value:u,onChange:T,placeholder:`Ex: ${(c/2).toFixed(1)}`,className:`text-lg font-semibold ${w.grade?"border-red-500 focus:ring-red-500":""}`,disabled:t}),e.jsxs("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-sm text-slate-500",children:["/ ",c]})]}),w.grade&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:w.grade}),u&&!isNaN(parseFloat(u))&&e.jsx("div",{className:"mt-2",children:e.jsx("div",{className:"h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full transition-all ${parseFloat(u)>=c*.7?"bg-green-500":parseFloat(u)>=c*.5?"bg-yellow-500":"bg-red-500"}`,style:{width:`${Math.min(parseFloat(u)/c*100,100)}%`}})})})]}),(G||b)&&e.jsxs("div",{className:"flex gap-2",children:[G&&e.jsx(S,{type:"button",variant:"outline",size:"sm",onClick:async()=>{L(!0);try{const r=await R?.();r&&(p(r.grade?.toString()||""),g(r.feedback||""))}finally{L(!1)}},disabled:t||_||F,className:"flex-1",children:_?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mr-2"}),"Corrigindo..."]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-4 h-4 mr-2 text-amber-500"}),"Correção Automática"]})}),b&&e.jsx(S,{type:"button",variant:"outline",size:"sm",onClick:async()=>{z(!0);try{const r=await E?.();r?.feedback&&g(r.feedback)}finally{z(!1)}},disabled:t||_||F,className:"flex-1",children:F?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-purple-600 border-t-transparent rounded-full animate-spin mr-2"}),"Gerando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"w-4 h-4 mr-2 text-purple-500"}),"Sugestão por IA"]})})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"feedback",className:"text-sm font-semibold mb-2 block",children:"Feedback (opcional)"}),e.jsx("textarea",{id:"feedback",value:C,onChange:r=>g(r.target.value),placeholder:"Escreva um feedback para o aluno...",rows:6,disabled:t,className:`
              w-full px-3 py-2 rounded-lg border ${U.border.default}
              bg-white dark:bg-slate-900 ${U.text.primary}
              focus:ring-2 focus:ring-blue-500 focus:border-blue-500
              resize-none transition-all
            `}),e.jsxs("p",{className:"mt-1 text-xs text-slate-500 dark:text-slate-500",children:[C.length," caracteres"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(S,{type:"submit",disabled:t,className:"flex-1 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white",children:t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"Salvando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),"Salvar Nota"]})}),A&&e.jsxs(S,{type:"button",variant:"outline",onClick:A,disabled:t,children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"Cancelar"]})]})]})})},qe=()=>{const{submissionId:c}=M(),v=X(),{toast:f}=q(),[O,A]=d.useState(!0),[R,E]=d.useState(!1),[t,G]=d.useState(null),[b,u]=d.useState(null),[p,C]=d.useState(null),[g,w]=d.useState([]),[h,_]=d.useState(0),[L,F]=d.useState(!1);d.useEffect(()=>{H()},[c]);const z=()=>{if(!t?.content)return e.jsx("p",{className:"text-slate-600 dark:text-slate-400",children:"Nenhum conteúdo enviado."});if(typeof t.content=="string")return e.jsx("div",{className:"p-4 bg-slate-50 dark:bg-slate-950 rounded-lg",children:e.jsx("div",{style:{whiteSpace:"pre-wrap",wordBreak:"break-word",overflowWrap:"break-word",maxWidth:"100%",overflow:"hidden",fontFamily:"inherit",fontSize:"0.875rem",lineHeight:"1.5"},children:t.content})});try{const a=typeof t.content=="string"?JSON.parse(t.content):t.content||{},i=a.selectedAnswers||a.answers||a,n=b?.content?.questions||[];return n.length===0?e.jsx("div",{className:"space-y-4",children:Object.entries(i).map(([s,l],k)=>e.jsx("div",{className:"p-4 bg-slate-50 dark:bg-slate-950 rounded-lg border border-slate-200 dark:border-slate-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-blue-600 dark:text-blue-300 font-bold flex-shrink-0",children:k+1}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"text-sm font-medium text-slate-900 dark:text-white mb-1",children:["Questão ",k+1]}),e.jsxs("div",{className:"text-sm text-slate-700 dark:text-slate-300",style:{whiteSpace:"pre-wrap",wordBreak:"break-word",overflowWrap:"break-word",maxWidth:"100%",overflow:"hidden",lineHeight:"1.5"},children:[e.jsx("span",{className:"font-semibold",children:"Resposta: "}),Array.isArray(l)?l.join(", "):l]})]})]})},s))}):e.jsx("div",{className:"space-y-4",children:n.map((s,l)=>{const k=s.id??l,m=i?.[k]??i?.[String(k)];let B=m;if(s.alternatives&&s.alternatives.length>0&&m!==void 0&&m!==null){const o=String(m),N=s.alternatives.find(I=>String(I.id)===o),y=s.alternatives.find(I=>String(I.letter)===o),Z=s.alternatives.find(I=>I.text===m);B=(N||y||Z)?.text||o}let j=null;if(s.alternatives&&s.alternatives.length>0){const o=s.alternatives.filter(N=>N.isCorrect);o.length>0&&(j=o.map(N=>N.text).join(", "))}!j&&s.answerKey&&(j=s.answerKey);let $=!1;if(s.alternatives&&s.alternatives.length>0&&m!==void 0&&m!==null){const o=String(m);$=s.alternatives.filter(y=>y.isCorrect).some(y=>String(y.id)===o||String(y.letter)===o||y.text===m)}else if(s.answerKey){const o=s.answerKey;$=Array.isArray(m)?Array.isArray(o)&&m.length===o.length&&m.every(N=>o.includes(N)):m===o}const K=!!j;return e.jsx("div",{className:`p-4 rounded-lg border-2 ${K?$?"bg-emerald-50 dark:bg-emerald-950/30 border-emerald-300 dark:border-emerald-800":"bg-red-50 dark:bg-red-950/30 border-red-300 dark:border-red-800":"bg-slate-50 dark:bg-slate-950 border-slate-200 dark:border-slate-800"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center font-bold flex-shrink-0 ${K?$?"bg-emerald-500 text-white":"bg-red-500 text-white":"bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300"}`,children:l+1}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-semibold text-slate-900 dark:text-white mb-2",children:`Questão ${l+1}`}),s.text&&e.jsx("p",{className:"text-sm text-slate-700 dark:text-slate-300 mb-2",children:s.text}),e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"text-xs font-medium text-slate-600 dark:text-slate-400",children:"Resposta do aluno:"}),e.jsx("div",{className:"text-sm font-medium text-slate-900 dark:text-white mt-1",style:{whiteSpace:"pre-wrap",wordBreak:"break-word",overflowWrap:"break-word",maxWidth:"100%",overflow:"hidden",lineHeight:"1.5"},children:Array.isArray(B)?B.join(", "):B||"Sem resposta"})]}),j&&e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-slate-600 dark:text-slate-400",children:"Gabarito:"}),e.jsx("div",{className:"text-sm font-medium text-emerald-600 dark:text-emerald-400 mt-1",style:{whiteSpace:"pre-wrap",wordBreak:"break-word",overflowWrap:"break-word",maxWidth:"100%",overflow:"hidden",lineHeight:"1.5"},children:Array.isArray(j)?j.join(", "):j})]}),K&&e.jsx("div",{className:"mt-2",children:$?e.jsx(Q,{className:"bg-emerald-500 text-white",children:"✓ Correta"}):e.jsx(Q,{className:"bg-red-500 text-white",children:"✗ Incorreta"})})]})]})},s.id)})})}catch{return e.jsx("div",{className:"p-4 bg-slate-50 dark:bg-slate-950 rounded-lg",children:e.jsx("div",{style:{whiteSpace:"pre-wrap",wordBreak:"break-word",overflowWrap:"break-word",maxWidth:"100%",overflow:"auto",fontFamily:"monospace",fontSize:"0.875rem",lineHeight:"1.5"},children:JSON.stringify(t.content,null,2)})})}},H=async()=>{try{A(!0);const{data:a,error:i}=await W.from("submissions").select(`
          *,
          student:profiles!student_id(id, full_name, email, avatar_url),
          activity:activities!activity_id(id, title, max_score, due_date, content)
        `).eq("id",c).single();if(i){J.error("Erro ao carregar submissão:",i),f({title:"Erro ao carregar submissão",description:i?.message||"Não foi possível encontrar esta submissão.",variant:"destructive"}),v("/dashboard/corrections");return}if(G(a),u(a.activity),a.activity&&F(ne(a.activity)),a.activity_id){const{data:l}=await W.from("activity_class_assignments").select(`
            class_id,
            classes:class_id(id, name, subject)
          `).eq("activity_id",a.activity_id).single();l?.classes&&C(l.classes)}const{data:n,error:s}=await W.from("submissions").select("id, student_id, status").eq("activity_id",a.activity_id).order("submitted_at",{ascending:!0});if(!s){w(n||[]);const l=n?.findIndex(k=>k.id===c)??0;_(l)}}catch(a){f({title:"Erro ao carregar submissão",description:a?.message||"Tente novamente.",variant:"destructive"})}finally{A(!1)}},P=async()=>{if(!b||!t)return null;try{const a=typeof t.content=="string"?JSON.parse(t.content):t.content||{},i=a.selectedAnswers||a.answers||a,n=b.content?.questions||[],s=le(n,i,b.max_score);if(s){const l=oe(s);return f({title:"Correção automática concluída",description:`Nota: ${s.grade}/${b.max_score} (${s.correctCount}/${s.totalQuestions} corretas)`}),{grade:s.grade,feedback:l}}}catch(a){J.error("Erro na correção automática:",a),f({title:"Erro na correção automática",description:"Não foi possível corrigir automaticamente.",variant:"destructive"})}return null},T=async()=>{if(!t||!b)return null;try{return f({title:"Sugestão por IA",description:"Em breve você poderá gerar feedback com IA!"}),{feedback:`Revisão da submissão realizada.

Pontos fortes:
- Organização das respostas
- Compreensão do conteúdo

Pontos de melhoria:
- Revisar conceitos específicos
- Aprofundar justificativas`}}catch(a){J.error("Erro ao gerar sugestão por IA:",a),f({title:"Erro",description:"Não foi possível gerar sugestão.",variant:"destructive"})}return null},r=async({grade:a,feedback:i})=>{try{E(!0);const{error:n}=await W.from("submissions").update({grade:a,feedback:i,status:"graded",graded_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",c);if(n)throw n;if(f({title:"✅ Nota salva com sucesso!",description:"O feedback foi enviado ao aluno."}),h<g.length-1){const s=g[h+1];v(`/dashboard/grading/${s.id}`)}else v("/dashboard/corrections")}catch(n){f({title:"Erro ao salvar nota",description:n?.message||"Tente novamente em instantes.",variant:"destructive"})}finally{E(!1)}},x=a=>{const i=a==="prev"?h-1:h+1;if(i>=0&&i<g.length){const n=g[i];v(`/dashboard/grading/${n.id}`)}};return O?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(Y,{size:"lg",text:"Carregando submissão..."})}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 p-6",children:[e.jsxs(S,{variant:"ghost",onClick:()=>v("/dashboard/corrections"),className:"mb-4",children:[e.jsx(de,{className:"w-4 h-4 mr-2"}),"Voltar para Submissões"]}),e.jsx(ee,{title:`Corrigir Submissão${t?.student?.full_name?` - ${t.student.full_name}`:""}`,subtitle:`${b?.title||"Atividade"}${p?.name?` • Turma: ${p.name}`:""} • ${h+1} de ${g.length}`,role:"teacher"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs(D,{className:"p-6 bg-white dark:bg-slate-900",children:[e.jsxs("h3",{className:"text-lg font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2",children:[e.jsx(ce,{className:"w-5 h-5"}),"Informações do Aluno"]}),e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[t?.student?.avatar_url?e.jsx("img",{src:t.student.avatar_url,alt:t.student.full_name,className:"w-16 h-16 rounded-full object-cover"}):e.jsx("div",{className:"w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-white text-2xl font-bold",children:t?.student?.full_name?.[0]||"A"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-slate-900 dark:text-white text-lg",children:t?.student?.full_name||"Aluno"}),e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400",children:t?.student?.email||"Sem email"}),p&&e.jsxs("p",{className:"text-sm font-medium text-blue-600 dark:text-blue-400 mt-1",children:[p.name," ",p.subject&&`- ${p.subject}`]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"Data de Envio:"}),e.jsx("p",{className:"font-semibold text-slate-900 dark:text-white",children:t?.submitted_at?new Date(t.submitted_at).toLocaleString("pt-BR"):"Não enviada"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"Status:"}),e.jsx("div",{className:"mt-1",children:e.jsx(Q,{className:t?.status==="graded"?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300":"bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300",children:t?.status==="graded"?"Corrigida":"Pendente"})})]})]})]}),e.jsxs(D,{className:"p-6 bg-white dark:bg-slate-900",children:[e.jsxs("h3",{className:"text-lg font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2",children:[e.jsx(me,{className:"w-5 h-5"}),"Conteúdo da Submissão"]}),e.jsx("div",{className:"max-w-none",children:z()})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(be,{maxGrade:b?.max_score||10,initialGrade:t?.grade,initialFeedback:t?.feedback||"",onSave:r,onCancel:()=>v("/dashboard/corrections"),onAutoGrade:P,onAISuggestion:T,loading:R,canUseAutoGrade:L,canUseAI:!0}),e.jsx(D,{className:"p-4 bg-white dark:bg-slate-900",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(S,{variant:"outline",onClick:()=>x("prev"),disabled:h===0,children:[e.jsx(ue,{className:"w-4 h-4 mr-2"}),"Anterior"]}),e.jsxs("span",{className:"text-sm text-slate-600 dark:text-slate-400",children:[h+1," de ",g.length]}),e.jsxs(S,{variant:"outline",onClick:()=>x("next"),disabled:h>=g.length-1,children:["Próxima",e.jsx(xe,{className:"w-4 h-4 ml-2"})]})]})})]})]})]})};export{qe as default};
