import{s as o,l as i}from"./main-KTzSHcut.js";import{N as h}from"./notificationOrchestrator-Cci3Z37O.js";const F={async getClasses({teacherId:e,studentId:r,activeOnly:t=!0}={}){try{let s=o.from("classes").select(`
          *,
          members:class_members(*, user:profiles(*)),
          meetings:meetings(*)
        `).order("name",{ascending:!0});e&&(s=s.eq("created_by",e)),t&&(s=s.eq("is_active",!0));const a=s,c=new Promise((f,d)=>setTimeout(()=>d(new Error("Query timeout")),5e3)),{data:l,error:m}=await Promise.race([a,c]);return m?(i.error("Error fetching classes:",m),[]):r?(l||[]).filter(f=>f.members?.some(d=>d.user_id===r&&d.role==="student")):l||[]}catch(s){return i.error("Error or timeout fetching classes:",s.message),[]}},async getClassById(e){try{const r=o.from("classes").select(`
          *,
          members:class_members(*, user:profiles(*)),
          meetings:meetings(*)
        `).eq("id",e).single(),t=new Promise((c,l)=>setTimeout(()=>l(new Error("Query timeout")),5e3)),{data:s,error:a}=await Promise.race([r,t]);return a?(i.error(`Error fetching class ${e}:`,a),null):s}catch(r){return i.error(`Error or timeout fetching class ${e}:`,r.message),null}},async createClass(e,r=[]){const{name:t,description:s,teacher_id:a,subject:c,course:l,period:m,grade_level:f,academic_year:d,color:y,student_capacity:w,school_id:p,is_school_managed:v,grading_system:C}=e;try{const n=o.from("profiles").select("id").eq("id",a).maybeSingle(),E=new Promise((g,P)=>setTimeout(()=>P(new Error("Profile check timeout")),3e3)),{data:S,error:q}=await Promise.race([n,E]);if(!S&&!q){i.debug("Profile not found for teacher, creating one...");const{error:g}=await o.from("profiles").insert([{id:a,role:"teacher",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]);if(g&&(i.error("Error creating teacher profile:",g),g.code!=="23505"))throw new Error(`Erro ao criar perfil do professor: ${g.message}`)}}catch(n){i.warn("Profile check timed out, continuing without profile verification:",n.message)}const b={name:t,description:s||null,created_by:a,subject:c||null,course:l||null,period:m||null,grade_level:f||null,academic_year:(()=>{const n=parseInt(d,10);return Number.isFinite(n)?n:new Date().getFullYear()})(),grading_system:C||"0-10",color:y||"#6366f1",student_capacity:typeof w=="number"?w:30,room_number:e.room_number||null,is_online:!!e.is_online,meeting_link:e.meeting_link||null,chatbot_enabled:!!e.chatbot_enabled,school_id:p||null,is_school_managed:!!v,is_active:!0};i.debug("Creating class with data:",b);const{data:_,error:u}=await o.from("classes").insert([b]).select().single();if(u)throw i.error("Error creating class:",u),console.error("Error details:",{code:u.code,message:u.message,details:u.details,hint:u.hint}),new Error(`Erro ao criar turma: ${u.message}. Detalhes: ${u.hint||u.details||"Nenhum detalhe adicional"}`);i.debug("Class created successfully:",_);try{await h.send("classCreated",{userId:a,variables:{className:t},channelOverride:"push",metadata:{classId:_.id}})}catch(n){i.warn("Falha ao notificar criação de turma:",n)}try{const{error:n}=await o.from("class_members").insert([{class_id:_.id,user_id:a,role:"teacher",joined_at:new Date().toISOString()}]);n&&n.code!=="23505"&&i.warn("Erro ao adicionar professor como membro:",n)}catch(n){i.warn("Falha ao adicionar professor como membro da turma:",n)}if(r&&r.length>0)try{await this.addStudentsToClass(_.id,r)}catch(n){i.warn("Falha ao adicionar alunos:",n)}try{const{error:n}=await o.from("chatbot_configurations").upsert({class_id:_.id,enabled:!0,keywords:[],themes:[],scope_restrictions:[],created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{onConflict:"class_id"});n?i.warn("Erro ao garantir configuração do chatbot:",n):i.debug("Chatbot configuration ensured for class:",_.id)}catch(n){i.warn("Falha ao garantir chatbot para a turma:",n)}return this.getClassById(_.id)},async updateClass(e,r,t){const s={...r||{}};if(Object.prototype.hasOwnProperty.call(s,"academic_year")){const c=parseInt(s.academic_year,10);s.academic_year=Number.isFinite(c)?c:new Date().getFullYear()}const{error:a}=await o.from("classes").update({...s,updated_at:new Date().toISOString()}).eq("id",e);if(a)throw i.error(`Error updating class ${e}:`,a),a;if(Array.isArray(t)){const{data:c}=await o.from("class_members").select("user_id").eq("class_id",e).eq("role","student"),l=(c||[]).map(d=>d.user_id),m=t.filter(d=>!l.includes(d)),f=l.filter(d=>!t.includes(d));await Promise.all([this.addStudentsToClass(e,m),this.removeStudentsFromClass(e,f)])}return this.getClassById(e)},async deleteClass(e){const{error:r}=await o.from("classes").update({is_active:!1,updated_at:new Date().toISOString()}).eq("id",e);if(r)throw i.error(`Error deleting class ${e}:`,r),r;return!0},async addStudentsToClass(e,r){if(!r||r.length===0)return[];const{data:t,error:s}=await o.from("class_members").insert(r.map(a=>({class_id:e,user_id:a,role:"student",joined_at:new Date().toISOString()}))).select();if(s)throw i.error(`Error adding students to class ${e}:`,s),s;try{const[{data:a},{data:c}]=await Promise.all([o.from("classes").select("id, name, created_by").eq("id",e).single(),o.from("profiles").select("id, full_name").in("id",r)]);if(a?.created_by&&c?.length)for(const l of c)await h.send("studentAddedToClass",{userId:a.created_by,variables:{studentName:l.full_name||"Aluno",className:a.name||"Turma"},channelOverride:"push",metadata:{classId:e,studentId:l.id}})}catch(a){i.warn("Falha ao notificar alunos adicionados:",a)}return t},async removeStudentsFromClass(e,r){if(!r||r.length===0)return!0;const{error:t}=await o.from("class_members").delete().eq("class_id",e).in("user_id",r).eq("role","student");if(t)throw i.error(`Error removing students from class ${e}:`,t),t;try{const[{data:s},{data:a}]=await Promise.all([o.from("classes").select("id, name").eq("id",e).single(),o.from("profiles").select("id, full_name").in("id",r)]);for(const c of a||[])await h.send("studentRemovedFromClass",{userId:c.id,email:void 0,variables:{className:s?.name||"Turma"},metadata:{classId:e}})}catch(s){i.warn("Falha ao notificar alunos removidos:",s)}return!0},async searchClasses(e,{onlyActive:r=!0}={}){let t=o.from("classes").select("*").or(`name.ilike.%${e}%,description.ilike.%${e}%`);r&&(t=t.eq("is_active",!0));const{data:s,error:a}=await t;if(a)throw i.error("Error searching classes:",a),a;return s},async updateClassSchedule(e,r){const{data:t,error:s}=await o.from("classes").update({vacation_start:r.vacation_start||null,vacation_end:r.vacation_end||null,cancelled_dates:r.cancelled_dates||null,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(s)throw i.error(`Error updating class schedule ${e}:`,s),s;return t},async getClassStats(e){try{const{data:r,error:t}=await o.from("class_members").select("user_id, role").eq("class_id",e);if(t)throw t;const{count:s,error:a}=await o.from("activity_class_assignments").select("*",{count:"exact",head:!0}).eq("class_id",e);if(a)throw a;const{data:c,error:l}=await o.from("submissions").select("id, activity_id").eq("status","pending").in("activity_id",o.from("activity_class_assignments").select("activity_id").eq("class_id",e)),m=r?.filter(d=>d.role==="student").length||0,f=r?.filter(d=>d.role==="teacher").length||0;return{studentCount:m,teacherCount:f,activitiesCount:s||0,pendingCorrections:c?.length||0,totalMembers:r?.length||0}}catch(r){return i.error(`Error getting stats for class ${e}:`,r),{studentCount:0,teacherCount:0,activitiesCount:0,pendingCorrections:0,totalMembers:0}}},async generateInviteCode(e){const r="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let t="";for(let c=0;c<8;c++)t+=r.charAt(Math.floor(Math.random()*r.length));const{data:s,error:a}=await o.from("classes").update({invite_code:t,updated_at:new Date().toISOString()}).eq("id",e).select("invite_code").single();if(a)throw i.error(`Error generating invite code for class ${e}:`,a),a;return s.invite_code},async archiveClass(e){const{error:r}=await o.from("classes").update({is_active:!1,updated_at:new Date().toISOString()}).eq("id",e);if(r)throw i.error(`Error archiving class ${e}:`,r),r;return!0},async getClassMembers(e,{role:r=null}={}){let t=o.from("class_members").select(`
        *,
        user:profiles(*)
      `).eq("class_id",e).order("joined_at",{ascending:!1});r&&(t=t.eq("role",r));const{data:s,error:a}=await t;if(a)throw i.error(`Error fetching members for class ${e}:`,a),a;return s},async joinClassByCode(e,r){const{data:t,error:s}=await o.from("classes").select("*").eq("invite_code",e).eq("is_active",!0).single();if(s||!t)throw new Error("Código de turma inválido ou turma não encontrada");const{data:a}=await o.from("class_members").select("id").eq("class_id",t.id).eq("user_id",r).single();if(a)throw new Error("Você já é membro desta turma");const{data:c,error:l}=await o.from("class_members").insert({class_id:t.id,user_id:r,role:"student",joined_at:new Date().toISOString()}).select().single();if(l)throw i.error("Error joining class:",l),new Error("Erro ao entrar na turma");try{const{data:m}=await o.from("profiles").select("full_name").eq("id",r).single();await h.send("studentJoinedClass",{userId:t.created_by,variables:{studentName:m?.full_name||"Novo aluno",className:t.name},channelOverride:"push",metadata:{classId:t.id,studentId:r}})}catch(m){i.warn("Failed to notify teacher:",m)}return t},async getClassByInviteCode(e){const{data:r,error:t}=await o.from("classes").select(`
        *,
        teacher:profiles!classes_created_by_fkey(id, full_name, name, avatar_url)
      `).eq("invite_code",e).eq("is_active",!0).single();if(t||!r)throw new Error("Código de turma inválido");return r},subscribeToClasses(e){const r=o.channel("classes_changes").on("postgres_changes",{event:"*",schema:"public",table:"classes"},t=>{e(t)}).subscribe();return()=>{o.removeChannel(r)}}};export{F as C};
