import{b as ht,u as vt,r as b,l as y,s as n,j as t}from"./main-BSajwT7t.js";import{u as xt}from"./use-toast-CI7Qu0JR.js";import{u as ft,S as C}from"./useStudentEvolutionData-DOUXwSTz.js";import{A as bt}from"./ActivityCard-qMdKTQ78.js";import{E as yt}from"./EventCard-ayT1TdPw.js";import{C as _}from"./card-Bocxgg1Q.js";import{E as F}from"./EmptyState-BIeHtL9h.js";import{B as j}from"./button-49_9eRW2.js";import"./dialog-CToh4lty.js";import{m as L}from"./proxy-Bb-A2TUD.js";import{C as _t}from"./circle-alert-DnNDG1se.js";import{B as K}from"./book-open-BqVBcqQl.js";import{F as W}from"./file-text-Bwu_iaa-.js";import{S as Y}from"./star-CpuiYB3v.js";import{T as jt}from"./target-Cq_bYOkK.js";import{C as wt}from"./circle-check-CZIrgVO6.js";import{T as Nt}from"./trending-up-hgXaA--6.js";import{Y as H,_ as U,$ as X,a0 as J,a1 as Q}from"./CartesianChart-DGi_X4pD.js";import{L as St,a as kt}from"./LineChart-BOMtsEef.js";import{B as Ct,a as At}from"./BarChart-DqW7KkU7.js";import{C as E}from"./calendar-DetO6w5d.js";import{s as Et}from"./format-B5colFmK.js";import{e as Tt}from"./endOfDay-BZ13SNr-.js";import"./useRedisCache-Bcf7HeY8.js";import"./pt-BR-D0BJ_iDf.js";import"./en-US-DaE-csDX.js";import"./differenceInHours-DYlE495b.js";import"./getRoundingMethod-D0I6Z7xl.js";import"./formatDistanceToNow-sn9sU9NS.js";import"./constructNow-BZVcxkR5.js";import"./differenceInCalendarMonths-CtUCBvak.js";import"./endOfMonth-B3jF8fTW.js";import"./badge-CfC7p-Az.js";import"./video-GMK5YjAg.js";import"./clock-DUfJelbJ.js";import"./map-pin-Ed5qSEFg.js";import"./index-BSMAqeIB.js";import"./index-D0BS1fLY.js";import"./Combination-DKLEa6f3.js";import"./SidebarPremium-C1f4icTt.js";import"./house-BkBGIUz8.js";import"./users-De1bkoUV.js";import"./graduation-cap-pwvok64K.js";import"./chart-column-BmPD_DCR.js";import"./message-circle-DVaucFfj.js";import"./settings-Blsx5C_z.js";import"./brain-BPIciAtW.js";import"./index-DV-1B3c4.js";import"./chevron-right-DUVlURpD.js";import"./x-Wvu9FBm3.js";import"./index-BfMW92y8.js";const Es=()=>{const{user:l}=ht(),x=vt(),{toast:Z}=xt(),[Dt,T]=b.useState(!0),[tt,st]=b.useState(!0),[f,D]=b.useState({totalClasses:0,pendingActivities:0,completedActivities:0,avgGrade:0,completionRate:0,gradeTrend:null}),[I,q]=b.useState([]),[M,et]=b.useState([]),{data:G}=ft(10),[R,B]=b.useState([]),[O,at]=b.useState([]),V=Array.isArray(G)?G:[];b.useEffect(()=>{l?.id&&it()},[l]);const it=async()=>{try{T(!0),await Promise.all([rt(),nt(),ot(),dt(),ct()])}catch(s){y.error("Erro ao carregar dashboard:",s),Z({title:"Erro ao carregar informaÃ§Ãµes",description:"NÃ£o foi possÃ­vel carregar seu painel. Tente novamente em instantes.",variant:"destructive"})}finally{T(!1),tt&&st(!1)}},rt=async()=>{try{const{data:s}=await n.from("class_members").select("class_id").eq("user_id",l.id).eq("role","student"),i=s?.map(r=>r.class_id)||[],p=i.length;if(i.length===0){D({totalClasses:0,pendingActivities:0,completedActivities:0,avgGrade:0,completionRate:0,gradeTrend:null});return}const{data:v}=await n.from("activity_class_assignments").select("activity_id, activity:activities(id, title, due_date, max_score)").in("class_id",i),o=v?.map(r=>r.activity_id).filter(Boolean)||[],{data:g}=await n.from("submissions").select("activity_id, status, grade, submitted_at").eq("student_id",l.id).in("activity_id",o),h=(g||[]).filter(r=>r.status==="submitted"||r.status==="graded"),m=new Set(h.map(r=>r.activity_id)),u=o.filter(r=>!m.has(r)).length,a=h.length,c=g?.filter(r=>r.grade!==null)||[],d=c.length>0?c.reduce((r,S)=>r+parseFloat(S.grade),0)/c.length:0;let e=null;if(c.length>=2){const r=[...c].sort((k,w)=>new Date(k.submitted_at)-new Date(w.submitted_at)),S=5,A=r.length,P=Math.max(A-S,0),lt=Math.max(A-2*S,0),mt=r.slice(P,A),$=r.slice(lt,P);if($.length>0){const k=z=>z.reduce((pt,gt)=>pt+parseFloat(gt.grade),0)/z.length,w=k($),ut=k(mt);w>0?e=Math.round((ut-w)/w*100):e=0}else e=0}const N=o.length>0?Math.round(a/o.length*100):0;D({totalClasses:p,pendingActivities:u,completedActivities:a,avgGrade:d,completionRate:N,gradeTrend:e})}catch(s){y.error("Erro ao carregar stats:",s)}},nt=async()=>{try{const{data:s}=await n.from("class_members").select("class_id").eq("user_id",l.id).eq("role","student"),i=s?.map(e=>e.class_id)||[];if(i.length===0){q([]);return}const{data:p}=await n.from("activity_class_assignments").select("activity_id, class_id, assigned_at").in("class_id",i),v=p?.map(e=>e.activity_id).filter(Boolean)||[],{data:o}=await n.from("activities").select("id, title, description, type, due_date, max_score").in("id",v),{data:g}=await n.from("classes").select("id, name, subject").in("id",i),h={};o?.forEach(e=>{h[e.id]=e});const m={};g?.forEach(e=>{m[e.id]=e});const{data:u}=await n.from("submissions").select("activity_id, status, grade").eq("student_id",l.id).in("activity_id",v),a=(u||[]).filter(e=>e.status==="submitted"||e.status==="graded"),c=new Set(a.map(e=>e.activity_id)),d=(p||[]).filter(e=>h[e.activity_id]&&!c.has(e.activity_id)).map(e=>{const N=h[e.activity_id],r=m[e.class_id];return{...N,class_name:r?.name,class_subject:r?.subject,status:new Date(N.due_date)<new Date?"late":"pending"}}).slice(0,5);q(d)}catch(s){y.error("Erro ao carregar atividades pendentes:",s)}},ot=async()=>{try{const{data:s}=await n.from("class_members").select("class_id").eq("user_id",l.id).eq("role","student"),i=s?.map(d=>d.class_id)||[],p=new Date,v=Et(p),o=Tt(p),{data:g}=await n.from("calendar_events").select("id, title, description, start_time, end_time, type, modality, location, meeting_link, class_id").in("class_id",i).gte("start_time",v.toISOString()).lte("start_time",o.toISOString()).order("start_time",{ascending:!0}),{data:h}=await n.from("calendar_events").select("id, title, description, start_time, end_time, type, modality, location, meeting_link, attendees, class_id").contains("attendees",[l.id]).gte("start_time",v.toISOString()).lte("start_time",o.toISOString()).order("start_time",{ascending:!0}),{data:m}=await n.from("classes").select("id, name").in("id",i),u={};m?.forEach(d=>{u[d.id]=d.name});const a=new Set,c=[...g||[],...h||[]].filter(d=>a.has(d.id)?!1:(a.add(d.id),!0)).map(d=>({...d,class_name:u[d.class_id]}));et(c)}catch(s){y.error("Erro ao carregar eventos de hoje:",s)}},dt=async()=>{try{const{data:s}=await n.from("class_members").select("class_id").eq("user_id",l.id).eq("role","student"),i=s?.map(o=>o.class_id)||[];if(i.length===0){B([]);return}const{data:p}=await n.from("classes").select("id, name, subject").in("id",i),v=await Promise.all((p||[]).map(async o=>{const{data:g}=await n.from("activity_class_assignments").select("activity_id").eq("class_id",o.id),h=g?.map(c=>c.activity_id)||[],{data:m}=await n.from("submissions").select("grade").eq("student_id",l.id).in("activity_id",h).not("grade","is",null),u=m?.map(c=>parseFloat(c.grade))||[],a=u.length>0?u.reduce((c,d)=>c+d,0)/u.length:0;return{name:o.name,value:a}}));B(v.sort((o,g)=>g.value-o.value).slice(0,5))}catch(s){y.error("Erro ao carregar top turmas:",s)}},ct=async()=>{try{const{data:s}=await n.from("class_members").select("class_id").eq("user_id",l.id).eq("role","student"),i=s?.map(a=>a.class_id)||[],{data:p}=await n.from("activity_class_assignments").select(`
          activity_id,
          activity:activities(id, title, due_date)
        `).in("class_id",i),v=p?.map(a=>a.activity_id).filter(Boolean)||[],{data:o}=await n.from("submissions").select("activity_id, status").eq("student_id",l.id).in("activity_id",v),g=(o||[]).filter(a=>a.status==="submitted"||a.status==="graded"),h=new Set(g.map(a=>a.activity_id)||[]),m=(p||[]).filter(a=>a.activity&&!h.has(a.activity.id)&&new Date(a.activity.due_date)<new Date),u=[];m.length>0&&u.push({type:"warning",message:`VocÃª tem ${m.length} atividade${m.length>1?"s":""} atrasada${m.length>1?"s":""}!`}),at(u)}catch(s){y.error("Erro ao carregar alertas:",s)}};return t.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-amber-50 via-blue-50/30 to-cyan-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 p-6",children:[t.jsxs(L.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"bg-gradient-to-r from-blue-600 via-blue-600 to-cyan-600 rounded-2xl p-8 mb-8 text-white shadow-xl",children:[t.jsxs("h1",{className:"text-3xl font-bold mb-2",children:["OlÃ¡, ",l?.user_metadata?.name||l?.email?.split("@")[0]||"Estudante","!"]}),t.jsx("p",{className:"text-blue-100 text-lg",children:f.avgGrade>=8?"ðŸŽ‰ Seu desempenho estÃ¡ Ã³timo! Continue assim!":f.avgGrade>=6?"ðŸ‘ VocÃª estÃ¡ indo bem! Mantenha o foco!":f.avgGrade>0?"Vamos melhorar juntos! VocÃª consegue!":"ðŸ“š Comece suas atividades e acompanhe seu progresso!"})]}),O.length>0&&t.jsx(L.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"mb-8",children:O.map((s,i)=>t.jsx(_,{className:"p-4 bg-orange-50 dark:bg-orange-950/20 border-orange-300 dark:border-orange-800",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(_t,{className:"w-5 h-5 text-orange-600"}),t.jsx("p",{className:"text-orange-900 dark:text-orange-200 font-medium",children:s.message}),t.jsx(j,{variant:"outline",size:"sm",onClick:()=>x("/students/activities"),className:"ml-auto",children:"Ver Atividades"})]})},i))}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8",children:[t.jsx(C,{icon:K,value:f.totalClasses,label:"Turmas Ativas",gradient:"blue"}),t.jsx(C,{icon:W,value:f.pendingActivities,label:"Atividades Pendentes",gradient:"orange"}),t.jsx(C,{icon:Y,value:f.avgGrade>0?f.avgGrade.toFixed(1):"--",label:"MÃ©dia Geral",gradient:"yellow",trend:f.gradeTrend}),t.jsx(C,{icon:jt,value:`${f.completionRate}%`,label:"Taxa de ConclusÃ£o",gradient:"green"})]}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 lg:gap-8 mb-6 md:mb-8",children:[t.jsxs("div",{className:"lg:col-span-2 space-y-4 md:space-y-6 lg:space-y-8",children:[t.jsxs(_,{className:"p-4 sm:p-6",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0 mb-4 sm:mb-6",children:[t.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-slate-900 dark:text-white",children:"PrÃ³ximas Atividades"}),t.jsx(j,{variant:"ghost",onClick:()=>x("/students/activities"),className:"text-blue-600 hover:text-blue-700",children:"Ver todas â†’"})]}),I.length>0?t.jsx("div",{className:"space-y-4",children:I.map((s,i)=>t.jsx(bt,{activity:s,onStart:()=>x(`/students/activities/${s.id}`),onView:()=>x(`/students/activities/${s.id}`),index:i},s.id))}):t.jsx(F,{icon:wt,title:"Tudo em dia!",description:"VocÃª nÃ£o tem atividades pendentes no momento. ParabÃ©ns!",variant:"success"})]}),V.length>0&&t.jsxs(_,{className:"p-6",children:[t.jsxs("h2",{className:"text-2xl font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2",children:[t.jsx(Nt,{className:"w-6 h-6 text-blue-600"}),"Sua EvoluÃ§Ã£o"]}),t.jsx("div",{className:"overflow-x-auto",children:t.jsx(H,{width:"100%",height:300,className:"min-w-[400px]",children:t.jsxs(St,{data:V,margin:{top:5,right:20,left:0,bottom:5},children:[t.jsx(U,{strokeDasharray:"3 3",stroke:"#e2e8f0"}),t.jsx(X,{dataKey:"date",stroke:"#64748b",tick:{fontSize:12}}),t.jsx(J,{stroke:"#64748b",domain:[0,10],tick:{fontSize:12}}),t.jsx(Q,{contentStyle:{backgroundColor:"white",border:"1px solid #e2e8f0",borderRadius:"8px"}}),t.jsx(kt,{type:"monotone",dataKey:"nota",stroke:"#3b82f6",strokeWidth:3,dot:{fill:"#3b82f6",r:6},activeDot:{r:8},name:"MÃ©dia"})]})})})]}),R.length>0&&t.jsxs(_,{className:"p-6",children:[t.jsx("h2",{className:"text-2xl font-bold text-slate-900 dark:text-white mb-6",children:"Melhores Turmas"}),t.jsx("div",{className:"overflow-x-auto",children:t.jsx(H,{width:"100%",height:250,className:"min-w-[350px]",children:t.jsxs(Ct,{data:R,margin:{top:5,right:20,left:0,bottom:5},children:[t.jsx(U,{strokeDasharray:"3 3",stroke:"#e2e8f0"}),t.jsx(X,{dataKey:"name",stroke:"#64748b",tick:{fontSize:11},angle:-15,textAnchor:"end",height:60}),t.jsx(J,{stroke:"#64748b",domain:[0,10],tick:{fontSize:12}}),t.jsx(Q,{contentStyle:{backgroundColor:"white",border:"1px solid #e2e8f0",borderRadius:"8px"}}),t.jsx(At,{dataKey:"value",fill:"#10b981",radius:[8,8,0,0],name:"MÃ©dia"})]})})})]})]}),t.jsxs("div",{className:"space-y-8",children:[t.jsxs(_,{className:"p-6",children:[t.jsxs("h2",{className:"text-xl font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2",children:[t.jsx(E,{className:"w-5 h-5 text-blue-600"}),"Hoje"]}),M.length>0?t.jsx("div",{className:"space-y-3",children:M.map((s,i)=>t.jsx(yt,{event:s,onClick:()=>x("/students/calendar"),index:i},s.id))}):t.jsx(F,{icon:E,title:"Nenhum evento",description:"Sua agenda estÃ¡ livre hoje!",variant:"info"})]}),t.jsxs(_,{className:"p-6",children:[t.jsx("h2",{className:"text-xl font-bold text-slate-900 dark:text-white mb-4",children:"Atalhos RÃ¡pidos"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs(j,{variant:"outline",className:"w-full justify-start",onClick:()=>x("/students/activities"),children:[t.jsx(W,{className:"w-4 h-4 mr-2"}),"Minhas Atividades"]}),t.jsxs(j,{variant:"outline",className:"w-full justify-start",onClick:()=>x("/students/classes"),children:[t.jsx(K,{className:"w-4 h-4 mr-2"}),"Minhas Turmas"]}),t.jsxs(j,{variant:"outline",className:"w-full justify-start",onClick:()=>x("/students/calendar"),children:[t.jsx(E,{className:"w-4 h-4 mr-2"}),"Agenda"]}),t.jsxs(j,{variant:"outline",className:"w-full justify-start",onClick:()=>x("/students/performance"),children:[t.jsx(Y,{className:"w-4 h-4 mr-2"}),"Minhas Notas"]})]})]})]})]})]})};export{Es as default};
