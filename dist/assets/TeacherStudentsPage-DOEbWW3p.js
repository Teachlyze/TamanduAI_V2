import{u as z,b as Q,r as l,s as f,l as H,j as e,q as O}from"./main-CDwcRVbo.js";import{B as R}from"./button-BuH7Xbht.js";import{B as k}from"./badge-C6gXtPyv.js";import{D as V,g as j}from"./DashboardHeader-MvNqeZZV.js";import{S as g}from"./StatsCard-DSbLqF9t.js";import{E as J}from"./EmptyState-CJmiWSXk.js";import"./card-BeDiIhdC.js";import{S as K}from"./SearchInput-D2EbP7P-.js";import{F as Y}from"./FilterBar-DyWeWrcH.js";import{D as Z}from"./DataTable-qXOmauZR.js";import"./input-BByzzpRS.js";import"./label-CwZn5L96.js";import{U as C}from"./users-CgJEdG6v.js";import{G as ee}from"./graduation-cap-D_9lOntz.js";import{T as se}from"./trending-up-DCuPlkSP.js";import{A as F}from"./award-BzkgCaDU.js";import"./proxy-BQZ2TmvR.js";import"./chevron-right-C7mHeVR8.js";import"./search-6oujL9dj.js";import"./x-Dx_XJWp3.js";import"./dropdown-menu-DUHtGofS.js";import"./index-Dh6vDsM6.js";import"./index-CPGjc502.js";import"./index-CqoVHjef.js";import"./index-CcEjAaVA.js";import"./Combination-CkmxMhvN.js";import"./SidebarPremium-DtY86ggr.js";import"./house-BzSw2wbQ.js";import"./book-open-B_wcLpnO.js";import"./file-text-DqPfoEgV.js";import"./calendar-BqfKTByC.js";import"./chart-column-CiDVUyDs.js";import"./message-circle-B9SdJZHY.js";import"./settings-DAYbyNc3.js";import"./brain-B546Q6XX.js";import"./index-CrH3dQlI.js";import"./index-Bnl_O2Nv.js";import"./check-CJ5iHYK_.js";import"./funnel-DW0F4wdC.js";import"./chevron-down-C12er63L.js";import"./chevron-up-CjnVXTVX.js";const $e=()=>{const I=z(),{user:x}=Q(),[L,h]=l.useState(!0),[b,P]=l.useState(!0),[y,T]=l.useState([]),[S,E]=l.useState([]),[o,_]=l.useState(""),[n,N]=l.useState({classId:null}),[d,q]=l.useState({total:0,classesWithStudents:0,averageGrade:0,totalXP:0}),[v,w]=l.useState([]);l.useEffect(()=>{B()},[x]),l.useEffect(()=>{G()},[y,o,n]);const B=async()=>{if(x)try{h(!0);const{data:a}=await f.from("classes").select("id, name").eq("created_by",x.id);w(a||[]);const s=a?.map(t=>t.id)||[];if(s.length===0){h(!1);return}const{data:r}=await f.from("class_members").select(`
          user_id,
          class_id,
          user:profiles(id, full_name, email, avatar_url)
        `).in("class_id",s).eq("role","student"),c=new Map;r?.forEach(t=>{c.has(t.user_id)||c.set(t.user_id,{id:t.user_id,name:t.user?.full_name,email:t.user?.email,avatar:t.user?.avatar_url,classes:[]});const i=a.find(u=>u.id===t.class_id)?.name;i&&c.get(t.user_id).classes.push(i)});const D=Array.from(c.values()),m=await Promise.all(D.map(async t=>{const{data:i}=await f.from("submissions").select("grade").eq("student_id",t.id).not("grade","is",null),u=i?.map(p=>p.grade).filter(p=>p!==null)||[],U=u.length>0?u.reduce((p,$)=>p+$,0)/u.length:0,{data:A}=await f.from("gamification_profiles").select("xp_total, level").eq("user_id",t.id).single();return{...t,average:Number(U.toFixed(2)),xp:A?.xp_total||0,level:A?.level||1}}));T(m);const M=m.reduce((t,i)=>t+i.xp,0),W=m.length>0?m.reduce((t,i)=>t+i.average,0)/m.length:0;q({total:m.length,classesWithStudents:s.length,averageGrade:Number(W.toFixed(2)),totalXP:M})}catch(a){H.error("Erro:",a)}finally{h(!1),b&&P(!1)}},G=()=>{let a=[...y];if(o){const s=o.toLowerCase();a=a.filter(r=>r.name?.toLowerCase().includes(s)||r.email?.toLowerCase().includes(s))}if(n.classId){const s=v.find(r=>r.id===n.classId)?.name;a=a.filter(r=>r.classes.includes(s))}E(a)},X=[{key:"name",label:"Aluno",sortable:!0,render:(a,s)=>e.jsxs("div",{className:"flex items-center gap-3",children:[s.avatar?e.jsx("img",{src:s.avatar,alt:s.name,className:"w-10 h-10 rounded-full"}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-white font-bold",children:s.name?.[0]||"A"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:s.name||"Sem nome"}),e.jsx("div",{className:"text-sm text-slate-600 dark:text-slate-400",children:s.email})]})]})},{key:"classes",label:"Turmas",render:(a,s)=>e.jsxs("div",{className:"flex flex-wrap gap-1",children:[s.classes.slice(0,3).map((r,c)=>e.jsx(k,{variant:"secondary",children:r},c)),s.classes.length>3&&e.jsxs(k,{variant:"secondary",children:["+",s.classes.length-3]})]})},{key:"average",label:"Média",sortable:!0,render:(a,s)=>e.jsx("span",{className:"font-semibold",children:s.average>0?s.average.toFixed(2):"-"})},{key:"xp",label:"XP / Level",sortable:!0,render:(a,s)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"w-4 h-4 text-amber-500"}),e.jsxs("span",{children:[s.xp," XP"]}),e.jsxs("span",{className:"text-xs text-slate-600 dark:text-slate-400",children:["Lv ",s.level]})]})},{key:"actions",label:"Ações",align:"right",render:(a,s)=>e.jsx(R,{size:"sm",variant:"ghost",onClick:()=>I(`/dashboard/students/${s.id}`),children:"Ver Perfil"})}];return L&&b?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(O,{size:"lg"})}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 p-6",children:[e.jsx(V,{title:"Meus Alunos",subtitle:`${d.total} aluno${d.total!==1?"s":""}`,role:"teacher"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8",children:[e.jsx(g,{title:"Total de Alunos",value:d.total,icon:C,gradient:j.stats.students,delay:0}),e.jsx(g,{title:"Turmas",value:d.classesWithStudents,icon:ee,gradient:j.stats.classes,delay:.1}),e.jsx(g,{title:"Média Geral",value:d.averageGrade.toFixed(2),icon:se,gradient:j.success,format:"text",delay:.2}),e.jsx(g,{title:"XP Total",value:d.totalXP,icon:F,gradient:"from-amber-500 to-orange-500",delay:.3})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 mb-8",children:[e.jsx("div",{className:"flex-1",children:e.jsx(K,{placeholder:"Buscar por nome ou email...",value:o,onChange:_})}),v.length>0&&e.jsx(Y,{filters:[{key:"classId",label:"Turma",options:v.map(a=>({value:a.id,label:a.name}))}],activeFilters:n,onFilterChange:(a,s)=>N(r=>({...r,[a]:s})),onClearAll:()=>{N({classId:null}),_("")}})]}),S.length>0?e.jsx(Z,{columns:X,data:S,sortBy:"name",sortOrder:"asc"}):e.jsx(J,{icon:C,title:o||n.classId?"Nenhum aluno encontrado":"Nenhum aluno ainda",description:o||n.classId?"Ajuste os filtros.":"Seus alunos aparecerão aqui."})]})};export{$e as default};
