import{s as O,r as g}from"./main-CDwcRVbo.js";let U=!1;const S={DEBUG:0,INFO:1,WARN:2,ERROR:3,CRITICAL:4},B=()=>S["INFO".toUpperCase()]??S.INFO,P=t=>t>=B(),j=()=>{try{return{userId:null,userEmail:null,sessionId:sessionStorage.getItem("session_id")||J()}}catch{return{userId:null,userEmail:null,sessionId:"unknown"}}},J=()=>{const t=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return sessionStorage.setItem("session_id",t),t},G=(t,e,s=null)=>{const r=new Date().toISOString(),a=j();return{timestamp:r,level:S[t],levelName:t,message:e,data:s?JSON.stringify(s):null,userId:a.userId,userEmail:a.userEmail,sessionId:a.sessionId,userAgent:navigator.userAgent,url:window.location.href,environment:"production"}},$=async t=>{try{if(U||!(t.level>=S.ERROR))return;const{error:s}=await O.from("application_logs").insert([{timestamp:t.timestamp,level:t.level,level_name:t.levelName,message:t.message,data:t.data,user_id:t.userId,user_email:t.userEmail,session_id:t.sessionId,user_agent:t.userAgent,url:t.url,environment:t.environment}]);if(s){const r=(s?.message||"").toLowerCase();if((s?.code||"")==="PGRST205"||r.includes("could not find the table 'public.application_logs'")){U=!0,t("WARN","[Logger] application_logs table not found. Disabling DB logging for this session.");return}t("ERROR","[Logger] Failed to save log to database:",s)}}catch(e){t("ERROR","[Logger] Error saving log:",e)}},z=(t,e,s=null)=>{const r={DEBUG:"color: #6b7280; font-weight: normal;",INFO:"color: #3b82f6; font-weight: normal;",WARN:"color: #f59e0b; font-weight: bold;",ERROR:"color: #ef4444; font-weight: bold;",CRITICAL:"color: #dc2626; font-weight: bold; background: #fee2e2; padding: 2px 4px; border-radius: 2px;"},a=new Date().toLocaleTimeString();(t==="ERROR"||t==="CRITICAL")&&(s?console.debug(`%c[${a}] ${t}: ${e}`,r[t],s):console.debug(`%c[${a}] ${t}: ${e}`,r[t]))},p=async(t,e,s=null)=>{if(!P(S[t]))return;const r=G(t,e,s);z(t,e,s),await $(r),t==="CRITICAL"&&window.Sentry&&window.Sentry.captureException(new Error(e),{extra:{data:s,logData:r}})},i={debug:(t,e)=>p("DEBUG",t,e),info:(t,e)=>p("INFO",t,e),warn:(t,e)=>p("WARN",t,e),error:(t,e)=>p("ERROR",t,e),critical:(t,e)=>p("CRITICAL",t,e),setUserContext:(t,e)=>{try{typeof window<"u"&&(sessionStorage.setItem("user_id",t),sessionStorage.setItem("user_email",e))}catch(s){p("ERROR","[Logger] Error setting user context:",s)}},clearUserContext:()=>{try{typeof window<"u"&&(sessionStorage.removeItem("user_id"),sessionStorage.removeItem("user_email"))}catch(t){p("ERROR","[Logger] Error clearing user context:",t)}}},q="false".toLowerCase()==="true";class V{constructor(){this.metrics={cache:{hits:0,misses:0,errors:0,sets:0,deletes:0,stale:0,invalidations:0},api:{calls:0,errors:0,latency:[],byEndpoint:{}},auth:{login:{success:0,errors:0},sessionChecks:0,permissionChecks:0,tokenRefreshes:0,tokenErrors:0},performance:{pageLoad:[],apiCall:[],render:[]},errors:[]},this.initialized=!1,this.pageLoadStart=Date.now(),this.init()}init(){this.initialized||typeof window>"u"||(this.interval=setInterval(()=>this.logMetrics(),300*1e3),this.initialized=!0,window.addEventListener("load",()=>{const e=Date.now()-this.pageLoadStart;this.recordPageLoad(e)}),window.addEventListener("beforeunload",()=>this.logMetrics()),this.setupErrorHandling(),this.setupPerformanceMonitoring())}setupErrorHandling(){window.onerror=(e,s,r,a,o)=>(this.trackError({type:"unhandled_error",message:o?.message||e,stack:o?.stack,source:s,lineno:r,colno:a}),!1),window.addEventListener("unhandledrejection",e=>{this.trackError({type:"unhandled_rejection",message:e.reason?.message||"Unhandled promise rejection",stack:e.reason?.stack})})}setupPerformanceMonitoring(){if(!window.performance)return;const e=performance.getEntriesByType("navigation")[0];if(e){const{domComplete:r,loadEventEnd:a,domInteractive:o,domContentLoadedEventEnd:c}=e;this.recordPageLoad(a),i.info("Page load metrics",{domLoad:r,pageLoad:a,domInteractive:o,domContentLoaded:c})}performance.getEntriesByType("resource").forEach(r=>{i.debug("Resource loaded",{name:r.name,duration:r.duration,initiatorType:r.initiatorType,transferSize:r.transferSize})})}recordPageLoad(e){return this.metrics.performance.pageLoad.push(e),this.metrics.performance.pageLoad.length>100&&this.metrics.performance.pageLoad.shift(),e}apiCall(e,s,r={}){this.metrics.api.calls++,this.metrics.api.latency.push(s),this.metrics.api.byEndpoint[e]||(this.metrics.api.byEndpoint[e]={calls:0,errors:0,totalLatency:0,avgLatency:0});const a=this.metrics.api.byEndpoint[e];return a.calls++,a.totalLatency+=s,a.avgLatency=a.totalLatency/a.calls,i.info("API Call",{endpoint:e,duration:s,...r}),s}apiError(e,s){return this.metrics.api.errors++,this.metrics.api.byEndpoint[e]&&this.metrics.api.byEndpoint[e].errors++,this.trackError({type:"api_error",endpoint:e,message:s?.message||"Unknown API error",stack:s?.stack,status:s?.status,code:s?.code}),s}trackError(e){const s=new Date().toISOString(),r={...e,timestamp:s,userAgent:navigator?.userAgent,url:window.location?.href};return this.metrics.errors.push(r),this.metrics.errors.length>100&&this.metrics.errors.shift(),i.error("Error occurred",r),r}cacheHit(e){return this.metrics.cache.hits++,i.debug("Cache hit",{endpoint:e}),this.metrics.cache.hits}cacheMiss(e){return this.metrics.cache.misses++,i.debug("Cache miss",{endpoint:e}),this.metrics.cache.misses}cacheStale(e){return this.metrics.cache.stale++,i.debug("Cache stale",{endpoint:e}),this.metrics.cache.stale}cacheError(e){return this.metrics.cache.errors++,this.trackError({type:"cache_error",message:e?.message||"Cache error",stack:e?.stack}),this.metrics.cache.errors}cacheSet(e){return this.metrics.cache.sets++,i.debug("Cache set",{key:e}),this.metrics.cache.sets}cacheDelete(e){return this.metrics.cache.deletes++,i.debug("Cache delete",{key:e}),this.metrics.cache.deletes}cacheInvalidate(e){return this.metrics.cache.invalidations++,i.debug("Cache invalidate",{pattern:e}),this.metrics.cache.invalidations}loginSuccess(){return this.metrics.auth.login.success++,this.metrics.auth.login.success}loginError(){return this.metrics.auth.login.errors++,this.metrics.auth.login.errors}sessionCheck(){return this.metrics.auth.sessionChecks++,this.metrics.auth.sessionChecks}permissionCheck(){return this.metrics.auth.permissionChecks++,this.metrics.auth.permissionChecks}async logMetrics(){try{if(!this.initialized)return;const e=new Date().toISOString(),s={...this.metrics,timestamp:e,pageUrl:window.location?.href,userAgent:navigator?.userAgent};if(q&&O){const{error:r}=await O.from("metrics").insert([s]);r?i.error("Error saving metrics to Supabase",{error:r}):i.info("Metrics logged successfully")}return this.resetCounters(),s}catch(e){return i.error("Error in metrics logging",{error:e}),null}}resetCounters(){this.metrics.cache.hits=0,this.metrics.cache.misses=0,this.metrics.cache.errors=0,this.metrics.cache.sets=0,this.metrics.cache.deletes=0,this.metrics.cache.stale=0,this.metrics.cache.invalidations=0,this.metrics.api.calls=0,this.metrics.api.errors=0,this.metrics.api.latency=[],this.metrics.auth.login.success=0,this.metrics.auth.login.errors=0,this.metrics.auth.sessionChecks=0,this.metrics.auth.permissionChecks=0}getMetrics(){return{...this.metrics}}}const f=new V;typeof window<"u"&&f.init();const W=typeof window<"u",Y="https://wapbwaimkurbuihatmix.supabase.co/functions/v1/redis-cache";class N{constructor(){this.cache=new Map,this.timeouts=new Map}async get(e,s=!0){const r=this.cache.get(e);if(!r)return null;const{data:a,expiresAt:o}=r;return o&&Date.now()>o?(this.cache.delete(e),null):s&&typeof a=="string"?JSON.parse(a):a}async set(e,s,r=300){const a=typeof s=="string"?s:JSON.stringify(s),o=r?Date.now()+r*1e3:null;if(this.cache.set(e,{data:a,expiresAt:o}),r){this.timeouts.has(e)&&clearTimeout(this.timeouts.get(e));const c=setTimeout(()=>{this.cache.delete(e),this.timeouts.delete(e)},r*1e3);this.timeouts.set(e,c)}return!0}async del(e){return this.timeouts.has(e)&&(clearTimeout(this.timeouts.get(e)),this.timeouts.delete(e)),this.cache.delete(e)}async deletePattern(e){const s=new RegExp(e.replace(/\*/g,".*"));let r=0;for(const a of this.cache.keys())s.test(a)&&(await this.del(a),r++);return r}async clear(){return this.cache.clear(),this.timeouts.forEach(clearTimeout),this.timeouts.clear(),!0}async healthCheck(){return{status:"healthy",message:"Using browser in-memory cache",timestamp:new Date().toISOString()}}async getStats(){return{connected:!0,mode:"browser",stats:{keys:this.cache.size,memoryUsage:0,uptime:0}}}}class X extends N{constructor(){super(),this.edgeFunctionUrl=Y,this.enabled=!!this.edgeFunctionUrl}async makeEdgeFunctionRequest(e,s,r=null,a=null){if(!this.enabled)throw new Error("Upstash Redis edge function not available");const o={action:e,key:s};r!==null&&(o.value=r),a!==null&&(o.ttl=a);const c=await fetch(this.edgeFunctionUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhcGJ3YWlta3VyYnVpaGF0bWl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODY3MjksImV4cCI6MjA3NDg2MjcyOX0.x-NQQ2TtRgaUjjBZCf6j49eWOW4XSqjTFKC_KB1L56A"},body:JSON.stringify(o)});if(!c.ok){const I=await c.json().catch(()=>({}));throw new Error(`Edge function error: ${c.status} ${I.message||"Unknown error"}`)}const w=await c.json();if(!w.success)throw new Error(`Redis operation failed: ${w.error}`);return w.result}async get(e,s=!0){try{if(this.enabled){const r=await this.makeEdgeFunctionRequest("get",e);if(r!==null)return await super.set(e,r),s?JSON.parse(r):r}return super.get(e,s)}catch(r){return i.warn("Upstash Redis get failed, using local cache:",r),super.get(e,s)}}async set(e,s,r=300){try{if(this.enabled){const a=typeof s=="string"?s:JSON.stringify(s);await this.makeEdgeFunctionRequest("set",e,a,r)}return await super.set(e,s,r),!0}catch(a){return i.warn("Upstash Redis set failed, using local cache only:",a),super.set(e,s,r)}}async del(e){try{this.enabled&&await this.makeEdgeFunctionRequest("del",e)}catch(s){i.warn("Upstash Redis del failed:",s)}return super.del(e)}async deletePattern(e){try{this.enabled&&await this.makeEdgeFunctionRequest("keys",e)}catch(s){i.warn("Upstash Redis deletePattern failed:",s)}return super.deletePattern(e)}async clear(){try{this.enabled&&await this.makeEdgeFunctionRequest("flush")}catch(e){i.warn("Upstash Redis clear failed:",e)}return super.clear()}async healthCheck(){try{if(this.enabled)return await this.makeEdgeFunctionRequest("ping"),{status:"healthy",message:"Upstash Redis edge function is responding",mode:"upstash-edge",timestamp:new Date().toISOString()}}catch(e){i.warn("Upstash Redis health check failed:",e)}return super.healthCheck()}}let A;W?A=new X:A=new N;const T=A,H={},Z=60*1e3,K=3,Q=1e3,D=(H?.VITE_REDIS_ENABLED||"").toString().toLowerCase()==="true",M={data:null,loading:!0,error:null,stale:!1,lastUpdated:null,retryCount:0};function ee(t,e){switch(e.type){case"SET_LOADING":return{...t,loading:e.payload};case"SET_DATA":return{...t,data:e.payload.data,loading:!1,error:null,stale:e.payload.stale||!1,lastUpdated:e.payload.lastUpdated||new Date,retryCount:0};case"SET_ERROR":return{...t,error:e.payload,loading:!1,retryCount:t.retryCount+1};case"SET_STALE":return{...t,stale:e.payload};case"RESET":return M;default:return t}}const se=(t,e,s={})=>{const{ttl:r=300,dependencies:a=[],enabled:o=!0,staleTime:c=Z,skipInitialFetch:w=!1,onSuccess:I,onError:v}=s,[u,E]=g.useReducer(ee,M),y=g.useRef(!0),C=g.useRef(null),_=g.useRef(!1),n=typeof t=="function"?t():t;g.useEffect(()=>()=>{y.current=!1,C.current?.abort()},[]);const R=g.useCallback(async(m=!1)=>{if(!(!n&&!m||!o)&&!_.current){_.current=!0,C.current=new AbortController;try{if(!m&&D){let d=null;try{d=await T.get(n)}catch(b){i.warn("Redis GET failed, continuing without cache",{key:n,error:b.message})}if(d){f.cacheHit();const b=!d.timestamp||Date.now()-new Date(d.timestamp).getTime()>c;if(y.current&&(E({type:"SET_DATA",payload:{data:d.data,stale:b,lastUpdated:d.timestamp?new Date(d.timestamp):new Date}}),E({type:"SET_LOADING",payload:!1}),!m&&!b))return d.data}else f.cacheMiss()}y.current&&E({type:"SET_LOADING",payload:!0});const l=performance.now(),h=await e(C.current.signal),k=performance.now();if(f.apiCall(k-l),!h)throw new Error("No response from server");const L={data:h,timestamp:new Date().toISOString(),metadata:{ttl:r,staleTime:c}};if(D)try{await T.set(n,L,r)}catch(d){i.warn("Redis SET failed, skipping cache write",{key:n,error:d.message})}return y.current&&(E({type:"SET_DATA",payload:{data:h,stale:!1,lastUpdated:new Date(L.timestamp)}}),I?.(h)),h}catch(l){if(l.name==="AbortError")return;if(f.apiError(),i.error("Error in useRedisCache",{key:n,error:l.message,stack:l.stack}),y.current)if(E({type:"SET_ERROR",payload:l}),u.retryCount<K){const h=Q*Math.pow(2,u.retryCount);setTimeout(()=>{y.current&&R(!0)},h)}else v?.(l);throw l}finally{_.current=!1,C.current=null}}},[n,e,r,c,o,u.retryCount,I,v]);g.useEffect(()=>{if(!w)return R().catch(()=>{}),()=>C.current?.abort()},[n,w,R,...a]);const F=g.useCallback(async()=>{if(n){try{D&&await T.del(n),f.cacheDelete?.()}catch(m){i.warn("Redis DEL failed during invalidate",{key:n,error:m.message})}return R(!0)}},[n,R]),x=g.useCallback(m=>{n&&E(l=>{const h=typeof m=="function"?m(l.data):m,k={data:h,timestamp:new Date().toISOString(),metadata:{ttl:r,staleTime:c}};return D&&(async()=>{try{await T.set(n,k,r),f.cacheSet?.()}catch(L){i.warn("Redis SET failed during updateCache",{key:n,error:L.message})}})(),{...l,data:h,lastUpdated:new Date}})},[n,r,c]);return{data:u.data,error:u.error,loading:u.loading,stale:u.stale,lastUpdated:u.lastUpdated,refetch:()=>R(!0),invalidate:F,updateCache:x,isStale:u.stale,retryCount:u.retryCount,cacheKey:n}};export{se as u};
