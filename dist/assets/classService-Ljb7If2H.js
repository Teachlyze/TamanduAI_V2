import{s as c,l as o}from"./main-BtydHokz.js";const q=async s=>{try{const{data:e,error:a}=await c.functions.invoke("process-notifications",{body:{notifications:s}});if(a)throw o.error("Erro na Edge Function process-notifications:",a),a;return e}catch(e){throw o.error("Erro ao processar notifica√ß√µes em lote:",e),e}},j=async(s,e)=>{try{const{data:a,error:t}=await c.from("notifications").insert({user_id:s,type:e.type,title:e.title,message:e.message,data:e.data||{},read:!1,created_at:new Date().toISOString()}).select().single();if(t)throw o.error("Erro ao criar notifica√ß√£o:",t),t;return a}catch(a){throw o.error("Erro ao criar notifica√ß√£o:",a),a}};class w{static NotificationType=Object.freeze({EVENT:"event",ASSIGNMENT:"assignment",ANNOUNCEMENT:"announcement",SYSTEM:"system",FEEDBACK:"feedback",REMINDER:"reminder"});static NotificationPriority=Object.freeze({LOW:"low",NORMAL:"normal",HIGH:"high",URGENT:"urgent"});static NotificationCategory=Object.freeze({SYSTEM_UPDATE:"system_update",ACCOUNT:"account",COURSE:"course",ASSIGNMENT:"assignment",EXAM:"exam",GRADE:"grade",MENTION:"mention",COMMENT:"comment",MESSAGE:"message",ANNOUNCEMENT:"announcement",REMINDER:"reminder",ALERT:"alert",PLAGIARISM_ALERT:"plagiarism_alert",AI_DETECTION:"ai_detection"});static async sendNotificationsBatch(e){try{return await q(e)}catch(a){throw o.error("Error sending notifications in batch:",a),a}}static NotificationStatus=Object.freeze({UNREAD:"unread",READ:"read",ARCHIVED:"archived"});static sleep=e=>new Promise(a=>setTimeout(a,e));static withRetry=async(e,a=3)=>{for(let t=0;t<a;t++)try{return await e()}catch(r){if(t===a-1)throw r;await w.sleep(1e3*(t+1))}};static async getNotifications({unreadOnly:e=!1,limit:a=50,offset:t=0,type:r=null,category:i=null}={}){const{data:n,error:d}=await c.auth.getUser();if(d)throw d;const f=n.user?.id;if(!f)throw new Error("No user is currently signed in");let l=c.from("notifications").select("*").eq("user_id",f).order("created_at",{ascending:!1}).range(t,t+a-1);e&&(l=l.eq("is_read",!1)),r&&(l=l.eq("type",r)),i&&(l=l.eq("category",i));const{data:m,error:h}=await l;if(h)throw h;return m||[]}static async markAsRead(e,{userId:a}={}){const t=Array.isArray(e)?e:[e];try{let r=c.from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).in("id",t);a&&(r=r.eq("user_id",a));const{data:i,error:n}=await r;if(n)throw n;return{success:!0,message:"Notifications marked as read successfully",affected:i?.length||0}}catch(r){return o.error("Error marking notifications as read:",r),{success:!1,message:r.message,affected:0}}}static async markAllAsRead(){const{error:e}=await c.from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("is_read",!1);if(e)throw e;return!0}static async deleteNotification(e,{userId:a}={}){const t=Array.isArray(e)?e:[e];try{let r=c.from("notifications").delete().in("id",t);a&&(r=r.eq("user_id",a));const{data:i,error:n}=await r;if(n)throw n;return{success:!0,message:"Notifications deleted successfully",deleted:i?.length||0}}catch(r){return o.error("Error deleting notifications:",r),{success:!1,message:r.message,deleted:0}}}static async sendNotification({title:e,message:a,type:t,category:r,priority:i=w.NotificationPriority.NORMAL,referenceId:n,referenceType:d,actionUrl:f,metadata:l={}},m=null){if(!Object.values(w.NotificationType).includes(t))throw new Error(`Invalid notification type: ${t}`);if(i&&!Object.values(w.NotificationPriority).includes(i))throw new Error(`Invalid priority: ${i}`);if(!m){const{data:y,error:b}=await c.auth.getUser();if(b)throw b;if(m=y.user?.id,!m)throw new Error("No user is currently signed in")}const h={type:t,title:e,message:a,data:{category:r||null,priority:i,referenceId:n||null,referenceType:d||null,actionUrl:f||null,...l}};try{return await j(m,h)}catch(y){o.error("Error using Edge Function, falling back to direct insert:",y);const{data:b,error:A}=await c.from("notifications").insert({...h,user_id:m,created_at:new Date().toISOString()}).select().single();if(A)throw A;return b}}static async getUnreadCount(){const{data:e,error:a}=await c.auth.getUser();if(a)throw a;const t=e.user?.id;if(!t)return 0;const{data:r,error:i}=await c.from("notifications").select("id").eq("user_id",t).eq("is_read",!1).range(0,999);if(i)throw i;return r?.length||0}static async subscribeToNotifications(e){const{data:{user:a}}=await c.auth.getUser(),t=a?.id;if(!t)return{unsubscribe:()=>{}};const r=c.channel("notifications").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${t}`},i=>{typeof e=="function"&&e(i.new)}).subscribe();return{unsubscribe:()=>{try{c.removeChannel(r)}catch{}}}}async subscribeToNotifications(e){return await w.subscribeToNotifications(e)}async getNotifications(e={}){return{data:await w.getNotifications(e)}}async markAsRead(e,a={}){return await w.markAsRead(e,a)}async deleteNotification(e,a={}){return await w.deleteNotification(e,a)}async markAllAsRead(){return await w.markAllAsRead()}async getUnreadCount(){return await w.getUnreadCount()}async sendNotification(e,a=null){return await w.sendNotification(e,a)}static async sendCorrectionNotification({submissionId:e,studentId:a,activityTitle:t,grade:r,maxScore:i}){try{const f=await fetch("https://wapbwaimkurbuihatmix.supabase.co/functions/v1/send-correction-notification",{method:"POST",headers:{Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhcGJ3YWlta3VyYnVpaGF0bWl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODY3MjksImV4cCI6MjA3NDg2MjcyOX0.x-NQQ2TtRgaUjjBZCf6j49eWOW4XSqjTFKC_KB1L56A","Content-Type":"application/json"},body:JSON.stringify({submissionId:e,studentId:a,activityTitle:t,grade:r,maxScore:i})});if(!f.ok){const m=await f.json();throw new Error(m.error||"Erro ao enviar notifica√ß√£o")}return{data:await f.json(),error:null}}catch(n){o.error("Erro ao enviar notifica√ß√£o de corre√ß√£o:",n);try{return await w.sendNotification({title:"Atividade Corrigida",message:`Sua atividade "${t}" foi corrigida. Nota: ${r}/${i}`,type:w.NotificationType.FEEDBACK,category:w.NotificationCategory.GRADE,priority:w.NotificationPriority.HIGH,referenceId:e,referenceType:"submission",metadata:{grade:r,maxScore:i,activityTitle:t}},a),{data:{notificationSent:!0,emailSent:!1},error:null}}catch(d){return{data:null,error:d}}}}}const L=new w,M={async sendEmail({to:s,subject:e,html:a,text:t,from:r}){if(!s||!e||!a&&!t)return{success:!1,error:"Missing required fields: to, subject, and html or text"};const{data:i,error:n}=await c.functions.invoke("send-email",{body:{to:s,subject:e,html:a,text:t,from:r}});return n?(o.error("EmailService.sendEmail error:",n),{success:!1,error:n.message||"invoke failed"}):{success:!!i?.success,emailId:i?.emailId,error:i?.error}},render(s="",e={}){return String(s).replace(/{{\s*([\w.]+)\s*}}/g,(a,t)=>t.split(".").reduce((i,n)=>i&&i[n]!==void 0?i[n]:"",e)??"")}};class B{static async send(e,a={}){const{to:t,variables:r={},language:i="pt",from:n,replyTo:d,attachments:f,tracking:l=!1}=a;if(!t)return{success:!1,error:"Recipient email is required"};if(!e)return{success:!1,error:"Template ID is required"};try{const{data:m,error:h}=await c.functions.invoke("send-email-v2",{body:{templateId:e,to:t,variables:r,language:i,from:n,replyTo:d,attachments:f,tracking:l}});return h?(o.error("EmailTemplateService.send error:",h),{success:!1,error:h.message||"Failed to send email"}):{success:m?.success||!1,emailId:m?.emailId,template:m?.template,error:m?.error}}catch(m){return o.error("EmailTemplateService.send exception:",m),{success:!1,error:m.message||"Unexpected error"}}}static async sendWelcome({to:e,userName:a,confirmationUrl:t,language:r="pt"}){return this.send("welcome",{to:e,variables:{userName:a,confirmationUrl:t},language:r})}static async sendLoginNewDevice({to:e,device:a,time:t,location:r,language:i="pt"}){return this.send("login-new-device",{to:e,variables:{device:a,time:t,location:r},language:i})}static async sendPasswordRecovery({to:e,userName:a,resetUrl:t,language:r="pt"}){return this.send("password-recovery",{to:e,variables:{userName:a,resetUrl:t},language:r})}static async sendPasswordChanged({to:e,time:a,language:t="pt"}){return this.send("password-changed",{to:e,variables:{time:a},language:t})}static async sendAccountConfirmed({to:e,userName:a,dashboardUrl:t,language:r="pt"}){return this.send("account-confirmed",{to:e,variables:{userName:a,dashboardUrl:t},language:r})}static async sendClassInvite({to:e,className:a,teacherName:t,acceptUrl:r,language:i="pt"}){return this.send("class-invite",{to:e,variables:{className:a,teacherName:t,acceptUrl:r},language:i})}static async sendClassInviteAccepted({to:e,studentName:a,className:t,time:r,language:i="pt"}){return this.send("class-invite-accepted",{to:e,variables:{studentName:a,className:t,time:r},language:i})}static async sendStudentAdded({to:e,studentName:a,className:t,teacherName:r,classUrl:i,language:n="pt"}){return this.send("student-added",{to:e,variables:{studentName:a,className:t,teacherName:r,classUrl:i},language:n})}static async sendStudentRemoved({to:e,className:a,time:t,language:r="pt"}){return this.send("student-removed",{to:e,variables:{className:a,time:t},language:r})}static async sendClassCreated({to:e,className:a,classCode:t,classUrl:r,language:i="pt"}){return this.send("class-created",{to:e,variables:{className:a,classCode:t,classUrl:r},language:i})}static async sendNewActivity({to:e,studentName:a,className:t,activityName:r,deadline:i,points:n,activityUrl:d,language:f="pt"}){return this.send("new-activity",{to:e,variables:{studentName:a,className:t,activityName:r,deadline:i,points:n,activityUrl:d},language:f})}static async sendDeadlineWarning({to:e,activityName:a,deadline:t,timeLeft:r,activityUrl:i,language:n="pt"}){return this.send("deadline-warning",{to:e,variables:{activityName:a,deadline:t,timeLeft:r,activityUrl:i},language:n})}static async sendActivityCorrected({to:e,activityName:a,grade:t,maxGrade:r,viewUrl:i,language:n="pt"}){return this.send("activity-corrected",{to:e,variables:{activityName:a,grade:t,maxGrade:r,viewUrl:i},language:n})}static async sendPlagiarismAlert({to:e,studentName:a,activityName:t,percentage:r,severity:i,reviewUrl:n,language:d="pt"}){return this.send("plagiarism-alert",{to:e,variables:{studentName:a,activityName:t,percentage:r,severity:i,reviewUrl:n},language:d})}static async sendMonthlyReport({to:e,userName:a,monthYear:t,activitiesCount:r,averageGrade:i,completionRate:n,reportUrl:d,language:f="pt"}){return this.send("monthly-report",{to:e,variables:{userName:a,monthYear:t,activitiesCount:r,averageGrade:i,completionRate:n,reportUrl:d},language:f})}static async preview(e,a={},t="pt"){return{templateId:e,variables:a,language:t,note:"Preview functionality - implement preview endpoint if needed"}}static getAvailableTemplates(){return[{id:"welcome",category:"auth",name:"Welcome Email"},{id:"login-new-device",category:"auth",name:"New Device Login"},{id:"password-recovery",category:"auth",name:"Password Recovery"},{id:"password-changed",category:"auth",name:"Password Changed"},{id:"account-confirmed",category:"auth",name:"Account Confirmed"},{id:"class-invite",category:"classes",name:"Class Invitation"},{id:"class-invite-accepted",category:"classes",name:"Invite Accepted"},{id:"student-added",category:"classes",name:"Student Added"},{id:"student-removed",category:"classes",name:"Student Removed"},{id:"class-created",category:"classes",name:"Class Created"},{id:"new-activity",category:"activities",name:"New Activity"},{id:"deadline-warning",category:"activities",name:"Deadline Warning"},{id:"activity-corrected",category:"activities",name:"Activity Corrected"},{id:"plagiarism-alert",category:"system",name:"Plagiarism Alert"},{id:"monthly-report",category:"system",name:"Monthly Report"}]}static async getLogs(e={}){const{limit:a=50,offset:t=0,templateId:r,status:i}=e;let n=c.from("email_logs").select("*").order("sent_at",{ascending:!1}).range(t,t+a-1);r&&(n=n.eq("template_id",r)),i&&(n=n.eq("status",i));const{data:d,error:f}=await n;return f?(o.error("Failed to fetch email logs:",f),{success:!1,error:f.message}):{success:!0,data:d}}static async getStatistics(e="30days"){try{const{data:a,error:t}=await c.rpc("get_email_statistics",{period_days:e==="7days"?7:e==="30days"?30:90});if(t)throw t;return{success:!0,data:a}}catch(a){return o.error("Failed to fetch email statistics:",a),{success:!1,error:a.message}}}}const p={AUTHENTICATION:"authentication",ACTIVITY:"activity",CORRECTION:"correction",PLAGIARISM:"plagiarism",SYSTEM:"system",CHATBOT:"chatbot",ANALYTICS:"analytics",GAMIFICATION:"gamification",FEEDBACK:"feedback",MEETING:"meeting",LIVE_CLASS:"live_class"},g={CRITICAL:"critical",HIGH:"high",MEDIUM:"medium",LOW:"low"},u={EMAIL:"email",PUSH:"push",BOTH:"both"},P={critical:{channels:["email","push"],retries:3,delay:0},high:{channels:["email","push"],retries:2,delay:0},medium:{channels:["push"],retries:1,delay:300},low:{channels:["push"],retries:0,delay:1800}};function G(s,e){return e===u.BOTH?["email","push"]:e===u.EMAIL?["email"]:e===u.PUSH?["push"]:(P[String(s||"").toLowerCase()]||P.medium).channels}const k={accountCreated:{id:"accountCreated",type:p.AUTHENTICATION,channel:u.EMAIL,priority:g.CRITICAL,title:"Conta criada com sucesso! üéâ",message:"Bem-vindo(a) ao TamanduAI! Confirme seu email para come√ßar.",emailSubject:"Bem-vindo(a) ao TamanduAI! Confirme seu email",emailHtml:`
      <h2>Bem-vindo(a) ao TamanduAI! üéì</h2>
      <p>Ol√° <strong>{{userName}}</strong>, sua conta foi criada com sucesso.</p>
      <p>Clique no bot√£o para confirmar seu email:</p>
      <p><a href="{{confirmationUrl}}">Confirmar Email</a></p>
      <small>Este link expira em 24 horas.</small>
    `,variables:["userName","confirmationUrl"]},loginNewDevice:{id:"loginNewDevice",type:p.SYSTEM,channel:u.EMAIL,priority:g.MEDIUM,title:"Novo acesso detectado",message:"Login realizado em {device} √†s {time}. Foi voc√™?",emailSubject:"Novo acesso detectado",emailHtml:"<h2>Novo acesso detectado</h2><p>Dispositivo: {{device}} √†s {{time}}</p>",variables:["device","time"]},passwordRecoveryRequested:{id:"passwordRecoveryRequested",type:p.AUTHENTICATION,channel:u.EMAIL,priority:g.CRITICAL,title:"Recupera√ß√£o de senha solicitada",message:"Use o c√≥digo enviado para redefinir sua senha.",emailSubject:"Recupera√ß√£o de senha",emailHtml:"<h2>Recupera√ß√£o de senha</h2><p>Ol√° {{userName}}, utilize o c√≥digo enviado para redefinir sua senha.</p>",variables:["userName"]},passwordChanged:{id:"passwordChanged",type:p.AUTHENTICATION,channel:u.BOTH,priority:g.HIGH,title:"Senha alterada",message:"Sua senha foi alterada com sucesso √†s {time}.",emailSubject:"Senha alterada com sucesso",emailHtml:"<h2>Senha alterada</h2><p>Sua senha foi alterada √†s {{time}}</p>",variables:["time"]},profileCompleted:{id:"profileCompleted",type:p.SYSTEM,channel:u.PUSH,priority:g.MEDIUM,title:"Perfil completo!",message:"Agora voc√™ pode explorar todas as funcionalidades.",variables:[]},classInviteSent:{id:"classInviteSent",type:p.SYSTEM,channel:u.EMAIL,priority:g.HIGH,title:"Convite para turma",message:"Voc√™ foi convidado(a) para a turma {{className}}",emailSubject:"Convite para a turma {{className}}",emailHtml:'<h2>Convite para turma</h2><p>Voc√™ foi convidado(a) para a turma <strong>{{className}}</strong>.</p><p>Clique para aceitar: <a href="{{acceptUrl}}">Aceitar convite</a></p>',variables:["className","acceptUrl"]},classInviteAccepted:{id:"classInviteAccepted",type:p.SYSTEM,channel:u.PUSH,priority:g.MEDIUM,title:"Convite aceito",message:"{{studentName}} entrou na turma {{className}}",variables:["studentName","className"]},studentAddedToClass:{id:"studentAddedToClass",type:p.SYSTEM,channel:u.PUSH,priority:g.MEDIUM,title:"Aluno adicionado",message:"{{studentName}} foi adicionado na turma {{className}}",variables:["studentName","className"]},studentRemovedFromClass:{id:"studentRemovedFromClass",type:p.SYSTEM,channel:u.BOTH,priority:g.HIGH,title:"Voc√™ foi removido da turma",message:"Turma: {{className}}",emailSubject:"Remo√ß√£o da turma {{className}}",emailHtml:"<h2>Remo√ß√£o da turma</h2><p>Voc√™ foi removido da turma {{className}}</p>",variables:["className"]},classCreated:{id:"classCreated",type:p.SYSTEM,channel:u.PUSH,priority:g.LOW,title:"Nova turma criada",message:"{{className}} foi criada com sucesso",variables:["className"]},accountConfirmed:{id:"accountConfirmed",type:p.AUTHENTICATION,channel:u.BOTH,priority:g.HIGH,title:"Email confirmado! ‚úÖ",message:"Sua conta est√° ativa. Complete seu perfil para come√ßar.",emailSubject:"Sua conta foi confirmada",emailHtml:`
      <h2>Conta confirmada</h2>
      <p>Ol√° <strong>{{userName}}</strong>, sua conta foi confirmada com sucesso.</p>
    `,variables:["userName"]},newActivity:{id:"newActivity",type:p.ACTIVITY,channel:u.BOTH,priority:g.HIGH,title:"Nova atividade: {{activityName}}",message:"Prazo: {{deadline}} ‚Ä¢ Pontua√ß√£o: {{points}} pts",emailSubject:"Nova atividade em {{className}}: {{activityName}}",emailHtml:`
      <h2>üìù Nova Atividade Dispon√≠vel</h2>
      <p>Ol√° <strong>{{studentName}}</strong>,</p>
      <p>Uma nova atividade foi publicada na turma <strong>{{className}}</strong>:</p>
      <p><strong>{{activityName}}</strong></p>
      <p>Prazo: {{deadline}} | Pontos: {{points}}</p>
      <p><a href="{{activityUrl}}">Ver Atividade</a></p>
    `,variables:["studentName","className","activityName","deadline","points","activityUrl"]},deadlineWarning24h:{id:"deadlineWarning24h",type:p.ACTIVITY,channel:u.BOTH,priority:g.CRITICAL,title:"‚è∞ Prazo em 24 horas!",message:"{{activityName}} vence amanh√£ √†s {{time}}",emailSubject:"Lembrete: {{activityName}} vence em 24 horas",emailHtml:`
      <h2>‚è∞ Prazo em 24 horas</h2>
      <p>Atividade: {{activityName}}</p>
      <p>Vence em: {{deadline}}</p>
      <p><a href="{{activityUrl}}">Entregar agora</a></p>
    `,variables:["activityName","deadline","time","activityUrl"]},activityCorrected:{id:"activityCorrected",type:p.CORRECTION,channel:u.BOTH,priority:g.HIGH,title:"Atividade corrigida! üéâ",message:"{{activityName}} ‚Ä¢ Nota: {{grade}}/{{maxGrade}}",emailSubject:"Corre√ß√£o dispon√≠vel: {{activityName}}",emailHtml:`
      <h2>‚úÖ Atividade Corrigida</h2>
      <p>{{activityName}} ‚Äî Nota: {{grade}}/{{maxGrade}}</p>
      <p><a href="{{viewUrl}}">Ver detalhes</a></p>
    `,variables:["activityName","grade","maxGrade","viewUrl"]},plagiarismDetected:{id:"plagiarismDetected",type:p.PLAGIARISM,channel:u.EMAIL,priority:g.CRITICAL,title:"üö® Pl√°gio detectado",message:"{{studentName}} ‚Ä¢ {{percentage}}% similaridade ‚Ä¢ {{activityName}}",emailSubject:"Alerta de Pl√°gio: {{activityName}}",emailHtml:`
      <h2>üö® Alerta de Pl√°gio</h2>
      <p>Aluno: {{studentName}}</p>
      <p>Atividade: {{activityName}}</p>
      <p>Similaridade: {{percentage}}%</p>
      <p><a href="{{reviewUrl}}">Revisar submiss√£o</a></p>
    `,variables:["studentName","activityName","percentage","reviewUrl"]},analysisStarted:{id:"analysisStarted",type:p.PLAGIARISM,channel:u.PUSH,priority:g.LOW,title:"An√°lise anti-pl√°gio iniciada",message:"Verificando {{activityName}}..."},falsePositiveMarked:{id:"falsePositiveMarked",type:p.PLAGIARISM,channel:u.PUSH,priority:g.LOW,title:"Falso positivo marcado",message:"An√°lise de pl√°gio atualizada para {{activityName}}"},chatbotTrainingComplete:{id:"chatbotTrainingComplete",type:p.CHATBOT,channel:u.PUSH,priority:g.MEDIUM,title:"Chatbot treinado com sucesso!",message:"Base atualizada com {{filesCount}} arquivos",variables:["filesCount"]},chatbotTrainingError:{id:"chatbotTrainingError",type:p.CHATBOT,channel:u.PUSH,priority:g.HIGH,title:"Erro no treinamento",message:"Falha ao processar {{fileName}}",variables:["fileName"]},newMaterialProcessed:{id:"newMaterialProcessed",type:p.CHATBOT,channel:u.PUSH,priority:g.LOW,title:"Material processado",message:"{{fileName}} adicionado √† base",variables:["fileName"]},outOfScopeInteraction:{id:"outOfScopeInteraction",type:p.CHATBOT,channel:u.PUSH,priority:g.LOW,title:"Pergunta fora do escopo",message:"Aluno perguntou sobre: {{topic}}",variables:["topic"]},monthlyReportGenerated:{id:"monthlyReportGenerated",type:p.ANALYTICS,channel:u.EMAIL,priority:g.MEDIUM,title:"Relat√≥rio mensal gerado",message:"Seu relat√≥rio de {{monthYear}} est√° pronto",emailSubject:"Relat√≥rio mensal - {{monthYear}}",emailHtml:"<h2>Relat√≥rio mensal</h2><p>Seu relat√≥rio de {{monthYear}} est√° pronto.</p>",variables:["monthYear"]},performanceGoalAchieved:{id:"performanceGoalAchieved",type:p.ANALYTICS,channel:u.BOTH,priority:g.MEDIUM,title:"Meta de desempenho atingida",message:"Parab√©ns! Voc√™ atingiu sua meta",emailSubject:"Meta de desempenho atingida",emailHtml:"<h2>Meta de desempenho atingida</h2><p>Parab√©ns!</p>",variables:[]},lowPerformanceDetected:{id:"lowPerformanceDetected",type:p.ANALYTICS,channel:u.EMAIL,priority:g.HIGH,title:"Baixo desempenho detectado",message:"Identificamos baixo desempenho em {{subject}}",emailSubject:"Baixo desempenho detectado",emailHtml:"<h2>Baixo desempenho detectado</h2><p>√Årea: {{subject}}</p>",variables:["subject"]},classReportAvailable:{id:"classReportAvailable",type:p.ANALYTICS,channel:u.PUSH,priority:g.LOW,title:"Relat√≥rio de turma dispon√≠vel",message:"O relat√≥rio da turma {{className}} est√° dispon√≠vel",variables:["className"]},xpEarned:{id:"xpEarned",type:p.GAMIFICATION,channel:u.PUSH,priority:g.LOW,title:"üåü +{{xp}} XP ganho!",message:"{{reason}} ‚Ä¢ Total: {{totalXP}} XP",variables:["xp","reason","totalXP"]},badgeEarned:{id:"badgeEarned",type:p.GAMIFICATION,channel:u.BOTH,priority:g.MEDIUM,title:"üèÜ Nova badge desbloqueada!",message:"{{badgeName}} - {{badgeDescription}}",emailSubject:"Voc√™ desbloqueou: {{badgeName}}",emailHtml:`
      <h2>üèÜ Nova Badge Desbloqueada!</h2>
      <p><strong>{{badgeName}}</strong></p>
      <p>{{badgeDescription}}</p>
      <p><a href="{{profileUrl}}">Ver seu perfil</a></p>
    `,variables:["badgeName","badgeDescription","profileUrl"]},levelUp:{id:"levelUp",type:p.GAMIFICATION,channel:u.BOTH,priority:g.HIGH,title:"üéâ Level Up! N√≠vel {{level}}",message:"Parab√©ns! Voc√™ alcan√ßou o n√≠vel {{level}}!",emailSubject:"Parab√©ns! Voc√™ subiu para o n√≠vel {{level}}",emailHtml:`
      <h2>üéâ Level Up!</h2>
      <p>Parab√©ns! Voc√™ alcan√ßou o <strong>n√≠vel {{level}}</strong>!</p>
      <p>Continue assim e desbloqueie novas conquistas.</p>
    `,variables:["level"]},feedbackReceived:{id:"feedbackReceived",type:p.FEEDBACK,channel:u.BOTH,priority:g.HIGH,title:"üí¨ Novo feedback do professor",message:"{{teacherName}} comentou em {{activityName}}",emailSubject:"Feedback em {{activityName}}",emailHtml:`
      <h2>üí¨ Novo Feedback</h2>
      <p>Professor(a) <strong>{{teacherName}}</strong> deixou um coment√°rio em <strong>{{activityName}}</strong></p>
      <p><a href="{{viewUrl}}">Ver feedback</a></p>
    `,variables:["teacherName","activityName","viewUrl"]},meetingScheduled:{id:"meetingScheduled",type:p.MEETING,channel:u.BOTH,priority:g.MEDIUM,title:"üìÖ Reuni√£o agendada",message:"{{meetingTitle}} em {{date}} √†s {{time}}",emailSubject:"Reuni√£o agendada: {{meetingTitle}}",emailHtml:`
      <h2>üìÖ Reuni√£o Agendada</h2>
      <p><strong>{{meetingTitle}}</strong></p>
      <p>Data: {{date}} √†s {{time}}</p>
      <p><a href="{{meetingUrl}}">Adicionar ao calend√°rio</a></p>
    `,variables:["meetingTitle","date","time","meetingUrl"]},meetingReminder1h:{id:"meetingReminder1h",type:p.MEETING,channel:u.BOTH,priority:g.HIGH,title:"‚è∞ Reuni√£o em 1 hora!",message:"{{meetingTitle}} √†s {{time}}",emailSubject:"Lembrete: {{meetingTitle}} em 1 hora",emailHtml:`
      <h2>‚è∞ Reuni√£o em 1 hora</h2>
      <p><strong>{{meetingTitle}}</strong> √†s {{time}}</p>
      <p><a href="{{meetingUrl}}">Entrar na reuni√£o</a></p>
    `,variables:["meetingTitle","time","meetingUrl"]},meetingReminder5min:{id:"meetingReminder5min",type:p.MEETING,channel:u.PUSH,priority:g.CRITICAL,title:"‚è∞ Reuni√£o em 5 minutos!",message:"{{meetingTitle}} - Prepare-se!",variables:["meetingTitle","meetingUrl"]},liveClassStarting:{id:"liveClassStarting",type:p.LIVE_CLASS,channel:u.BOTH,priority:g.CRITICAL,title:"üî¥ Aula ao vivo come√ßando AGORA!",message:"{{className}} - Clique para entrar",emailSubject:"Aula ao vivo: {{className}}",emailHtml:`
      <h2>üî¥ Aula Ao Vivo</h2>
      <p><strong>{{className}}</strong> est√° come√ßando agora!</p>
      <p><a href="{{liveClassUrl}}">Entrar na aula</a></p>
    `,variables:["className","liveClassUrl"]},liveClassReminder15min:{id:"liveClassReminder15min",type:p.LIVE_CLASS,channel:u.BOTH,priority:g.HIGH,title:"‚è∞ Aula ao vivo em 15 minutos",message:"{{className}} - Prepare seus materiais!",emailSubject:"Aula ao vivo em 15 minutos: {{className}}",emailHtml:`
      <h2>‚è∞ Aula ao vivo em 15 minutos</h2>
      <p><strong>{{className}}</strong></p>
      <p>Prepare seus materiais e esteja pronto!</p>
      <p><a href="{{liveClassUrl}}">Link da aula</a></p>
    `,variables:["className","liveClassUrl"]},liveClassReminder5min:{id:"liveClassReminder5min",type:p.LIVE_CLASS,channel:u.PUSH,priority:g.HIGH,title:"‚è∞ Aula ao vivo em 5 minutos",message:"{{className}} - N√£o se atrase!",variables:["className"]}},I={async send(s,{userId:e,email:a,variables:t={},priorityOverride:r,channelOverride:i,metadata:n}={}){const d=k[s];if(!d)throw new Error(`Unknown notification template: ${s}`);const f=G(r||d.priority,i||d.channel),l=y=>M.render(y,t),m=[];if(f.includes("push")){const y=l(d.title||""),b=l(d.message||"");m.push(L.sendNotification({title:y,message:b,type:d.type,category:d.type,priority:(r||d.priority||"medium").toLowerCase(),metadata:n},e))}if(f.includes("email")){if(!a)throw new Error("Email recipient is required for email delivery");const b={accountCreated:"welcome",classInviteSent:"class-invite",classInviteAccepted:"class-invite-accepted",newActivity:"new-activity",deadlineWarning24h:"deadline-warning",activityCorrected:"activity-corrected",plagiarismDetected:"plagiarism-alert",monthlyReportGenerated:"monthly-report",passwordRecoveryRequested:"password-recovery",passwordChanged:"password-changed",accountConfirmed:"account-confirmed",loginNewDevice:"login-new-device",studentAddedToClass:"student-added",studentRemovedFromClass:"student-removed",classCreated:"class-created"}[s];if(b)m.push(B.send(b,{to:a,variables:t,language:t.language||"pt"}));else{const A=l(d.emailSubject||d.title||"Notifica√ß√£o"),S=d.emailHtml?l(d.emailHtml):void 0,_=S?void 0:l(d.message||"");m.push(M.sendEmail({to:a,subject:A,html:S,text:_}))}}return await Promise.allSettled(m)},async notifyNewActivity({userId:s,email:e,variables:a,metadata:t}){return this.send("newActivity",{userId:s,email:e,variables:a,metadata:t})},async notifyDeadline24h({userId:s,email:e,variables:a,metadata:t}){return this.send("deadlineWarning24h",{userId:s,email:e,variables:a,metadata:t})},async notifyActivityCorrected({userId:s,email:e,variables:a,metadata:t}){return this.send("activityCorrected",{userId:s,email:e,variables:a,metadata:t})},async notifyPlagiarismDetected({userId:s,email:e,variables:a,metadata:t}){return this.send("plagiarismDetected",{userId:s,email:e,variables:a,metadata:t})}},Y={async getClasses({teacherId:s,studentId:e,activeOnly:a=!0}={}){try{let t=c.from("classes").select(`
          *,
          members:class_members(*, user:profiles(*))
        `).order("name",{ascending:!0});s&&(t=t.eq("created_by",s)),a&&(t=t.eq("is_active",!0));const r=t,i=new Promise((f,l)=>setTimeout(()=>l(new Error("Query timeout")),5e3)),{data:n,error:d}=await Promise.race([r,i]);return d?(o.error("Error fetching classes:",d),[]):e?(n||[]).filter(f=>f.members?.some(l=>l.user_id===e&&l.role==="student")):n||[]}catch(t){return o.error("Error or timeout fetching classes:",t.message),[]}},async getClassById(s){try{const e=c.from("classes").select(`
          *,
          members:class_members(*, user:profiles(*))
        `).eq("id",s).single(),a=new Promise((i,n)=>setTimeout(()=>n(new Error("Query timeout")),5e3)),{data:t,error:r}=await Promise.race([e,a]);return r?(o.error(`Error fetching class ${s}:`,r),null):t}catch(e){return o.error(`Error or timeout fetching class ${s}:`,e.message),null}},async createClass(s,e=[]){const{name:a,description:t,teacher_id:r,subject:i,course:n,period:d,grade_level:f,academic_year:l,color:m,student_capacity:h,school_id:y,is_school_managed:b,grading_system:A}=s;try{const v=c.from("profiles").select("id").eq("id",r).maybeSingle(),C=new Promise((T,H)=>setTimeout(()=>H(new Error("Profile check timeout")),3e3)),{data:N,error:O}=await Promise.race([v,C]);if(!N&&!O){o.debug("Profile not found for teacher, creating one...");const{error:T}=await c.from("profiles").insert([{id:r,role:"teacher",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]);if(T&&(o.error("Error creating teacher profile:",T),T.code!=="23505"))throw new Error(`Erro ao criar perfil do professor: ${T.message}`)}}catch(v){o.warn("Profile check timed out, continuing without profile verification:",v.message)}const S={name:a,description:t||null,created_by:r,subject:i||null,course:n||null,period:d||null,grade_level:f||null,academic_year:(()=>{const v=parseInt(l,10);return Number.isFinite(v)?v:new Date().getFullYear()})(),grading_system:A||"0-10",color:m||"#6366f1",student_capacity:typeof h=="number"?h:30,room_number:s.room_number||null,is_online:!!s.is_online,meeting_link:s.meeting_link||null,chatbot_enabled:!!s.chatbot_enabled,school_id:y||null,is_school_managed:!!b,is_active:!0};o.debug("Creating class with data:",S);const{data:_,error:E}=await c.from("classes").insert([S]).select().single();if(E)throw o.error("Error creating class:",E),o.error("Error details:",{code:E.code,message:E.message,details:E.details}),new Error(`Erro ao criar turma: ${E.message}. Detalhes: ${E.hint||E.details||"Nenhum detalhe adicional"}`);o.debug("Class created successfully:",_);try{await I.send("classCreated",{userId:r,variables:{className:a},channelOverride:"push",metadata:{classId:_.id}})}catch(v){o.warn("Falha ao notificar cria√ß√£o de turma:",v)}try{const{error:v}=await c.from("class_members").insert([{class_id:_.id,user_id:r,role:"teacher",joined_at:new Date().toISOString()}]);v&&v.code!=="23505"&&o.warn("Erro ao adicionar professor como membro:",v)}catch(v){o.warn("Falha ao adicionar professor como membro da turma:",v)}if(e&&e.length>0)try{await this.addStudentsToClass(_.id,e)}catch(v){o.warn("Falha ao adicionar alunos:",v)}try{const{error:v}=await c.from("chatbot_configurations").upsert({class_id:_.id,enabled:!0,keywords:[],themes:[],scope_restrictions:[],created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{onConflict:"class_id"});v?o.warn("Erro ao garantir configura√ß√£o do chatbot:",v):o.debug("Chatbot configuration ensured for class:",_.id)}catch(v){o.warn("Falha ao garantir chatbot para a turma:",v)}return this.getClassById(_.id)},async updateClass(s,e,a){const t={...e||{}};if(Object.prototype.hasOwnProperty.call(t,"academic_year")){const i=parseInt(t.academic_year,10);t.academic_year=Number.isFinite(i)?i:new Date().getFullYear()}const{error:r}=await c.from("classes").update({...t,updated_at:new Date().toISOString()}).eq("id",s);if(r)throw o.error(`Error updating class ${s}:`,r),r;if(Array.isArray(a)){const{data:i}=await c.from("class_members").select("user_id").eq("class_id",s).eq("role","student"),n=(i||[]).map(l=>l.user_id),d=a.filter(l=>!n.includes(l)),f=n.filter(l=>!a.includes(l));await Promise.all([this.addStudentsToClass(s,d),this.removeStudentsFromClass(s,f)])}return this.getClassById(s)},async deleteClass(s){const{error:e}=await c.from("classes").update({is_active:!1,updated_at:new Date().toISOString()}).eq("id",s);if(e)throw o.error(`Error deleting class ${s}:`,e),e;return!0},async addStudentsToClass(s,e){if(!e||e.length===0)return[];const{data:a,error:t}=await c.from("class_members").insert(e.map(r=>({class_id:s,user_id:r,role:"student",joined_at:new Date().toISOString()}))).select();if(t)throw o.error(`Error adding students to class ${s}:`,t),t;try{const[{data:r},{data:i}]=await Promise.all([c.from("classes").select("id, name, created_by").eq("id",s).single(),c.from("profiles").select("id, full_name").in("id",e)]);if(r?.created_by&&i?.length)for(const n of i)await I.send("studentAddedToClass",{userId:r.created_by,variables:{studentName:n.full_name||"Aluno",className:r.name||"Turma"},channelOverride:"push",metadata:{classId:s,studentId:n.id}})}catch(r){o.warn("Falha ao notificar alunos adicionados:",r)}return a},async removeStudentsFromClass(s,e){if(!e||e.length===0)return!0;const{error:a}=await c.from("class_members").delete().eq("class_id",s).in("user_id",e).eq("role","student");if(a)throw o.error(`Error removing students from class ${s}:`,a),a;try{const[{data:t},{data:r}]=await Promise.all([c.from("classes").select("id, name").eq("id",s).single(),c.from("profiles").select("id, full_name").in("id",e)]);for(const i of r||[])await I.send("studentRemovedFromClass",{userId:i.id,email:void 0,variables:{className:t?.name||"Turma"},metadata:{classId:s}})}catch(t){o.warn("Falha ao notificar alunos removidos:",t)}return!0},async searchClasses(s,{onlyActive:e=!0}={}){let a=c.from("classes").select("*").or(`name.ilike.%${s}%,description.ilike.%${s}%`);e&&(a=a.eq("is_active",!0));const{data:t,error:r}=await a;if(r)throw o.error("Error searching classes:",r),r;return t},async updateClassSchedule(s,e){const{data:a,error:t}=await c.from("classes").update({vacation_start:e.vacation_start||null,vacation_end:e.vacation_end||null,cancelled_dates:e.cancelled_dates||null,updated_at:new Date().toISOString()}).eq("id",s).select().single();if(t)throw o.error(`Error updating class schedule ${s}:`,t),t;return a},async getClassStats(s){try{const{data:e,error:a}=await c.from("class_members").select("user_id, role").eq("class_id",s);if(a)throw a;const{count:t,error:r}=await c.from("activity_class_assignments").select("*",{count:"exact",head:!0}).eq("class_id",s);if(r)throw r;const{data:i,error:n}=await c.from("submissions").select("id, activity_id").eq("status","pending").in("activity_id",c.from("activity_class_assignments").select("activity_id").eq("class_id",s)),d=e?.filter(l=>l.role==="student").length||0,f=e?.filter(l=>l.role==="teacher").length||0;return{studentCount:d,teacherCount:f,activitiesCount:t||0,pendingCorrections:i?.length||0,totalMembers:e?.length||0}}catch(e){return o.error(`Error getting stats for class ${s}:`,e),{studentCount:0,teacherCount:0,activitiesCount:0,pendingCorrections:0,totalMembers:0}}},async generateInviteCode(s){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let a="";for(let i=0;i<8;i++)a+=e.charAt(Math.floor(Math.random()*e.length));const{data:t,error:r}=await c.from("classes").update({invite_code:a,updated_at:new Date().toISOString()}).eq("id",s).select("invite_code").single();if(r)throw o.error(`Error generating invite code for class ${s}:`,r),r;return t.invite_code},async archiveClass(s){const{error:e}=await c.from("classes").update({is_active:!1,updated_at:new Date().toISOString()}).eq("id",s);if(e)throw o.error(`Error archiving class ${s}:`,e),e;return!0},async getClassMembers(s,{role:e=null}={}){let a=c.from("class_members").select(`
        *,
        user:profiles(*)
      `).eq("class_id",s).order("joined_at",{ascending:!1});e&&(a=a.eq("role",e));const{data:t,error:r}=await a;if(r)throw o.error(`Error fetching members for class ${s}:`,r),r;return t},async joinClassByCode(s,e){const a=(s||"").toString().replace(/\s/g,"").trim().toUpperCase();if(!a)throw new Error("C√≥digo de turma inv√°lido ou turma n√£o encontrada");console.log("üîç [ClassService] Tentando entrar com c√≥digo:",a),o.debug("[ClassService.joinClassByCode] Tentando entrar com c√≥digo:",{inviteCode:s,normalizedCode:a});let t=null;const{data:r,error:i}=await c.from("classes").select("*").or("is_active.is.null,is_active.eq.true");if(i&&o.error("[ClassService.joinClassByCode] Erro ao buscar turmas:",i),r&&r.length>0){const l=r.filter(m=>m.invite_code).map(m=>({id:m.id,name:m.name,originalCode:m.invite_code,normalizedCode:m.invite_code.toString().replace(/\s/g,"").trim().toUpperCase()}));o.debug("[ClassService.joinClassByCode] C√≥digos dispon√≠veis:",l),console.log("üìã C√≥digos dispon√≠veis:",l.map(m=>m.normalizedCode)),t=r.find(m=>{if(!m.invite_code)return!1;const h=m.invite_code.toString().replace(/\s/g,"").trim().toUpperCase(),y=h===a;return y&&(console.log("‚úÖ C√ìDIGO ENCONTRADO!",{c√≥digo:a,turma:m.name}),o.debug("[ClassService.joinClassByCode] ‚úì C√≥digo encontrado!",{searchedCode:a,foundCode:h,className:m.name})),y}),o.debug("[ClassService.joinClassByCode] Resultado busca em classes.invite_code:",{hasClass:!!t,totalClassesChecked:r.length,foundClass:t?{id:t.id,name:t.name}:null})}if(!t){const{data:l,error:m}=await c.from("class_settings").select("class_id, join_code, is_join_code_active").eq("is_join_code_active",!0);if(m&&o.error("[ClassService.joinClassByCode] Erro ao buscar class_settings:",m),l&&l.length>0){const h=l.find(y=>y.join_code?y.join_code.toString().replace(/\s/g,"").trim().toUpperCase()===a:!1);if(o.debug("[ClassService.joinClassByCode] Resultado busca em class_settings.join_code:",{hasSettings:!!h,totalSettingsChecked:l.length}),h&&h.class_id){const{data:y,error:b}=await c.from("classes").select("*").eq("id",h.class_id).or("is_active.is.null,is_active.eq.true").maybeSingle();y?t=y:b&&o.error("Erro ao buscar turma a partir de class_settings:",b)}}}if(!t)throw console.log("‚ùå C√ìDIGO N√ÉO ENCONTRADO:",a),o.warn("[ClassService.joinClassByCode] C√≥digo n√£o encontrado:",{normalizedCode:a}),new Error("C√≥digo de turma inv√°lido ou turma n√£o encontrada");o.debug("[ClassService.joinClassByCode] Turma encontrada:",{classId:t.id,className:t.name,inviteCode:t.invite_code});const{data:n}=await c.from("class_members").select("id").eq("class_id",t.id).eq("user_id",e).single();if(n)throw new Error("Voc√™ j√° √© membro desta turma");const{data:d,error:f}=await c.from("class_members").insert({class_id:t.id,user_id:e,role:"student",joined_at:new Date().toISOString()}).select().single();if(f)throw o.error("Error joining class:",f),new Error("Erro ao entrar na turma");try{const{data:l}=await c.from("profiles").select("full_name").eq("id",e).single();await I.send("studentJoinedClass",{userId:t.created_by,variables:{studentName:l?.full_name||"Novo aluno",className:t.name},channelOverride:"push",metadata:{classId:t.id,studentId:e}})}catch(l){o.warn("Failed to notify teacher:",l)}return t},async getTeacherClasses(s){try{const{data:e,error:a}=await c.from("classes").select("*").eq("created_by",s).eq("is_active",!0).order("name",{ascending:!0});if(a)throw a;return e||[]}catch(e){throw o.error("Error fetching teacher classes:",e),e}},async getClassByInviteCode(s){const{data:e,error:a}=await c.from("classes").select(`
        *,
        teacher:profiles!classes_created_by_fkey(id, full_name, name, avatar_url)
      `).eq("invite_code",s).eq("is_active",!0).single();if(a||!e)throw o.error("Error fetching class by invite code:",a),new Error(a?.message||"C√≥digo de turma inv√°lido");return e},async cloneClassStructure(s,e={}){const{name:a,copyStudents:t=!1,copyActivities:r=!1}=e;try{const{data:i,error:n}=await c.from("classes").select("*").eq("id",s).single();if(n||!i)throw o.error("Erro ao buscar turma de origem para clonagem:",n),new Error("Turma de origem n√£o encontrada para clonagem.");let d=[];if(t){const{data:h,error:y}=await c.from("class_members").select("user_id").eq("class_id",s).eq("role","student");if(y)throw o.error("Erro ao buscar alunos da turma de origem para clonagem:",y),new Error("Erro ao buscar alunos da turma de origem.");d=(h||[]).map(b=>b.user_id)}const l={name:a||`${i.name} - C√≥pia`,description:i.description,teacher_id:i.created_by,subject:i.subject,course:i.course,period:i.period,grade_level:i.grade_level,academic_year:i.academic_year,color:i.color,student_capacity:i.student_capacity,school_id:i.school_id,is_school_managed:i.is_school_managed,grading_system:i.grading_system,room_number:i.room_number,is_online:i.is_online,meeting_link:i.meeting_link,chatbot_enabled:i.chatbot_enabled},m=await this.createClass(l,d);if(r)try{const{data:h,error:y}=await c.from("activity_class_assignments").select("activity_id, assigned_at").eq("class_id",s);if(y)throw y;const b=Array.from(new Set((h||[]).map(A=>A.activity_id)));if(b.length>0){const{data:A,error:S}=await c.from("activities").select("*").in("id",b);if(S)throw S;const _=(A||[]).reduce((C,N)=>(C[N.id]=N,C),{}),E={};for(const C of b){const N=_[C];if(!N)continue;const{id:O,created_at:T,updated_at:H,deleted_at:F,...U}=N,{data:D,error:R}=await c.from("activities").insert({...U,title:`${N.title} - C√≥pia`,status:"draft",is_draft:!0,is_published:!1,deleted_at:null}).select().single();if(R)throw R;E[C]=D.id}const v=(h||[]).map(C=>{const N=E[C.activity_id];return N?{activity_id:N,class_id:m.id,assigned_at:C.assigned_at||new Date().toISOString()}:null}).filter(Boolean);if(v.length>0){const{error:C}=await c.from("activity_class_assignments").insert(v);if(C)throw C}}}catch(h){o.error("Erro ao clonar atividades da turma:",h)}return m}catch(i){throw o.error("Erro ao clonar estrutura de turma:",i),i}},subscribeToClasses(s){const e=c.channel("classes_changes").on("postgres_changes",{event:"*",schema:"public",table:"classes"},a=>{s(a)}).subscribe();return()=>{c.removeChannel(e)}}};export{Y as C,B as E,I as N,L as a};
