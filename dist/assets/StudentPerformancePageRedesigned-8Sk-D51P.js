import{a as Ne,u as Se,r as h,s as d,l as c,j as e,q as Ae,b as Ce}from"./main-BSMlxxlZ.js";import{S as E}from"./StatCard-DSnnm9C5.js";import{C as A}from"./card-DMraIbJz.js";import{m as H,B as De}from"./button-CKV5JkoH.js";import{E as Ie}from"./EmptyState-BSYIwJt2.js";import{G as Ee}from"./GradeCard-D3-jzi5n.js";import"./dialog-DORbdWMS.js";import{S as W,a as Q,b as X,c as Y,d as _}from"./select-Y5bYU8BP.js";import{u as Re}from"./use-toast-DU85wOBR.js";import{S as q}from"./star-DKU9KxO3.js";import{C as Te}from"./circle-alert-EA2lUZox.js";import{S as Z}from"./sparkles-BKzRvIU-.js";import{C as Ge}from"./circle-check-big-CZzygBvA.js";import{T as ee}from"./target-BWVM_5Ui.js";import{L as Me}from"./lightbulb-D32stgfb.js";import{B as qe}from"./chevron-right-D_FKfY1S.js";import{T as Pe}from"./trophy-DuM12EK9.js";import{T as Fe}from"./trending-up-6aD5U3kC.js";import{ag as P,ai as Ue,aj as F,ak as U,al as z,ah as L,am as ze}from"./LineChart-D48X98-n.js";import{B as te,d as ae}from"./BarChart--dZ3Fcds.js";import{f as se}from"./format-BcFT9btV.js";import{p as ie}from"./pt-BR-CuGSKEGQ.js";import"./SidebarPremium-Bf98hnme.js";import"./bell-C38I9ebQ.js";import"./user-C2we2FXy.js";import"./file-text-BP6UKDNn.js";import"./settings-Ce4vc5Vl.js";import"./house-BiazGQzC.js";import"./users-BNOTPuIE.js";import"./graduation-cap-CzbYlLlS.js";import"./index-CpTBUXYw.js";import"./chart-column-CNsjJ5jU.js";import"./x-rSiybgWV.js";import"./message-square-BZXYrfe5.js";import"./index-DrqYlGSU.js";import"./index-BwDK55Mp.js";import"./index-CB9Ufca0.js";import"./index-CtuxL-Fj.js";import"./chevron-down-Bk5F_mLz.js";import"./check-iGKxEgx2.js";import"./chevron-up-C0F5446Y.js";import"./index-D6vFAzWj.js";import"./en-US-B6HbAA6N.js";const Et=()=>{const{user:m}=Ne(),re=Se(),{toast:k}=Re(),[oe,B]=h.useState(!0),[O,C]=h.useState(!1),[D,$]=h.useState(null),[w,R]=h.useState(0),[ne,K]=h.useState(!0),[u,V]=h.useState({avgGrade:0,totalActivities:0,completedActivities:0,ranking:null}),[I,T]=h.useState([]),[J,de]=h.useState([]),[N,le]=h.useState([]),[G,ce]=h.useState([]),[j,me]=h.useState("all"),[y,ue]=h.useState("all"),[pe,ge]=h.useState([]);h.useEffect(()=>{m?.id&&(he(),M())},[m,j,y]);const M=async()=>{try{K(!0);const t=new Date;t.setHours(0,0,0,0);const{data:s,error:n}=await d.from("ai_recommendations_usage").select("id").eq("student_id",m.id).gte("created_at",t.toISOString());n?(c.error("[AI Usage] Erro ao buscar contador:",n),R(0)):(R(s?.length||0),c.debug("[AI Usage] Usos hoje:",s?.length||0))}catch(t){c.error("[AI Usage] Erro ao buscar contador:",t),R(0)}finally{K(!1)}},he=async()=>{try{B(!0),await Promise.all([fe(),ve(),be(),je(),ye(),xe()])}catch(t){c.error("Erro ao carregar dados de desempenho:",t)}finally{B(!1)}},xe=async()=>{try{const{data:t}=await d.from("class_members").select("class_id").eq("user_id",m.id).eq("role","student"),s=t?.map(o=>o.class_id)||[],{data:n}=await d.from("classes").select("id, name, subject").in("id",s);ge(n||[])}catch(t){c.error("Erro ao carregar turmas:",t)}},fe=async()=>{try{const{data:t}=await d.from("class_members").select("class_id").eq("user_id",m.id).eq("role","student");let s=t?.map(r=>r.class_id)||[];if(j!=="all"&&(s=s.filter(r=>r===j)),s.length===0){V({avgGrade:0,totalActivities:0,completedActivities:0,ranking:null});return}const{data:n}=await d.from("activity_class_assignments").select("activity_id").in("class_id",s),o=n?.map(r=>r.activity_id)||[],v=o.length;let l=d.from("submissions").select("activity_id, status, grade, submitted_at").eq("student_id",m.id).in("activity_id",o);if(y!=="all"){const r=new Date;let b=new Date;y==="week"?b.setDate(r.getDate()-7):y==="month"?b.setMonth(r.getMonth()-1):y==="semester"&&b.setMonth(r.getMonth()-6),l=l.gte("submitted_at",b.toISOString())}const{data:x}=await l,i=x?.length||0,p=x?.filter(r=>r.grade!==null)||[],g=p.length>0?p.reduce((r,b)=>r+parseFloat(b.grade),0)/p.length:0;V({avgGrade:g,totalActivities:v,completedActivities:i,ranking:null})}catch(t){c.error("Erro ao carregar stats:",t)}},ve=async()=>{try{const{data:t}=await d.from("class_members").select("class_id").eq("user_id",m.id).eq("role","student");let s=t?.map(a=>a.class_id)||[];if(j!=="all"&&(s=s.filter(a=>a===j)),s.length===0){T([]);return}const{data:n}=await d.from("activity_class_assignments").select("activity_id, class_id").in("class_id",s),o=n?.map(a=>a.activity_id)||[];if(o.length===0){T([]);return}const{data:v}=await d.from("submissions").select("id, grade, feedback, submitted_at, status, activity_id").eq("student_id",m.id).in("activity_id",o).not("grade","is",null).order("submitted_at",{ascending:!1}).limit(5),l=v?.map(a=>a.activity_id)||[],{data:x}=await d.from("activities").select("id, title, max_score").in("id",l),i={};x?.forEach(a=>{i[a.id]=a});const{data:p}=await d.from("classes").select("id, name").in("id",s),g={};p?.forEach(a=>{g[a.id]=a});const r={};n?.forEach(a=>{r[a.activity_id]=a.class_id});const b=(v||[]).map(a=>({...a,activity_title:i[a.activity_id]?.title,max_score:i[a.activity_id]?.max_score,class_id:r[a.activity_id],class_name:g[r[a.activity_id]]?.name}));T(b)}catch(t){c.error("Erro ao carregar notas recentes:",t)}},be=async()=>{try{const{data:t}=await d.from("submissions").select("grade, submitted_at, activity:activities(max_score)").eq("student_id",m.id).not("grade","is",null).order("submitted_at",{ascending:!0}).limit(20),s=(t||[]).map(n=>({date:se(new Date(n.submitted_at),"dd/MM",{locale:ie}),nota:parseFloat(n.grade)||0,maxScore:n.activity?.max_score||10}));de(s)}catch(t){c.error("Erro ao carregar evoluÃ§Ã£o:",t)}},je=async()=>{try{const{data:t}=await d.from("class_members").select("class_id").eq("user_id",m.id).eq("role","student"),s=t?.map(l=>l.class_id)||[],{data:n}=await d.from("classes").select("id, name, subject").in("id",s),o={};n?.forEach(l=>{o[l.id]=l});const v=await Promise.all((t||[]).map(async l=>{const{data:x}=await d.from("activity_class_assignments").select("activity_id").eq("class_id",l.class_id),i=x?.map(f=>f.activity_id)||[],{data:p}=await d.from("submissions").select("id, grade, submitted_at, activity_id").eq("student_id",m.id).in("activity_id",i).not("grade","is",null).order("submitted_at",{ascending:!0}),g=p?.map(f=>f.activity_id)||[],{data:r}=await d.from("activities").select("id, title, max_score").in("id",g),b={};r?.forEach(f=>{b[f.id]=f});const a=p?.map(f=>parseFloat(f.grade))||[],S=a.length>0?a.reduce((f,we)=>f+we,0)/a.length:0,ke=(p||[]).map(f=>({date:se(new Date(f.submitted_at),"dd/MM",{locale:ie}),grade:parseFloat(f.grade)}));return{name:o[l.class_id]?.name||"Turma",media:S,history:ke}}));le(v.sort((l,x)=>x.media-l.media))}catch(t){c.error("Erro ao carregar desempenho por turma:",t)}},ye=async()=>{try{const t=[{skill:"Objetivas",value:0,count:0},{skill:"Abertas",value:0,count:0},{skill:"Mistas",value:0,count:0}],{data:s}=await d.from("submissions").select(`
          grade,
          activity:activities(type, max_score)
        `).eq("student_id",m.id).not("grade","is",null);s?.forEach(o=>{const v=parseFloat(o.grade)/parseFloat(o.activity?.max_score)*100;o.activity?.type==="objective"?(t[0].value+=v,t[0].count++):o.activity?.type==="open"?(t[1].value+=v,t[1].count++):o.activity?.type==="mixed"&&(t[2].value+=v,t[2].count++)});const n=t.map(o=>({skill:o.skill,value:o.count>0?Math.round(o.value/o.count):0}));ce(n)}catch(t){c.error("Erro ao carregar radar de habilidades:",t)}},_e=async()=>{const t=`ai_recommendations_${m.id}`;try{C(!0);const s=localStorage.getItem(t);if(s){const{recommendations:i,timestamp:p}=JSON.parse(s),g=Date.now()-p,r=1800*1e3;if(g<r){c.debug("[AI] Usando recomendaÃ§Ãµes do cache (rate limit)"),$(i),C(!1),k({title:"âœ… RecomendaÃ§Ãµes carregadas",description:"Usando anÃ¡lise recente do cache"});return}}const n={avgGrade:u.avgGrade,totalActivities:u.totalActivities,completedActivities:u.completedActivities,recentGrades:I.slice(0,5).map(i=>({activityTitle:i.activity_title,grade:parseFloat(i.grade),maxScore:parseFloat(i.max_score),submittedAt:i.submitted_at,subject:i.class_name})),classComparison:N.map(i=>({subject:i.name,studentAvg:i.media,classAvg:i.media})),radarData:G};k({title:"ðŸ¤– Gerando recomendaÃ§Ãµes...",description:"Aguarde enquanto a IA analisa seu desempenho"});const{data:o}=await d.auth.getSession(),v=o?.session?.access_token,l=await fetch("https://wapbwaimkurbuihatmix.supabase.co/functions/v1/ai-study-recommendations",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${v}`},body:JSON.stringify({studentId:m.id,performanceData:n})});let x;if(l.ok){const i=await l.json();if(i.limitReached){c.warn("[AI] Limite diÃ¡rio atingido:",i),C(!1),await M(),k({title:"â° Limite DiÃ¡rio Atingido",description:i.message||"VocÃª jÃ¡ gerou 3 recomendaÃ§Ãµes hoje. Tente novamente amanhÃ£!",variant:"destructive",duration:5e3});return}await M(),c.debug("[AI] RecomendaÃ§Ãµes recebidas da Edge Function"),x=i.recommendations||i}else{c.debug("[AI] Usando fallback local (erro na API)");const i=N.filter(a=>a.media<7).sort((a,S)=>a.media-S.media),p=N.filter(a=>a.media>=8).sort((a,S)=>S.media-a.media),g=[];i.length>0?i.slice(0,2).forEach(a=>{g.push(`Revisar conceitos de ${a.name} onde as notas foram menores (mÃ©dia: ${a.media.toFixed(1)})`)}):g.push("Manter o ritmo de estudos atual"),I.some(a=>a.status==="draft")&&g.push("Completar atividades pendentes antes do prazo"),g.push("Participar mais das discussÃµes em sala");const r=[];u.avgGrade>=8?r.push("Ã“timo desempenho geral nas atividades"):u.avgGrade>=7?r.push("Bom desempenho nas atividades"):r.push("Mostrando esforÃ§o e dedicaÃ§Ã£o"),p.length>0&&p.slice(0,2).forEach(a=>{r.push(`Excelente em ${a.name} (mÃ©dia: ${a.media.toFixed(1)})`)}),(u.totalActivities>0?u.completedActivities/u.totalActivities*100:0)>=80&&r.push("ConsistÃªncia nas entregas dentro do prazo"),x={strengths:r,improvements:g,tips:["ðŸ“š Reserve 30min diÃ¡rios para revisÃ£o","âœï¸ Pratique mais questÃµes abertas","ðŸŽ¯ EstabeleÃ§a metas semanais de estudo","ðŸ‘¥ Forme grupos de estudo com colegas","â“ Tire dÃºvidas com professores"].slice(0,3)}}$(x),localStorage.setItem(t,JSON.stringify({recommendations:x,timestamp:Date.now()})),k({title:"âœ… RecomendaÃ§Ãµes geradas!",description:"Confira as sugestÃµes personalizadas abaixo"})}catch(s){c.error("Erro ao gerar recomendaÃ§Ãµes:",s),k({title:"âŒ Erro ao gerar recomendaÃ§Ãµes",description:"Tente novamente mais tarde",variant:"destructive"})}finally{C(!1)}};return oe?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(Ae,{size:"lg"})}):e.jsxs("div",{className:"min-h-screen bg-slate-50 dark:bg-slate-950 p-6",children:[e.jsx(H.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"mb-8",children:e.jsxs("div",{className:"flex items-start justify-between flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-slate-900 dark:text-white mb-2 flex items-center gap-3",children:[e.jsx(q,{className:"w-8 h-8 text-yellow-600"}),"Meu Desempenho"]}),e.jsx("p",{className:"text-slate-600 dark:text-slate-400",children:"Acompanhe suas notas e evoluÃ§Ã£o acadÃªmica"})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsx(De,{onClick:_e,disabled:O||u.totalActivities===0||w>=3,className:"bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700",children:O?e.jsxs(e.Fragment,{children:[e.jsx(Ce,{className:"w-4 h-4 mr-2 animate-spin"}),"Gerando..."]}):w>=3?e.jsxs(e.Fragment,{children:[e.jsx(Te,{className:"w-4 h-4 mr-2"}),"Limite DiÃ¡rio Atingido"]}):e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"Gerar RecomendaÃ§Ãµes com IA"]})}),!ne&&e.jsxs("span",{className:`text-sm ${w>=3?"text-red-600 dark:text-red-400 font-semibold":w>=2?"text-orange-600 dark:text-orange-400 font-medium":"text-slate-500 dark:text-slate-400"}`,children:[w,"/3 utilizadas hoje"]})]})]})}),D&&e.jsx(H.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"mb-8",children:e.jsxs(A,{className:"p-6 bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-950/20 dark:to-pink-950/20 border-2 border-purple-200 dark:border-purple-800",children:[e.jsxs("h2",{className:"text-2xl font-bold mb-6 flex items-center gap-2",children:[e.jsx(Z,{className:"w-6 h-6 text-purple-600"}),"RecomendaÃ§Ãµes Personalizadas da IA"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-bold text-green-700 dark:text-green-400 mb-3 flex items-center gap-2",children:[e.jsx(Ge,{className:"w-5 h-5"}),"Seus Pontos Fortes"]}),e.jsx("ul",{className:"space-y-2",children:D.strengths?.map((t,s)=>e.jsxs("li",{className:"text-sm text-slate-700 dark:text-slate-300 bg-white/70 dark:bg-slate-900/50 p-3 rounded-lg border border-green-200 dark:border-green-800",children:["â€¢ ",t]},s))||e.jsx("li",{className:"text-sm text-slate-500",children:"Carregando..."})})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-bold text-orange-700 dark:text-orange-400 mb-3 flex items-center gap-2",children:[e.jsx(ee,{className:"w-5 h-5"}),"Ãreas para Melhorar"]}),e.jsx("ul",{className:"space-y-2",children:D.improvements?.map((t,s)=>e.jsxs("li",{className:"text-sm text-slate-700 dark:text-slate-300 bg-white/70 dark:bg-slate-900/50 p-3 rounded-lg border border-orange-200 dark:border-orange-800",children:["â€¢ ",t]},s))||e.jsx("li",{className:"text-sm text-slate-500",children:"Carregando..."})})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-bold text-blue-700 dark:text-blue-400 mb-3 flex items-center gap-2",children:[e.jsx(Me,{className:"w-5 h-5"}),"Dicas de Estudo"]}),e.jsx("ul",{className:"space-y-2",children:D.tips?.map((t,s)=>e.jsx("li",{className:"text-sm text-slate-700 dark:text-slate-300 bg-white/70 dark:bg-slate-900/50 p-3 rounded-lg border border-blue-200 dark:border-blue-800",children:t},s))||e.jsx("li",{className:"text-sm text-slate-500",children:"Carregando..."})})]})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 mb-8",children:[e.jsxs(W,{value:j,onValueChange:me,children:[e.jsx(Q,{className:"w-full md:w-64",children:e.jsx(X,{placeholder:"Todas as turmas"})}),e.jsxs(Y,{children:[e.jsx(_,{value:"all",children:"Todas as turmas"}),pe.map(t=>e.jsx(_,{value:t.id,children:t.name},t.id))]})]}),e.jsxs(W,{value:y,onValueChange:ue,children:[e.jsx(Q,{className:"w-full md:w-64",children:e.jsx(X,{placeholder:"Todo o perÃ­odo"})}),e.jsxs(Y,{children:[e.jsx(_,{value:"all",children:"Todo o perÃ­odo"}),e.jsx(_,{value:"week",children:"Ãšltima semana"}),e.jsx(_,{value:"month",children:"Ãšltimo mÃªs"}),e.jsx(_,{value:"semester",children:"Ãšltimo semestre"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8",children:[e.jsx(E,{icon:q,value:u.avgGrade>0?u.avgGrade.toFixed(1):"--",label:"MÃ©dia Geral",gradient:"yellow"}),e.jsx(E,{icon:ee,value:u.completedActivities,label:"Atividades ConcluÃ­das",gradient:"green"}),e.jsx(E,{icon:qe,value:u.totalActivities,label:"Total de Atividades",gradient:"blue"}),e.jsx(E,{icon:Pe,value:u.ranking||"--",label:"PosiÃ§Ã£o no Ranking",gradient:"purple"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8",children:[J.length>0&&e.jsxs(A,{className:"p-6",children:[e.jsxs("h2",{className:"text-2xl font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2",children:[e.jsx(Fe,{className:"w-6 h-6 text-green-600"}),"EvoluÃ§Ã£o das Notas"]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsx(P,{width:"100%",height:300,className:"min-w-[400px]",children:e.jsxs(Ue,{data:J,margin:{top:5,right:20,left:0,bottom:5},children:[e.jsx(F,{strokeDasharray:"3 3",stroke:"#e2e8f0"}),e.jsx(U,{dataKey:"date",stroke:"#64748b",tick:{fontSize:12}}),e.jsx(z,{stroke:"#64748b",domain:[0,10],tick:{fontSize:12}}),e.jsx(L,{contentStyle:{backgroundColor:"white",border:"1px solid #e2e8f0",borderRadius:"8px"}}),e.jsx(ze,{type:"monotone",dataKey:"nota",stroke:"#10b981",strokeWidth:3,dot:{fill:"#10b981",r:6},name:"Nota"})]})})})]}),N.length>0&&e.jsxs(A,{className:"p-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2",children:"ðŸ“Š Por Turma"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsx(P,{width:"100%",height:300,className:"min-w-[300px]",children:e.jsxs(te,{data:N,layout:"vertical",margin:{top:10,right:30,left:10,bottom:10},children:[e.jsx(F,{strokeDasharray:"3 3",stroke:"#e2e8f0"}),e.jsx(U,{type:"number",stroke:"#64748b",domain:[0,10],tick:{fontSize:12}}),e.jsx(z,{type:"category",dataKey:"name",stroke:"#64748b",width:100,tick:{fontSize:11}}),e.jsx(L,{contentStyle:{backgroundColor:"white",border:"1px solid #e2e8f0",borderRadius:"8px"}}),e.jsx(ae,{dataKey:"media",fill:"#3b82f6",radius:[0,8,8,0],name:"MÃ©dia"})]})})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(A,{className:"p-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-900 dark:text-white mb-6",children:"ðŸ“ Ãšltimas Notas"}),I.length>0?e.jsx("div",{className:"space-y-4",children:I.map((t,s)=>e.jsx(Ee,{grade:t,onViewDetails:()=>re(`/students/activities/${t.activity_id}`),index:s},t.id))}):e.jsx(Ie,{icon:q,title:"Nenhuma nota ainda",description:"Complete suas atividades para ver suas notas aqui.",variant:"default"})]})}),e.jsx("div",{children:G.length>0&&e.jsxs(A,{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900 dark:text-white mb-6",children:"ðŸŽ¯ Por Tipo"}),e.jsx(P,{width:"100%",height:300,children:e.jsxs(te,{data:G,margin:{top:10,right:10,left:0,bottom:10},children:[e.jsx(F,{strokeDasharray:"3 3",stroke:"#e2e8f0"}),e.jsx(U,{dataKey:"skill",stroke:"#64748b",tick:{fontSize:12}}),e.jsx(z,{stroke:"#64748b",domain:[0,100],tick:{fontSize:12}}),e.jsx(L,{contentStyle:{backgroundColor:"white",border:"1px solid #e2e8f0",borderRadius:"8px"}}),e.jsx(ae,{dataKey:"value",fill:"#8b5cf6",radius:[8,8,0,0],name:"Desempenho %"})]})})]})})]})]})};export{Et as default};
