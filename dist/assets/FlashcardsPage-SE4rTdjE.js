import{c as de,b as be,u as ye,r as d,l as r,j as e,i as Ne,q as we,s as ie}from"./main-BtydHokz.js";import{B as I}from"./button-pkZcz0fw.js";import{C as Se}from"./card-BLN8IVBT.js";import{I as Ce}from"./input-DevW5dIO.js";import{B as Ae}from"./badge-DpVvk9bK.js";import{D as Ie,a as De,b as _e,c as $e,d as Ee}from"./dialog-BI66C03T.js";import{u as Pe}from"./use-toast-BD7ojcJx.js";import{S as J}from"./StatsCard-CQPBdi-L.js";import{D as qe}from"./DashboardHeader-Do_OLCE8.js";import{E as Oe}from"./EmptyState-B9PjJzZx.js";import"./dropdown-menu-DQk5WS44.js";import"./label-Do1Gcpls.js";import{f as W}from"./flashcardService-CK0ttocm.js";import{C as Fe}from"./chart-column-B3n9ZMAW.js";import{S as Be}from"./settings-BNGXdjmZ.js";import{U as Je}from"./upload-C88KdNIl.js";import{C as ze}from"./chevron-down-BPlSfXS4.js";import{P as ne}from"./plus-MdU524Dr.js";import{B as le}from"./book-open-BQJiPDff.js";import{B as ce}from"./brain-DIkHdpFj.js";import{C as Ke}from"./clock-cyyJEg8O.js";import{T as Me}from"./trending-up-C5ypBnjG.js";import{S as Re}from"./search-B-7BMQB5.js";import{m as Le}from"./proxy-BKNTM3tf.js";import{P as Te}from"./play-B6IQHa80.js";import"./index-BRR_QA-l.js";import"./index-C0ZNntAv.js";import"./Combination-DK-gSie6.js";import"./SidebarPremium-BEHUuQck.js";import"./house-dUPObbYn.js";import"./users-CntpuLnR.js";import"./file-text-GwBv-P3B.js";import"./graduation-cap-Bm5psu3Q.js";import"./calendar-xkfkZRmm.js";import"./message-circle-DTeSrK_w.js";import"./index-BpBd5wiB.js";import"./chevron-right-Bh44L5jc.js";import"./x-BtLVjj0F.js";import"./index-DOzlJ45Y.js";import"./index-sWFH3d_M.js";import"./index-DsrKRt14.js";import"./check-B1zY7uXK.js";const Ge=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 12a1 1 0 0 0-1 1v1a1 1 0 0 1-1 1 1 1 0 0 1 1 1v1a1 1 0 0 0 1 1",key:"1oajmo"}],["path",{d:"M14 18a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1 1 1 0 0 1-1-1v-1a1 1 0 0 0-1-1",key:"mpwhp6"}]],Ve=de("file-json",Ge);const Ue=[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["polyline",{points:"3.29 7 12 12 20.71 7",key:"ousv84"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]],He=de("package",Ue),Jt=()=>{const{user:n}=be(),{toast:u}=Pe(),g=ye(),[z,y]=d.useState(!0),[N,K]=d.useState(!0),[h,M]=d.useState([]),[O,v]=d.useState({total_decks:0,total_cards:0,cards_due_today:0,reviews_today:0}),[j,me]=d.useState(""),[w,Z]=d.useState(!1),[S,X]=d.useState(!1),[R,F]=d.useState(!1),[Y,pe]=d.useState({top:0,right:0}),[D,x]=d.useState({open:!1,title:"",description:"",isError:!1}),L=d.useRef(null),T=d.useRef(null),G=d.useRef(null),_=d.useRef(null);d.useEffect(()=>{n?.id&&he()},[n]),d.useEffect(()=>{const t=o=>{G.current&&!G.current.contains(o.target)&&_.current&&!_.current.contains(o.target)&&F(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]);const ue=()=>{if(!R&&_.current){const t=_.current.getBoundingClientRect();pe({top:t.bottom+8,right:window.innerWidth-t.right})}F(!R)},he=async()=>{try{y(!0);const{data:t,error:o}=await W.getUserStats(n.id);if(o)throw o;v(t),M(t.decks||[])}catch(t){r.error("Error loading flashcards dashboard:",t),u({title:"Erro ao carregar",description:"Não foi possível carregar seus flashcards.",variant:"destructive"})}finally{y(!1),N&&K(!1)}},ee=()=>{g("/students/flashcards/decks/new")},fe=t=>{g(`/students/flashcards/decks/${t}/review`)},ge=t=>{g(`/students/flashcards/decks/${t}`)},xe=()=>{g("/students/flashcards/settings")},ke=()=>{g("/students/flashcards/stats")},ve=async t=>{const o=t.target.files?.[0];if(t.target.value="",r.debug("Import: File selected",{fileName:o?.name,size:o?.size}),!o){r.debug("Import: No file selected");return}if(!n?.id){r.debug("Import: User not authenticated"),u({title:"Usuário não autenticado",description:"Faça login para importar decks.",variant:"destructive"});return}x({open:!0,title:"Importando deck JSON...",description:`Estamos processando o arquivo "${o.name}". Isso pode levar alguns segundos.`,isError:!1});try{r.debug("Import: Starting import process"),Z(!0);const m=await o.text();r.debug("Import: File read successfully",{textLength:m.length});const s=JSON.parse(m),B=(o.name||"Deck importado").replace(/\.[^/.]+$/,"");let f=[],b="",C=null,$="#3B82F6";if(Array.isArray(s))f=s,b=B,r.debug("Import: Detected plain cards array JSON",{cardsCount:f.length,deckName:b});else{const c=Array.isArray(s.kanji),U=Array.isArray(s.hiragana),H=Array.isArray(s.katakana);if(r.debug("Import: JSON parsed successfully",{hasName:!!s.name,cardsCount:s.cards?.length,hasCards:Array.isArray(s.cards),hasKanji:c,hasHiragana:U,hasKatakana:H}),Array.isArray(s.cards))f=s.cards,b=String(s.name||B).trim(),C=s.description?String(s.description).trim():null,$=s.color||"#3B82F6";else if(c||U||H){r.debug("Import: Detected structured Japanese JSON",{hasKanji:c,hasHiragana:U,hasKatakana:H});const ae=(s.kanji||[]).map(a=>{const P=String(a.kanji??"").trim(),i=[];a.significado&&i.push(`Significado: ${a.significado}`),Array.isArray(a.onyomi)&&a.onyomi.length>0&&i.push(`Onyomi: ${a.onyomi.join(", ")}`),Array.isArray(a.kunyomi)&&a.kunyomi.length>0&&i.push(`Kunyomi: ${a.kunyomi.join(", ")}`);const l=Array.isArray(a.palavras_comuns)?a.palavras_comuns[0]:null;if(l){const Q=["Palavra comum:",l.jap||l.jp,l.romaji?`(${l.romaji})`:null,l.pt?`- ${l.pt}`:null].filter(Boolean).join(" ");i.push(Q)}const k=Array.isArray(a.exemplos)?a.exemplos[0]:null;if(k){const Q=["Exemplo:",k.jp,k.romaji?`(${k.romaji})`:null,k.pt?`- ${k.pt}`:null].filter(Boolean).join(" ");i.push(Q)}const q=i.join(`
`).trim();return{front:P,back:q,card_type:"basic",tags:["kanji"]}}).filter(a=>a.front&&a.back),se=(s.hiragana||[]).map(a=>{const P=String(a.char??"").trim(),i=a.exemplo||{},l=[];if(a.romaji&&l.push(`Romaji: ${a.romaji}`),i.jap||i.romaji||i.pt){const q=["Exemplo:",i.jap,i.romaji?`(${i.romaji})`:null,i.pt?`- ${i.pt}`:null].filter(Boolean).join(" ");l.push(q)}const k=l.join(`
`).trim();return{front:P,back:k,card_type:"basic",tags:["hiragana"]}}).filter(a=>a.front&&a.back),oe=(s.katakana||[]).map(a=>{const P=String(a.char??"").trim(),i=a.exemplo||{},l=[];if(a.romaji&&l.push(`Romaji: ${a.romaji}`),i.jap||i.romaji||i.pt){const q=["Exemplo:",i.jap,i.romaji?`(${i.romaji})`:null,i.pt?`- ${i.pt}`:null].filter(Boolean).join(" ");l.push(q)}const k=l.join(`
`).trim();return{front:P,back:k,card_type:"basic",tags:["katakana"]}}).filter(a=>a.front&&a.back);f=[...ae,...se,...oe],b=String(s.name||B).trim(),C=s.metadata?.descricao?String(s.metadata.descricao).trim():C,r.debug("Import: Japanese JSON converted to raw cards",{totalKanji:ae.length,totalHiragana:se.length,totalKatakana:oe.length,totalCards:f.length})}else{r.debug("Import: Validation failed (no cards array found)",{jsonKeys:Object.keys(s||{})}),u({title:"Arquivo inválido",description:"O JSON deve ser um array de cards, conter { cards: [...] } ou um formato suportado de estudo (kanji/hiragana/katakana).",variant:"destructive"}),x({open:!0,title:"Arquivo inválido",description:"O JSON deve ser um array de cards, conter { cards: [...] } ou um formato suportado de estudo (kanji/hiragana/katakana).",isError:!0});return}}if(!f||f.length===0){r.debug("Import: No cards found after parsing"),u({title:"Arquivo inválido",description:"Nenhum card encontrado no JSON.",variant:"destructive"}),x({open:!0,title:"Arquivo inválido",description:"Nenhum card encontrado no JSON.",isError:!0});return}const A={user_id:n.id,name:b,description:C,color:$,icon:"BookOpen"};r.debug("Import: Creating deck",{deckName:A.name});const{data:p,error:V}=await W.createDeck(A);if(V)throw r.error("Import: Deck creation failed",V),V;r.debug("Import: Deck created successfully",{deckId:p.id,deckName:p.name});const E=(f||[]).map(c=>({deck_id:p.id,user_id:n.id,front:String(c.front??"").trim(),back:String(c.back??"").trim(),card_type:c.card_type||"basic",tags:Array.isArray(c.tags)?c.tags:[]})).filter(c=>c.front&&c.back);if(r.debug("Import: Processed cards",{totalCards:f.length,validCards:E.length}),E.length>0){r.debug("Import: Creating cards");const{error:c}=await W.createCards(E);if(c)throw r.error("Import: Cards creation failed",c),c;r.debug("Import: Cards created successfully")}u({title:"Deck importado!",description:`Deck "${p.name}" criado com ${E.length} cards.`}),x({open:!0,title:"Deck importado!",description:`Deck "${p.name}" criado com ${E.length} cards.`,isError:!1}),r.debug("Import: Navigation scheduled"),setTimeout(()=>{r.debug("Import: Navigating to deck"),g(`/students/flashcards/decks/${p.id}`)},100)}catch(m){r.error("Error importing deck JSON:",m),u({title:"Erro ao importar deck",description:"Verifique o arquivo JSON e tente novamente.",variant:"destructive"}),x({open:!0,title:"Erro ao importar deck",description:"Verifique o arquivo JSON e tente novamente.",isError:!0})}finally{r.debug("Import: Finally block, resetting importing state"),Z(!1)}},je=async t=>{const o=t.target.files?.[0];if(t.target.value="",r.debug("Import APKG: File selected",{fileName:o?.name,size:o?.size}),!o){r.debug("Import APKG: No file selected");return}if(!n?.id){r.debug("Import APKG: User not authenticated"),u({title:"Usuário não autenticado",description:"Faça login para importar decks.",variant:"destructive"});return}try{r.debug("Import APKG: Starting import process"),X(!0);const m=100*1024*1024;if(o.size>m){u({title:"Arquivo muito grande",description:"O arquivo deve ter no máximo 100MB.",variant:"destructive"}),x({open:!0,title:"Arquivo muito grande",description:"O arquivo deve ter no máximo 100MB.",isError:!0});return}u({title:"Enviando arquivo...",description:"Aguarde enquanto o deck Anki é processado."}),x({open:!0,title:"Importando deck Anki (.apkg)...",description:`Estamos enviando e processando o arquivo "${o.name}". Isso pode levar alguns minutos para decks grandes.`,isError:!1});const s=`${n.id}/${Date.now()}_${o.name}`,{data:B,error:f}=await ie.storage.from("flashcards-imports").upload(s,o);if(f)throw r.error("Import APKG: Upload error",f),new Error("Falha ao enviar arquivo");r.debug("Import APKG: File uploaded",{path:s});const b=o.name.replace(/\.apkg$/i,""),{data:C}=await ie.auth.getSession(),$=C?.session;if(!$)throw new Error("Sessão expirada. Faça login novamente.");const A=await fetch("https://wapbwaimkurbuihatmix.supabase.co/functions/v1/import-anki",{method:"POST",headers:{Authorization:`Bearer ${$.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({bucket:"flashcards-imports",file_path:s,create_new_deck:!0,deck_name:b,deck_description:"Deck importado do Anki"})}),p=await A.json().catch(()=>null);if(!A.ok||!p?.success)throw r.error("Import APKG: Function error",{status:A.status,data:p}),new Error(p?.error||"Erro ao processar deck Anki");r.debug("Import APKG: Import successful",p),u({title:"Deck importado com sucesso!",description:`${p.import_stats?.total_cards_created||0} cards foram adicionados ao deck "${b}".`}),x({open:!0,title:"Deck importado com sucesso!",description:`${p.import_stats?.total_cards_created||0} cards foram adicionados ao deck "${b}".`,isError:!1}),setTimeout(()=>{g(`/students/flashcards/decks/${p.deck_id}`)},100)}catch(m){r.error("Import APKG: Error",m),u({title:"Erro ao importar deck Anki",description:m.message||"Verifique o arquivo e tente novamente.",variant:"destructive"}),x({open:!0,title:"Erro ao importar deck Anki",description:m.message||"Verifique o arquivo e tente novamente.",isError:!0})}finally{r.debug("Import APKG: Finally block"),X(!1)}},te=h.filter(t=>t.name.toLowerCase().includes(j.toLowerCase())||t.description?.toLowerCase().includes(j.toLowerCase())),re=h.reduce((t,o)=>{const m=o.deck_stats?.[0]||null;if(!m)return t;const s=Number(m.cards_due_today||0)+Number(m.new_cards||0);return t+(Number.isFinite(s)?s:0)},0);return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 p-6",children:[e.jsx(qe,{title:"Flashcards",subtitle:`Sistema de repetição espaçada para memorização eficiente • Hoje: ${re} cards para revisar`,actions:e.jsxs("div",{className:"flex gap-2 relative z-10",children:[e.jsxs(I,{variant:"outline",size:"sm",onClick:ke,children:[e.jsx(Fe,{className:"w-4 h-4 mr-2"}),"Estatísticas"]}),e.jsxs(I,{variant:"outline",size:"sm",onClick:xe,children:[e.jsx(Be,{className:"w-4 h-4 mr-2"}),"Configurações"]}),e.jsx("div",{ref:_,children:e.jsxs(I,{variant:"outline",size:"sm",onClick:ue,disabled:w||S,className:"bg-white text-slate-900 border-white/20 hover:bg-white/90 hover:text-slate-900",children:[e.jsx(Je,{className:"w-4 h-4 mr-2"}),w||S?"Importando...":"Importar Deck",e.jsx(ze,{className:"w-4 h-4 ml-2"})]})}),R&&!w&&!S&&Ne.createPortal(e.jsx("div",{ref:G,className:"fixed w-64 bg-white dark:bg-slate-800 rounded-lg shadow-2xl border-2 border-slate-300 dark:border-slate-600",style:{zIndex:9999,top:`${Y.top}px`,right:`${Y.right}px`},children:e.jsxs("div",{className:"py-2",children:[e.jsxs("button",{type:"button",className:"flex w-full items-center px-4 py-3 hover:bg-blue-50 dark:hover:bg-slate-700 cursor-pointer transition-colors border-b-2 border-slate-200 dark:border-slate-600 text-left",onClick:()=>{F(!1),!w&&L.current&&L.current.click()},children:[e.jsx(Ve,{className:"w-5 h-5 mr-3 text-blue-600 dark:text-blue-400 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-900 dark:text-white",children:"Importar JSON"}),e.jsx("div",{className:"text-xs text-slate-600 dark:text-slate-400",children:"Formato customizado"})]})]}),e.jsxs("button",{type:"button",className:"flex w-full items-center px-4 py-3 hover:bg-purple-50 dark:hover:bg-slate-700 cursor-pointer transition-colors text-left",onClick:()=>{F(!1),!S&&T.current&&T.current.click()},children:[e.jsx(He,{className:"w-5 h-5 mr-3 text-purple-600 dark:text-purple-400 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-900 dark:text-white",children:"Importar Anki (.apkg)"}),e.jsx("div",{className:"text-xs text-slate-600 dark:text-slate-400",children:"Deck do Anki com mídia"})]})]})]})}),document.body),e.jsx("input",{type:"file",accept:"application/json",ref:L,className:"hidden",onChange:ve}),e.jsx("input",{type:"file",accept:".apkg",ref:T,className:"hidden",onChange:je}),e.jsxs(I,{onClick:ee,className:"bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white",children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"Novo Deck"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8",children:[e.jsx(J,{title:"Total de Decks",value:O.total_decks,icon:le,gradient:"from-purple-500 to-pink-600",delay:0}),e.jsx(J,{title:"Total de Cards",value:O.total_cards,icon:ce,gradient:"from-blue-500 to-cyan-600",delay:.1}),e.jsx(J,{title:"Para Revisar Hoje",value:re,icon:Ke,gradient:"from-orange-500 to-red-600",delay:.2}),e.jsx(J,{title:"Revisões Hoje",value:O.reviews_today,icon:Me,gradient:"from-emerald-500 to-teal-600",delay:.3})]}),h.length>0&&e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"relative max-w-md",children:[e.jsx(Re,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400"}),e.jsx(Ce,{type:"text",placeholder:"Buscar decks...",value:j,onChange:t=>me(t.target.value),className:"pl-10"})]})}),te.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:te.map((t,o)=>e.jsx(Le.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:o*.05},children:e.jsx(Qe,{deck:t,onStudy:()=>fe(t.id),onView:()=>ge(t.id)})},t.id))}):e.jsx(Oe,{icon:ce,title:j?"Nenhum deck encontrado":"Nenhum deck criado",description:j?"Tente buscar com outros termos":"Crie seu primeiro deck de flashcards para começar a estudar!",actionLabel:"Criar Deck",actionIcon:ne,action:ee}),e.jsx(Ie,{open:D.open,onOpenChange:t=>{w||S||x(o=>({...o,open:t}))},children:e.jsxs(De,{children:[e.jsxs(_e,{children:[e.jsx($e,{className:D.isError?"text-red-600 dark:text-red-400":"",children:D.title||"Importação de deck"}),D.description&&e.jsx(Ee,{children:D.description})]}),(w||S)&&e.jsx("div",{className:"mt-4",children:e.jsx(we,{size:"sm",text:"Processando, aguarde...",center:!0})})]})})]})},Qe=({deck:n,onStudy:u,onView:g,dueCount:z})=>{const y=n.deck_stats?.[0]||null,N=Number(n.total_cards??0)||Number(n.cards_count??0)||(Array.isArray(n.cards)?n.cards.length:0),K=y?Number(y.cards_due_today||0)+Number(y.new_cards||0):N,h=typeof z=="number"?z:K,M=y?Number(y.new_cards||0):N,v=N>0&&h===0?{text:"Tudo revisado hoje",color:"green"}:h===0?{text:"Sem cards",color:"slate"}:h<10?{text:`${h} para revisar`,color:"blue"}:h<50?{text:`${h} para revisar`,color:"orange"}:{text:`${h} para revisar`,color:"red"};return e.jsxs(Se,{className:"group hover:shadow-xl transition-all duration-300 overflow-hidden cursor-pointer border-2 hover:border-purple-300 dark:hover:border-purple-700",children:[e.jsx("div",{className:"h-2",style:{backgroundColor:n.color||"#3B82F6"}}),e.jsxs("div",{className:"p-6",onClick:g,children:[e.jsx("div",{className:"flex items-start justify-between mb-4",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-white mb-1 group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors",children:n.name}),n.description&&e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400 line-clamp-2",children:n.description})]})}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-4 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xl font-bold text-purple-600 dark:text-purple-400",children:N}),e.jsx("div",{className:"text-xs text-slate-600 dark:text-slate-400",children:"Cards"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xl font-bold text-blue-600 dark:text-blue-400",children:M}),e.jsx("div",{className:"text-xs text-slate-600 dark:text-slate-400",children:"Novos"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:`text-xl font-bold text-${v.color}-600 dark:text-${v.color}-400`,children:h}),e.jsx("div",{className:"text-xs text-slate-600 dark:text-slate-400",children:"Devidos"})]})]}),e.jsx("div",{className:"mb-4",children:e.jsx(Ae,{className:`bg-${v.color}-100 text-${v.color}-700 dark:bg-${v.color}-900/30 dark:text-${v.color}-300`,children:v.text})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(I,{onClick:j=>{j.stopPropagation(),N!==0&&u()},disabled:N===0,className:"flex-1 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white disabled:opacity-50",children:[e.jsx(Te,{className:"w-4 h-4 mr-2"}),"Estudar"]}),e.jsxs(I,{variant:"outline",onClick:j=>{j.stopPropagation(),g()},className:"flex-1",children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"Ver Cards"]})]})]})]})};export{Jt as default};
