import{r as m,j as e,t as O,u as H,s as k,l as R,p as T}from"./main-CulyknMy.js";import{B as w}from"./button-Dfu2yMjN.js";import{C as y}from"./card-0IW715z3.js";import{B as A}from"./badge-hAm5RhEJ.js";import{u as z}from"./use-toast-D1WbEInh.js";import{c as E,D as P}from"./DashboardHeader-BwYDScVc.js";import{I as q}from"./input-BedeDxLw.js";import"./dropdown-menu-YDjYKa0f.js";import{L as I}from"./label-hRNGW-_n.js";import{S as J}from"./save-CiiFTid_.js";import{X as Q}from"./x-C2dkvfPv.js";import{A as U}from"./arrow-left-BbvKd-s5.js";import{U as G}from"./user-BGYzkTxO.js";import{F as K}from"./file-text-76dwq0ip.js";import{C as M}from"./SidebarPremium-D7ISy0In.js";import{C as V}from"./chevron-right-f5dsdMUG.js";import"./index-Bqe-gmK6.js";import"./index-CtoMVlCU.js";import"./index-CKE1C3tK.js";import"./index-qba7jVBc.js";import"./index-Bce5oZaH.js";import"./check-Ds-bvwXg.js";import"./house-DSNk2C5T.js";import"./users-CLb1Ind1.js";import"./book-open-L6K6GApD.js";import"./graduation-cap-DGMUxzM9.js";import"./calendar-CAuJuRcm.js";import"./chart-column-Bg7XzELY.js";import"./message-circle-8Z2L2EEy.js";import"./settings-Bqthy2dX.js";import"./index-BZWQ4euU.js";const X=({maxGrade:l=10,initialGrade:h=null,initialFeedback:v="",onSave:S,onCancel:j,loading:f=!1})=>{const[d,t]=m.useState(h?.toString()||""),[N,g]=m.useState(v),[p,u]=m.useState({}),_=()=>{const s={};if(!d||d.trim()==="")s.grade="Nota √© obrigat√≥ria";else{const c=parseFloat(d);isNaN(c)?s.grade="Nota deve ser um n√∫mero":c<0?s.grade="Nota n√£o pode ser negativa":c>l&&(s.grade=`Nota n√£o pode ser maior que ${l}`)}return u(s),Object.keys(s).length===0},b=s=>{if(s.preventDefault(),!_())return;const c=parseFloat(d);S({grade:c,feedback:N})},$=s=>{const c=s.target.value;(c===""||/^\d*\.?\d*$/.test(c))&&(t(c),p.grade&&u({...p,grade:null}))};return e.jsx(y,{className:"p-6 bg-white dark:bg-slate-900",children:e.jsxs("form",{onSubmit:b,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs(I,{htmlFor:"grade",className:"text-sm font-semibold mb-2 block",children:["Nota (0 - ",l,")"]}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{id:"grade",type:"text",value:d,onChange:$,placeholder:`Ex: ${(l/2).toFixed(1)}`,className:`text-lg font-semibold ${p.grade?"border-red-500 focus:ring-red-500":""}`,disabled:f}),e.jsxs("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-sm text-slate-500",children:["/ ",l]})]}),p.grade&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:p.grade}),d&&!isNaN(parseFloat(d))&&e.jsx("div",{className:"mt-2",children:e.jsx("div",{className:"h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full transition-all ${parseFloat(d)>=l*.7?"bg-green-500":parseFloat(d)>=l*.5?"bg-yellow-500":"bg-red-500"}`,style:{width:`${Math.min(parseFloat(d)/l*100,100)}%`}})})})]}),e.jsxs("div",{children:[e.jsx(I,{htmlFor:"feedback",className:"text-sm font-semibold mb-2 block",children:"Feedback (opcional)"}),e.jsx("textarea",{id:"feedback",value:N,onChange:s=>g(s.target.value),placeholder:"Escreva um feedback para o aluno...",rows:6,disabled:f,className:`
              w-full px-3 py-2 rounded-lg border ${E.border.default}
              bg-white dark:bg-slate-900 ${E.text.primary}
              focus:ring-2 focus:ring-blue-500 focus:border-blue-500
              resize-none transition-all
            `}),e.jsxs("p",{className:"mt-1 text-xs text-slate-500 dark:text-slate-500",children:[N.length," caracteres"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(w,{type:"submit",disabled:f,className:"flex-1 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white",children:f?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"Salvando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Salvar Nota"]})}),j&&e.jsxs(w,{type:"button",variant:"outline",onClick:j,disabled:f,children:[e.jsx(Q,{className:"w-4 h-4 mr-2"}),"Cancelar"]})]})]})})},Ae=()=>{const{submissionId:l}=O(),h=H(),{toast:v}=z(),[S,j]=m.useState(!0),[f,d]=m.useState(!1),[t,N]=m.useState(null),[g,p]=m.useState(null),[u,_]=m.useState(null),[b,$]=m.useState([]),[s,c]=m.useState(0);m.useEffect(()=>{W()},[l]);const B=()=>{if(!t?.content)return e.jsx("p",{className:"text-slate-600 dark:text-slate-400",children:"Nenhum conte√∫do enviado."});if(typeof t.content=="string")return e.jsx("div",{className:"p-4 bg-slate-50 dark:bg-slate-950 rounded-lg",children:e.jsx("div",{style:{whiteSpace:"pre-wrap",wordBreak:"break-word",overflowWrap:"break-word",maxWidth:"100%",overflow:"hidden",fontFamily:"inherit",fontSize:"0.875rem",lineHeight:"1.5"},children:t.content})});try{const r=typeof t.content=="string"?JSON.parse(t.content):t.content,o=g?.content?.questions||[];return o.length===0?e.jsx("div",{className:"space-y-4",children:Object.entries(r).map(([a,x],i)=>e.jsx("div",{className:"p-4 bg-slate-50 dark:bg-slate-950 rounded-lg border border-slate-200 dark:border-slate-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-blue-600 dark:text-blue-300 font-bold flex-shrink-0",children:i+1}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"text-sm font-medium text-slate-900 dark:text-white mb-1",children:["Quest√£o ",i+1]}),e.jsxs("div",{className:"text-sm text-slate-700 dark:text-slate-300",style:{whiteSpace:"pre-wrap",wordBreak:"break-word",overflowWrap:"break-word",maxWidth:"100%",overflow:"hidden",lineHeight:"1.5"},children:[e.jsx("span",{className:"font-semibold",children:"Resposta: "}),Array.isArray(x)?x.join(", "):x]})]})]})},a))}):e.jsx("div",{className:"space-y-4",children:o.map((a,x)=>{const i=r[a.id],n=a.answerKey,C=n&&(Array.isArray(i)?i.length===n.length&&i.every(L=>n.includes(L)):i===n);return e.jsx("div",{className:`p-4 rounded-lg border-2 ${n?C?"bg-emerald-50 dark:bg-emerald-950/30 border-emerald-300 dark:border-emerald-800":"bg-red-50 dark:bg-red-950/30 border-red-300 dark:border-red-800":"bg-slate-50 dark:bg-slate-950 border-slate-200 dark:border-slate-800"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center font-bold flex-shrink-0 ${n?C?"bg-emerald-500 text-white":"bg-red-500 text-white":"bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300"}`,children:x+1}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-semibold text-slate-900 dark:text-white mb-2",children:a.title||a.label||`Quest√£o ${x+1}`}),e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"text-xs font-medium text-slate-600 dark:text-slate-400",children:"Resposta do aluno:"}),e.jsx("div",{className:"text-sm font-medium text-slate-900 dark:text-white mt-1",style:{whiteSpace:"pre-wrap",wordBreak:"break-word",overflowWrap:"break-word",maxWidth:"100%",overflow:"hidden",lineHeight:"1.5"},children:Array.isArray(i)?i.join(", "):i||"Sem resposta"})]}),n&&e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-slate-600 dark:text-slate-400",children:"Gabarito:"}),e.jsx("div",{className:"text-sm font-medium text-emerald-600 dark:text-emerald-400 mt-1",style:{whiteSpace:"pre-wrap",wordBreak:"break-word",overflowWrap:"break-word",maxWidth:"100%",overflow:"hidden",lineHeight:"1.5"},children:Array.isArray(n)?n.join(", "):n})]}),n&&e.jsx("div",{className:"mt-2",children:C?e.jsx(A,{className:"bg-emerald-500 text-white",children:"‚úì Correta"}):e.jsx(A,{className:"bg-red-500 text-white",children:"‚úó Incorreta"})})]})]})},a.id)})})}catch{return e.jsx("div",{className:"p-4 bg-slate-50 dark:bg-slate-950 rounded-lg",children:e.jsx("div",{style:{whiteSpace:"pre-wrap",wordBreak:"break-word",overflowWrap:"break-word",maxWidth:"100%",overflow:"auto",fontFamily:"monospace",fontSize:"0.875rem",lineHeight:"1.5"},children:JSON.stringify(t.content,null,2)})})}},W=async()=>{try{j(!0);const{data:r,error:o}=await k.from("submissions").select(`
          *,
          student:profiles!student_id(id, full_name, email, avatar_url),
          activity:activities!activity_id(id, title, max_score, due_date, content)
        `).eq("id",l).single();if(o){R.error("Erro ao carregar submiss√£o:",o),v({title:"Erro ao carregar submiss√£o",description:o?.message||"N√£o foi poss√≠vel encontrar esta submiss√£o.",variant:"destructive"}),h("/dashboard/activities");return}if(N(r),p(r.activity),r.activity_id){const{data:i}=await k.from("activity_class_assignments").select(`
            class_id,
            classes:class_id(id, name, subject)
          `).eq("activity_id",r.activity_id).single();i?.classes&&_(i.classes)}const{data:a,error:x}=await k.from("submissions").select("id, student_id, status").eq("activity_id",r.activity_id).order("submitted_at",{ascending:!0});if(!x){$(a||[]);const i=a?.findIndex(n=>n.id===l)??0;c(i)}}catch(r){v({title:"Erro ao carregar submiss√£o",description:r?.message||"Tente novamente.",variant:"destructive"})}finally{j(!1)}},D=async({grade:r,feedback:o})=>{try{d(!0);const{error:a}=await k.from("submissions").update({grade:r,feedback:o,status:"graded",graded_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",l);if(a)throw a;if(v({title:"‚úÖ Nota salva com sucesso!",description:"O feedback foi enviado ao aluno."}),s<b.length-1){const x=b[s+1];h(`/dashboard/grading/${x.id}`)}else h(`/dashboard/activities/${g?.id}/submissions`)}catch(a){v({title:"Erro ao salvar nota",description:a?.message||"Tente novamente em instantes.",variant:"destructive"})}finally{d(!1)}},F=r=>{const o=r==="prev"?s-1:s+1;if(o>=0&&o<b.length){const a=b[o];h(`/dashboard/grading/${a.id}`)}};return S?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(T,{size:"lg",text:"Carregando submiss√£o..."})}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 p-6",children:[e.jsxs(w,{variant:"ghost",onClick:()=>h(`/dashboard/activities/${g?.id}/submissions`),className:"mb-4",children:[e.jsx(U,{className:"w-4 h-4 mr-2"}),"Voltar para Submiss√µes"]}),e.jsx(P,{title:`Corrigir Submiss√£o${t?.student?.full_name?` - ${t.student.full_name}`:""}`,subtitle:`${g?.title||"Atividade"}${u?.name?` ‚Ä¢ Turma: ${u.name}`:""} ‚Ä¢ ${s+1} de ${b.length}`,role:"teacher"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs(y,{className:"p-6 bg-white dark:bg-slate-900",children:[e.jsxs("h3",{className:"text-lg font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2",children:[e.jsx(G,{className:"w-5 h-5"}),"Informa√ß√µes do Aluno"]}),e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[t?.student?.avatar_url?e.jsx("img",{src:t.student.avatar_url,alt:t.student.full_name,className:"w-16 h-16 rounded-full object-cover"}):e.jsx("div",{className:"w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-white text-2xl font-bold",children:t?.student?.full_name?.[0]||"A"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-slate-900 dark:text-white text-lg",children:t?.student?.full_name||"Aluno"}),e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400",children:t?.student?.email||"Sem email"}),u&&e.jsxs("p",{className:"text-sm font-medium text-blue-600 dark:text-blue-400 mt-1",children:["üè´ ",u.name," ",u.subject&&`- ${u.subject}`]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"Data de Envio:"}),e.jsx("p",{className:"font-semibold text-slate-900 dark:text-white",children:t?.submitted_at?new Date(t.submitted_at).toLocaleString("pt-BR"):"N√£o enviada"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"Status:"}),e.jsx("div",{className:"mt-1",children:e.jsx(A,{className:t?.status==="graded"?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300":"bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300",children:t?.status==="graded"?"Corrigida":"Pendente"})})]})]})]}),e.jsxs(y,{className:"p-6 bg-white dark:bg-slate-900",children:[e.jsxs("h3",{className:"text-lg font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2",children:[e.jsx(K,{className:"w-5 h-5"}),"Conte√∫do da Submiss√£o"]}),e.jsx("div",{className:"max-w-none",children:B()})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(X,{maxGrade:g?.max_score||10,initialGrade:t?.grade,initialFeedback:t?.feedback||"",onSave:D,onCancel:()=>h(`/dashboard/activities/${g?.id}/submissions`),loading:f}),e.jsx(y,{className:"p-4 bg-white dark:bg-slate-900",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(w,{variant:"outline",onClick:()=>F("prev"),disabled:s===0,children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"Anterior"]}),e.jsxs("span",{className:"text-sm text-slate-600 dark:text-slate-400",children:[s+1," de ",b.length]}),e.jsxs(w,{variant:"outline",onClick:()=>F("next"),disabled:s>=b.length-1,children:["Pr√≥xima",e.jsx(V,{className:"w-4 h-4 ml-2"})]})]})})]})]})]})};export{Ae as default};
