import{a as gt,u as vt,r as o,s as c,j as e,k as pt}from"./main-XRKQFEIr.js";import{C as _t}from"./card-BEk2G2Us.js";import{B as j}from"./button-D4bIZ4Ty.js";import{B as ht}from"./SidebarPremium-BnsbfpCV.js";import{S as ft,a as yt,b as bt,c as xt,d as y}from"./select-BDOb0ZK1.js";import{C as wt}from"./checkbox-DMTpvyPR.js";import"./tabs-D66ljSV7.js";import"./progress-DG81sUzt.js";import{D as St,g as h}from"./DashboardHeader-B78p6TYW.js";import{S as b}from"./StatsCard-D5ZQ3-Yq.js";import"./input-BrWaMOrb.js";import"./dropdown-menu-DyRCHyY4.js";import"./label-_ADcUmGf.js";import{u as Ct}from"./use-toast-Cv69gxoh.js";import{a as jt}from"./addDays-TIrBYM62.js";import{B as kt}from"./bell-v36tl0On.js";import{D as Dt}from"./download-DAXH3RrD.js";import{C as At}from"./index-e3XtT_BD.js";import{F as Et}from"./funnel-D6OloZPQ.js";import{U as Ft}from"./users-DP4-CTtE.js";import{C as Tt}from"./clipboard-list-zqwBk92M.js";import{C as Nt}from"./clock-BXvepPh_.js";import{C as Gt}from"./circle-alert-CmSW_OAP.js";import{T as Bt}from"./trending-up-eowzUgXK.js";import{C as Pt}from"./circle-check-big-CiCoaZWN.js";import{f as k}from"./format-CxHpq9RK.js";import"./book-open-CAn3t7Hm.js";import"./user-CCHLYTsx.js";import"./file-text-tq0U235S.js";import"./settings-pQ42cErW.js";import"./graduation-cap-CRbvieNe.js";import"./chart-column-CBFsA3dh.js";import"./x-BPPDjH10.js";import"./Combination-TYhCc4jv.js";import"./index-ysAnX8Hi.js";import"./index-B_kCUa_t.js";import"./chevron-down--5IVxs-k.js";import"./check-Cifhij8e.js";import"./chevron-up-Bc2ZkTy5.js";import"./chevron-right-C-DpTlMS.js";import"./en-US-azV9x4mt.js";function S(x,p,D){return jt(x,-p,D)}const Te=()=>{const{user:x}=gt(),{toast:p}=Ct();vt();const[D,B]=o.useState(!0),[f,P]=o.useState("30"),[n,M]=o.useState([]),[Q,V]=o.useState(["all"]),[W,H]=o.useState(["graded"]),[A,J]=o.useState(!1),[X,Mt]=o.useState(!0),[w,Y]=o.useState([]),[g,E]=o.useState({totalStudents:0,totalActivities:0,pendingCorrections:0,avgGrade:0,onTimeRate:0,openActivities:0}),[qt,Z]=o.useState([]),[It,q]=o.useState([]),[zt,I]=o.useState([]),[Rt,z]=o.useState([]),[Ot,F]=o.useState([]),[Ut,T]=o.useState(null),[$t,tt]=o.useState(null);o.useEffect(()=>{N()},[x,f,n,Q,W]),o.useEffect(()=>{let s;return A&&(s=setInterval(N,300*1e3)),()=>clearInterval(s)},[A]);const N=async()=>{if(x?.id){B(!0);try{if(await et(),X){const{data:s}=await c.auth.getSession(),a=s?.session?.access_token,i=await fetch("https://wapbwaimkurbuihatmix.supabase.co/functions/v1/get-teacher-analytics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({period:f,selectedClasses:n.length>0?n:w.map(d=>d.id)})});if(!i.ok)throw new Error("Erro ao carregar analytics");const t=await i.json(),r=t.data;E(r.kpis),F(r.topStudents||[]),await Promise.all([R(),O(),U(),$(),K(),L()]),t.cached&&p({title:"⚡ Cache",description:"Dados carregados do cache (5min)",duration:2e3})}else await Promise.all([st(),R(),O(),U(),$(),at(),K(),L()])}catch(s){console.error("Erro ao carregar analytics:",s),p({title:"Erro",description:"Não foi possível carregar os dados de analytics",variant:"destructive"})}finally{B(!1)}}},et=async()=>{const{data:s,error:a}=await c.from("classes").select("id, name, subject, color").eq("created_by",x.id).eq("is_active",!0);!a&&s&&(Y(s),n.length===0&&M(s.map(i=>i.id)))},st=async()=>{if(n.length===0){E({totalStudents:0,totalActivities:0,pendingCorrections:0,avgGrade:0,onTimeRate:0,openActivities:0});return}const s=f==="all"?null:k(S(new Date,parseInt(f)),"yyyy-MM-dd"),{data:a}=await c.from("class_members").select("user_id").in("class_id",n).eq("role","student"),i=new Set(a?.map(_=>_.user_id)||[]).size;let t=c.from("activity_class_assignments").select("activity_id, activities!inner(id, created_at, status)").in("class_id",n);s&&(t=t.gte("activities.created_at",s));const{data:r}=await t,d=new Set(r?.map(_=>_.activity_id)||[]).size,{data:l}=await c.from("submissions").select("id, activity_id, activities!inner(id, activity_class_assignments!inner(class_id))").eq("status","submitted").in("activities.activity_class_assignments.class_id",n),v=l?.length||0;let u=c.from("submissions").select("grade, activity_id, activities!inner(id, activity_class_assignments!inner(class_id))").not("grade","is",null).in("activities.activity_class_assignments.class_id",n);s&&(u=u.gte("graded_at",s));const{data:m}=await u,C=m?.length>0?(m.reduce((_,ut)=>_+(ut.grade||0),0)/m.length).toFixed(1):0,{data:G}=await c.from("submissions").select("submitted_at, activity_id, activities!inner(due_date, activity_class_assignments!inner(class_id))").eq("status","submitted").in("activities.activity_class_assignments.class_id",n).not("submitted_at","is",null).not("activities.due_date","is",null),lt=G?.filter(_=>new Date(_.submitted_at)<=new Date(_.activities.due_date)).length||0,ct=G?.length>0?Math.round(lt/G.length*100):0,{data:dt}=await c.from("activity_class_assignments").select("activity_id, activities!inner(status, due_date)").in("class_id",n).eq("activities.status","active").gte("activities.due_date",new Date().toISOString()),mt=dt?.length||0;E({totalStudents:i,totalActivities:d,pendingCorrections:v,avgGrade:parseFloat(C),onTimeRate:ct,openActivities:mt})},R=async()=>{const s=f==="all"?90:parseInt(f),a=k(S(new Date,s),"yyyy-MM-dd"),{data:i}=await c.from("submissions").select("grade, graded_at, activity_id, activities!inner(activity_class_assignments!inner(class_id))").not("grade","is",null).in("activities.activity_class_assignments.class_id",n).gte("graded_at",a).order("graded_at",{ascending:!0}),t={};i?.forEach(d=>{const l=k(new Date(d.graded_at),"dd/MM");t[l]||(t[l]=[]),t[l].push(d.grade)});const r=Object.entries(t).map(([d,l])=>({date:d,media:parseFloat((l.reduce((v,u)=>v+u,0)/l.length).toFixed(2)),submissoes:l.length}));Z(r.slice(-30))},O=async()=>{if(n.length===0){q([]);return}const{data:s}=await c.from("submissions").select("grade, activity_id, activities!inner(activity_class_assignments!inner(class_id))").not("grade","is",null).in("activities.activity_class_assignments.class_id",n),a=[];for(const i of w.filter(t=>n.includes(t.id))){const t=s?.filter(v=>v.activities?.activity_class_assignments?.some(u=>u.class_id===i.id))||[],r=t.length>0?t.reduce((v,u)=>v+u.grade,0)/t.length:0;a.push({name:i.name,media:parseFloat(r.toFixed(2)),alunos:0,atividades:0,color:i.color||"#3B82F6"})}q(a.sort((i,t)=>t.media-i.media))},U=async()=>{if(n.length===0){I([]);return}const{data:s}=await c.from("submissions").select("grade, activity_id, activities!inner(activity_class_assignments!inner(class_id))").not("grade","is",null).in("activities.activity_class_assignments.class_id",n).limit(1e3),a=[{range:"0-2",count:0,color:"#EF4444"},{range:"2-4",count:0,color:"#F97316"},{range:"4-6",count:0,color:"#F59E0B"},{range:"6-8",count:0,color:"#3B82F6"},{range:"8-10",count:0,color:"#10B981"}];s?.forEach(({grade:i})=>{i<2?a[0].count++:i<4?a[1].count++:i<6?a[2].count++:i<8?a[3].count++:a[4].count++}),I(a)},$=async()=>{if(n.length===0){z([]);return}const s=k(S(new Date,84),"yyyy-MM-dd"),{data:a}=await c.from("submissions").select("submitted_at, activity_id, activities!inner(due_date, activity_class_assignments!inner(class_id))").eq("status","submitted").in("activities.activity_class_assignments.class_id",n).gte("submitted_at",s).limit(1e3),i=[];for(let t=0;t<12;t++){const r=S(new Date,(12-t)*7),d=S(new Date,(11-t)*7),l=a?.filter(m=>{const C=new Date(m.submitted_at);return C>=r&&C<=d})||[],v=l.filter(m=>m.activities?.due_date&&new Date(m.submitted_at)<=new Date(m.activities.due_date)).length,u=l.filter(m=>m.activities?.due_date&&new Date(m.submitted_at)>new Date(m.activities.due_date)).length;i.push({week:`S${12-t}`,noPrazo:v,atrasadas:u,total:l.length})}z(i)},at=async()=>{if(n.length===0){F([]);return}const{data:s}=await c.from("submissions").select(`
        grade,
        student_id,
        student:profiles!submissions_student_id_fkey(id, full_name, avatar_url),
        activity_id,
        activities!inner(activity_class_assignments!inner(class_id))
      `).not("grade","is",null).in("activities.activity_class_assignments.class_id",n).limit(500),a={};s?.forEach(t=>{a[t.student_id]||(a[t.student_id]={student:t.student,grades:[],total:0}),a[t.student_id].grades.push(t.grade),a[t.student_id].total++});const i=Object.entries(a).map(([t,r])=>({id:t,name:r.student?.full_name||"Sem nome",avatar:r.student?.avatar_url,avgGrade:r.grades.reduce((d,l)=>d+l,0)/r.grades.length,activities:r.total})).sort((t,r)=>r.avgGrade-t.avgGrade).slice(0,10);F(i)},K=async()=>{if(n.length===0){T(null);return}const{data:s}=await c.from("plagiarism_checks").select(`
        plagiarism_percentage,
        ai_generated,
        submission_id,
        submissions!inner(activity_id, activities!inner(activity_class_assignments!inner(class_id)))
      `).in("submissions.activities.activity_class_assignments.class_id",n).limit(500);if(!s||s.length===0){T(null);return}const a=s.reduce((t,r)=>t+(100-(r.plagiarism_percentage||0)),0)/s.length,i=s.filter(t=>100-t.plagiarism_percentage<70).length;T({avgOriginality:Math.round(a),totalChecks:s.length,casesDetected:i,aiDetected:s.filter(t=>t.ai_generated).length})},L=async()=>{tt({uniqueAccess:0,avgSessionTime:0,returnRate:0,interactions:0})},it=()=>{p({title:"Em desenvolvimento",description:"Exportação de dashboard será implementada em breve"})},nt=()=>{p({title:"Em desenvolvimento",description:"Configuração de alertas será implementada em breve"})},rt=()=>{N(),p({title:"Filtros aplicados"})},ot=()=>{P("30"),M(w.map(s=>s.id)),V(["all"]),H(["graded"]),p({title:"Filtros limpos"})};return D?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(pt,{size:"lg"})}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 p-6",children:[e.jsx(St,{title:"Analytics e Insights",subtitle:"Análise completa de desempenho e tendências",role:"teacher",actions:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(j,{variant:"outline",onClick:nt,children:[e.jsx(kt,{className:"w-4 h-4 mr-2"}),"Configurar Alertas"]}),e.jsxs(j,{variant:"outline",onClick:it,children:[e.jsx(Dt,{className:"w-4 h-4 mr-2"}),"Exportar Dashboard"]})]})}),e.jsxs(_t,{className:"p-6 mb-6 sticky top-0 z-10 bg-white dark:bg-slate-900 shadow-lg",children:[e.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-[200px]",children:[e.jsxs("label",{className:"block text-sm font-medium mb-2",children:[e.jsx(At,{className:"w-4 h-4 inline mr-2"}),"Período"]}),e.jsxs(ft,{value:f,onValueChange:P,children:[e.jsx(yt,{children:e.jsx(bt,{})}),e.jsxs(xt,{children:[e.jsx(y,{value:"7",children:"Últimos 7 dias"}),e.jsx(y,{value:"15",children:"Últimos 15 dias"}),e.jsx(y,{value:"30",children:"Últimos 30 dias"}),e.jsx(y,{value:"60",children:"Últimos 60 dias"}),e.jsx(y,{value:"90",children:"Últimos 90 dias"}),e.jsx(y,{value:"180",children:"Últimos 180 dias"}),e.jsx(y,{value:"all",children:"Todo o Período"})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(j,{onClick:rt,children:[e.jsx(Et,{className:"w-4 h-4 mr-2"}),"Aplicar Filtros"]}),e.jsx(j,{variant:"outline",onClick:ot,children:"Limpar"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(wt,{checked:A,onCheckedChange:J,id:"auto-refresh"}),e.jsx("label",{htmlFor:"auto-refresh",className:"text-sm cursor-pointer",children:"Auto-atualizar (5min)"})]})]}),n.length<w.length&&e.jsxs(ht,{className:"mt-3",children:[n.length," de ",w.length," turmas selecionadas"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-8",children:[e.jsx(b,{title:"Total de Alunos",value:g.totalStudents,icon:Ft,gradient:h.primary,bgColor:"bg-blue-50 dark:bg-blue-950/30"}),e.jsx(b,{title:"Atividades Postadas",value:g.totalActivities,icon:Tt,gradient:h.info,bgColor:"bg-cyan-50 dark:bg-cyan-950/30"}),e.jsx(b,{title:"Atividades Abertas",value:g.openActivities,icon:Nt,gradient:h.warning,bgColor:"bg-yellow-50 dark:bg-yellow-950/30"}),e.jsx(b,{title:"Aguardando Correção",value:g.pendingCorrections,icon:Gt,gradient:h.danger,bgColor:"bg-red-50 dark:bg-red-950/30"}),e.jsx(b,{title:"Nota Média Geral",value:g.avgGrade.toFixed(1),icon:Bt,gradient:g.avgGrade>=7?h.success:g.avgGrade>=5?h.warning:h.danger,bgColor:g.avgGrade>=7?"bg-green-50 dark:bg-green-950/30":"bg-yellow-50 dark:bg-yellow-950/30"}),e.jsx(b,{title:"Taxa Entrega no Prazo",value:`${g.onTimeRate}%`,icon:Pt,gradient:h.success,bgColor:"bg-green-50 dark:bg-green-950/30"})]}),e.jsx("div",{className:"text-center py-12 text-slate-500",children:e.jsx("p",{className:"text-sm",children:"Demais seções em implementação..."})})]})};export{Te as default};
