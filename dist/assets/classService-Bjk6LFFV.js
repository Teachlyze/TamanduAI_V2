import{s as o,l as c}from"./main-xLo6udtn.js";const P=async i=>{try{const{data:e,error:a}=await o.functions.invoke("process-notifications",{body:{notifications:i}});if(a)throw c.error("Erro na Edge Function process-notifications:",a),a;return e}catch(e){throw c.error("Erro ao processar notifica√ß√µes em lote:",e),e}},U=async(i,e)=>{try{const{data:a,error:t}=await o.from("notifications").insert({user_id:i,type:e.type,title:e.title,message:e.message,data:e.data||{},read:!1,created_at:new Date().toISOString()}).select().single();if(t)throw c.error("Erro ao criar notifica√ß√£o:",t),t;return a}catch(a){throw c.error("Erro ao criar notifica√ß√£o:",a),a}};class y{static NotificationType=Object.freeze({EVENT:"event",ASSIGNMENT:"assignment",ANNOUNCEMENT:"announcement",SYSTEM:"system",FEEDBACK:"feedback",REMINDER:"reminder"});static NotificationPriority=Object.freeze({LOW:"low",NORMAL:"normal",HIGH:"high",URGENT:"urgent"});static NotificationCategory=Object.freeze({SYSTEM_UPDATE:"system_update",ACCOUNT:"account",COURSE:"course",ASSIGNMENT:"assignment",EXAM:"exam",GRADE:"grade",MENTION:"mention",COMMENT:"comment",MESSAGE:"message",ANNOUNCEMENT:"announcement",REMINDER:"reminder",ALERT:"alert",PLAGIARISM_ALERT:"plagiarism_alert",AI_DETECTION:"ai_detection"});static async sendNotificationsBatch(e){try{return await P(e)}catch(a){throw c.error("Error sending notifications in batch:",a),a}}static NotificationStatus=Object.freeze({UNREAD:"unread",READ:"read",ARCHIVED:"archived"});static sleep=e=>new Promise(a=>setTimeout(a,e));static withRetry=async(e,a=3)=>{for(let t=0;t<a;t++)try{return await e()}catch(r){if(t===a-1)throw r;await y.sleep(1e3*(t+1))}};static async getNotifications({unreadOnly:e=!1,limit:a=50,offset:t=0,type:r=null,category:s=null}={}){const{data:n,error:l}=await o.auth.getUser();if(l)throw l;const g=n.user?.id;if(!g)throw new Error("No user is currently signed in");let m=o.from("notifications").select("*").eq("user_id",g).order("created_at",{ascending:!1}).range(t,t+a-1);e&&(m=m.eq("is_read",!1)),r&&(m=m.eq("type",r)),s&&(m=m.eq("category",s));const{data:h,error:v}=await m;if(v)throw v;return h||[]}static async markAsRead(e,{userId:a}={}){const t=Array.isArray(e)?e:[e];try{let r=o.from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).in("id",t);a&&(r=r.eq("user_id",a));const{data:s,error:n}=await r;if(n)throw n;return{success:!0,message:"Notifications marked as read successfully",affected:s?.length||0}}catch(r){return c.error("Error marking notifications as read:",r),{success:!1,message:r.message,affected:0}}}static async markAllAsRead(){const{error:e}=await o.from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("is_read",!1);if(e)throw e;return!0}static async deleteNotification(e,{userId:a}={}){const t=Array.isArray(e)?e:[e];try{let r=o.from("notifications").delete().in("id",t);a&&(r=r.eq("user_id",a));const{data:s,error:n}=await r;if(n)throw n;return{success:!0,message:"Notifications deleted successfully",deleted:s?.length||0}}catch(r){return c.error("Error deleting notifications:",r),{success:!1,message:r.message,deleted:0}}}static async sendNotification({title:e,message:a,type:t,category:r,priority:s=y.NotificationPriority.NORMAL,referenceId:n,referenceType:l,actionUrl:g,metadata:m={}},h=null){if(!Object.values(y.NotificationType).includes(t))throw new Error(`Invalid notification type: ${t}`);if(s&&!Object.values(y.NotificationPriority).includes(s))throw new Error(`Invalid priority: ${s}`);if(!h){const{data:w,error:b}=await o.auth.getUser();if(b)throw b;if(h=w.user?.id,!h)throw new Error("No user is currently signed in")}const v={type:t,title:e,message:a,data:{category:r||null,priority:s,referenceId:n||null,referenceType:l||null,actionUrl:g||null,...m}};try{return await U(h,v)}catch(w){c.error("Error using Edge Function, falling back to direct insert:",w);const{data:b,error:E}=await o.from("notifications").insert({...v,user_id:h,created_at:new Date().toISOString()}).select().single();if(E)throw E;return b}}static async getUnreadCount(){const{data:e,error:a}=await o.auth.getUser();if(a)throw a;const t=e.user?.id;if(!t)return 0;const{data:r,error:s}=await o.from("notifications").select("id").eq("user_id",t).eq("is_read",!1).range(0,999);if(s)throw s;return r?.length||0}static async subscribeToNotifications(e){const{data:{user:a}}=await o.auth.getUser(),t=a?.id;if(!t)return{unsubscribe:()=>{}};const r=o.channel("notifications").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${t}`},s=>{typeof e=="function"&&e(s.new)}).subscribe();return{unsubscribe:()=>{try{o.removeChannel(r)}catch{}}}}async subscribeToNotifications(e){return await y.subscribeToNotifications(e)}async getNotifications(e={}){return{data:await y.getNotifications(e)}}async markAsRead(e,a={}){return await y.markAsRead(e,a)}async deleteNotification(e,a={}){return await y.deleteNotification(e,a)}async markAllAsRead(){return await y.markAllAsRead()}async getUnreadCount(){return await y.getUnreadCount()}async sendNotification(e,a=null){return await y.sendNotification(e,a)}static async sendCorrectionNotification({submissionId:e,studentId:a,activityTitle:t,grade:r,maxScore:s}){try{const g=await fetch("https://wapbwaimkurbuihatmix.supabase.co/functions/v1/send-correction-notification",{method:"POST",headers:{Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhcGJ3YWlta3VyYnVpaGF0bWl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODY3MjksImV4cCI6MjA3NDg2MjcyOX0.x-NQQ2TtRgaUjjBZCf6j49eWOW4XSqjTFKC_KB1L56A","Content-Type":"application/json"},body:JSON.stringify({submissionId:e,studentId:a,activityTitle:t,grade:r,maxScore:s})});if(!g.ok){const h=await g.json();throw new Error(h.error||"Erro ao enviar notifica√ß√£o")}return{data:await g.json(),error:null}}catch(n){c.error("Erro ao enviar notifica√ß√£o de corre√ß√£o:",n);try{return await y.sendNotification({title:"Atividade Corrigida",message:`Sua atividade "${t}" foi corrigida. Nota: ${r}/${s}`,type:y.NotificationType.FEEDBACK,category:y.NotificationCategory.GRADE,priority:y.NotificationPriority.HIGH,referenceId:e,referenceType:"submission",metadata:{grade:r,maxScore:s,activityTitle:t}},a),{data:{notificationSent:!0,emailSent:!1},error:null}}catch(l){return{data:null,error:l}}}}}const D=new y,_={async sendEmail({to:i,subject:e,html:a,text:t,from:r}){if(!i||!e||!a&&!t)return{success:!1,error:"Missing required fields: to, subject, and html or text"};const{data:s,error:n}=await o.functions.invoke("send-email",{body:{to:i,subject:e,html:a,text:t,from:r}});return n?(c.error("EmailService.sendEmail error:",n),{success:!1,error:n.message||"invoke failed"}):{success:!!s?.success,emailId:s?.emailId,error:s?.error}},render(i="",e={}){return String(i).replace(/{{\s*([\w.]+)\s*}}/g,(a,t)=>t.split(".").reduce((s,n)=>s&&s[n]!==void 0?s[n]:"",e)??"")}};class q{static async send(e,a={}){const{to:t,variables:r={},language:s="pt",from:n,replyTo:l,attachments:g,tracking:m=!1}=a;if(!t)return{success:!1,error:"Recipient email is required"};if(!e)return{success:!1,error:"Template ID is required"};try{const{data:h,error:v}=await o.functions.invoke("send-email-v2",{body:{templateId:e,to:t,variables:r,language:s,from:n,replyTo:l,attachments:g,tracking:m}});return v?(c.error("EmailTemplateService.send error:",v),{success:!1,error:v.message||"Failed to send email"}):{success:h?.success||!1,emailId:h?.emailId,template:h?.template,error:h?.error}}catch(h){return c.error("EmailTemplateService.send exception:",h),{success:!1,error:h.message||"Unexpected error"}}}static async sendWelcome({to:e,userName:a,confirmationUrl:t,language:r="pt"}){return this.send("welcome",{to:e,variables:{userName:a,confirmationUrl:t},language:r})}static async sendLoginNewDevice({to:e,device:a,time:t,location:r,language:s="pt"}){return this.send("login-new-device",{to:e,variables:{device:a,time:t,location:r},language:s})}static async sendPasswordRecovery({to:e,userName:a,resetUrl:t,language:r="pt"}){return this.send("password-recovery",{to:e,variables:{userName:a,resetUrl:t},language:r})}static async sendPasswordChanged({to:e,time:a,language:t="pt"}){return this.send("password-changed",{to:e,variables:{time:a},language:t})}static async sendAccountConfirmed({to:e,userName:a,dashboardUrl:t,language:r="pt"}){return this.send("account-confirmed",{to:e,variables:{userName:a,dashboardUrl:t},language:r})}static async sendClassInvite({to:e,className:a,teacherName:t,acceptUrl:r,language:s="pt"}){return this.send("class-invite",{to:e,variables:{className:a,teacherName:t,acceptUrl:r},language:s})}static async sendClassInviteAccepted({to:e,studentName:a,className:t,time:r,language:s="pt"}){return this.send("class-invite-accepted",{to:e,variables:{studentName:a,className:t,time:r},language:s})}static async sendStudentAdded({to:e,studentName:a,className:t,teacherName:r,classUrl:s,language:n="pt"}){return this.send("student-added",{to:e,variables:{studentName:a,className:t,teacherName:r,classUrl:s},language:n})}static async sendStudentRemoved({to:e,className:a,time:t,language:r="pt"}){return this.send("student-removed",{to:e,variables:{className:a,time:t},language:r})}static async sendClassCreated({to:e,className:a,classCode:t,classUrl:r,language:s="pt"}){return this.send("class-created",{to:e,variables:{className:a,classCode:t,classUrl:r},language:s})}static async sendNewActivity({to:e,studentName:a,className:t,activityName:r,deadline:s,points:n,activityUrl:l,language:g="pt"}){return this.send("new-activity",{to:e,variables:{studentName:a,className:t,activityName:r,deadline:s,points:n,activityUrl:l},language:g})}static async sendDeadlineWarning({to:e,activityName:a,deadline:t,timeLeft:r,activityUrl:s,language:n="pt"}){return this.send("deadline-warning",{to:e,variables:{activityName:a,deadline:t,timeLeft:r,activityUrl:s},language:n})}static async sendActivityCorrected({to:e,activityName:a,grade:t,maxGrade:r,viewUrl:s,language:n="pt"}){return this.send("activity-corrected",{to:e,variables:{activityName:a,grade:t,maxGrade:r,viewUrl:s},language:n})}static async sendPlagiarismAlert({to:e,studentName:a,activityName:t,percentage:r,severity:s,reviewUrl:n,language:l="pt"}){return this.send("plagiarism-alert",{to:e,variables:{studentName:a,activityName:t,percentage:r,severity:s,reviewUrl:n},language:l})}static async sendMonthlyReport({to:e,userName:a,monthYear:t,activitiesCount:r,averageGrade:s,completionRate:n,reportUrl:l,language:g="pt"}){return this.send("monthly-report",{to:e,variables:{userName:a,monthYear:t,activitiesCount:r,averageGrade:s,completionRate:n,reportUrl:l},language:g})}static async preview(e,a={},t="pt"){return{templateId:e,variables:a,language:t,note:"Preview functionality - implement preview endpoint if needed"}}static getAvailableTemplates(){return[{id:"welcome",category:"auth",name:"Welcome Email"},{id:"login-new-device",category:"auth",name:"New Device Login"},{id:"password-recovery",category:"auth",name:"Password Recovery"},{id:"password-changed",category:"auth",name:"Password Changed"},{id:"account-confirmed",category:"auth",name:"Account Confirmed"},{id:"class-invite",category:"classes",name:"Class Invitation"},{id:"class-invite-accepted",category:"classes",name:"Invite Accepted"},{id:"student-added",category:"classes",name:"Student Added"},{id:"student-removed",category:"classes",name:"Student Removed"},{id:"class-created",category:"classes",name:"Class Created"},{id:"new-activity",category:"activities",name:"New Activity"},{id:"deadline-warning",category:"activities",name:"Deadline Warning"},{id:"activity-corrected",category:"activities",name:"Activity Corrected"},{id:"plagiarism-alert",category:"system",name:"Plagiarism Alert"},{id:"monthly-report",category:"system",name:"Monthly Report"}]}static async getLogs(e={}){const{limit:a=50,offset:t=0,templateId:r,status:s}=e;let n=o.from("email_logs").select("*").order("sent_at",{ascending:!1}).range(t,t+a-1);r&&(n=n.eq("template_id",r)),s&&(n=n.eq("status",s));const{data:l,error:g}=await n;return g?(c.error("Failed to fetch email logs:",g),{success:!1,error:g.message}):{success:!0,data:l}}static async getStatistics(e="30days"){try{const{data:a,error:t}=await o.rpc("get_email_statistics",{period_days:e==="7days"?7:e==="30days"?30:90});if(t)throw t;return{success:!0,data:a}}catch(a){return c.error("Failed to fetch email statistics:",a),{success:!1,error:a.message}}}}const u={AUTHENTICATION:"authentication",ACTIVITY:"activity",CORRECTION:"correction",PLAGIARISM:"plagiarism",SYSTEM:"system",CHATBOT:"chatbot",ANALYTICS:"analytics",GAMIFICATION:"gamification",FEEDBACK:"feedback",MEETING:"meeting",LIVE_CLASS:"live_class"},p={CRITICAL:"critical",HIGH:"high",MEDIUM:"medium",LOW:"low"},d={EMAIL:"email",PUSH:"push",BOTH:"both"},I={critical:{channels:["email","push"],retries:3,delay:0},high:{channels:["email","push"],retries:2,delay:0},medium:{channels:["push"],retries:1,delay:300},low:{channels:["push"],retries:0,delay:1800}};function L(i,e){return e===d.BOTH?["email","push"]:e===d.EMAIL?["email"]:e===d.PUSH?["push"]:(I[String(i||"").toLowerCase()]||I.medium).channels}const j={accountCreated:{id:"accountCreated",type:u.AUTHENTICATION,channel:d.EMAIL,priority:p.CRITICAL,title:"Conta criada com sucesso! üéâ",message:"Bem-vindo(a) ao TamanduAI! Confirme seu email para come√ßar.",emailSubject:"Bem-vindo(a) ao TamanduAI! Confirme seu email",emailHtml:`
      <h2>Bem-vindo(a) ao TamanduAI! üéì</h2>
      <p>Ol√° <strong>{{userName}}</strong>, sua conta foi criada com sucesso.</p>
      <p>Clique no bot√£o para confirmar seu email:</p>
      <p><a href="{{confirmationUrl}}">Confirmar Email</a></p>
      <small>Este link expira em 24 horas.</small>
    `,variables:["userName","confirmationUrl"]},loginNewDevice:{id:"loginNewDevice",type:u.SYSTEM,channel:d.EMAIL,priority:p.MEDIUM,title:"Novo acesso detectado",message:"Login realizado em {device} √†s {time}. Foi voc√™?",emailSubject:"Novo acesso detectado",emailHtml:"<h2>Novo acesso detectado</h2><p>Dispositivo: {{device}} √†s {{time}}</p>",variables:["device","time"]},passwordRecoveryRequested:{id:"passwordRecoveryRequested",type:u.AUTHENTICATION,channel:d.EMAIL,priority:p.CRITICAL,title:"Recupera√ß√£o de senha solicitada",message:"Use o c√≥digo enviado para redefinir sua senha.",emailSubject:"Recupera√ß√£o de senha",emailHtml:"<h2>Recupera√ß√£o de senha</h2><p>Ol√° {{userName}}, utilize o c√≥digo enviado para redefinir sua senha.</p>",variables:["userName"]},passwordChanged:{id:"passwordChanged",type:u.AUTHENTICATION,channel:d.BOTH,priority:p.HIGH,title:"Senha alterada",message:"Sua senha foi alterada com sucesso √†s {time}.",emailSubject:"Senha alterada com sucesso",emailHtml:"<h2>Senha alterada</h2><p>Sua senha foi alterada √†s {{time}}</p>",variables:["time"]},profileCompleted:{id:"profileCompleted",type:u.SYSTEM,channel:d.PUSH,priority:p.MEDIUM,title:"Perfil completo!",message:"Agora voc√™ pode explorar todas as funcionalidades.",variables:[]},classInviteSent:{id:"classInviteSent",type:u.SYSTEM,channel:d.EMAIL,priority:p.HIGH,title:"Convite para turma",message:"Voc√™ foi convidado(a) para a turma {{className}}",emailSubject:"Convite para a turma {{className}}",emailHtml:'<h2>Convite para turma</h2><p>Voc√™ foi convidado(a) para a turma <strong>{{className}}</strong>.</p><p>Clique para aceitar: <a href="{{acceptUrl}}">Aceitar convite</a></p>',variables:["className","acceptUrl"]},classInviteAccepted:{id:"classInviteAccepted",type:u.SYSTEM,channel:d.PUSH,priority:p.MEDIUM,title:"Convite aceito",message:"{{studentName}} entrou na turma {{className}}",variables:["studentName","className"]},studentAddedToClass:{id:"studentAddedToClass",type:u.SYSTEM,channel:d.PUSH,priority:p.MEDIUM,title:"Aluno adicionado",message:"{{studentName}} foi adicionado na turma {{className}}",variables:["studentName","className"]},studentRemovedFromClass:{id:"studentRemovedFromClass",type:u.SYSTEM,channel:d.BOTH,priority:p.HIGH,title:"Voc√™ foi removido da turma",message:"Turma: {{className}}",emailSubject:"Remo√ß√£o da turma {{className}}",emailHtml:"<h2>Remo√ß√£o da turma</h2><p>Voc√™ foi removido da turma {{className}}</p>",variables:["className"]},classCreated:{id:"classCreated",type:u.SYSTEM,channel:d.PUSH,priority:p.LOW,title:"Nova turma criada",message:"{{className}} foi criada com sucesso",variables:["className"]},accountConfirmed:{id:"accountConfirmed",type:u.AUTHENTICATION,channel:d.BOTH,priority:p.HIGH,title:"Email confirmado! ‚úÖ",message:"Sua conta est√° ativa. Complete seu perfil para come√ßar.",emailSubject:"Sua conta foi confirmada",emailHtml:`
      <h2>Conta confirmada</h2>
      <p>Ol√° <strong>{{userName}}</strong>, sua conta foi confirmada com sucesso.</p>
    `,variables:["userName"]},newActivity:{id:"newActivity",type:u.ACTIVITY,channel:d.BOTH,priority:p.HIGH,title:"Nova atividade: {{activityName}}",message:"Prazo: {{deadline}} ‚Ä¢ Pontua√ß√£o: {{points}} pts",emailSubject:"Nova atividade em {{className}}: {{activityName}}",emailHtml:`
      <h2>üìù Nova Atividade Dispon√≠vel</h2>
      <p>Ol√° <strong>{{studentName}}</strong>,</p>
      <p>Uma nova atividade foi publicada na turma <strong>{{className}}</strong>:</p>
      <p><strong>{{activityName}}</strong></p>
      <p>Prazo: {{deadline}} | Pontos: {{points}}</p>
      <p><a href="{{activityUrl}}">Ver Atividade</a></p>
    `,variables:["studentName","className","activityName","deadline","points","activityUrl"]},deadlineWarning24h:{id:"deadlineWarning24h",type:u.ACTIVITY,channel:d.BOTH,priority:p.CRITICAL,title:"‚è∞ Prazo em 24 horas!",message:"{{activityName}} vence amanh√£ √†s {{time}}",emailSubject:"Lembrete: {{activityName}} vence em 24 horas",emailHtml:`
      <h2>‚è∞ Prazo em 24 horas</h2>
      <p>Atividade: {{activityName}}</p>
      <p>Vence em: {{deadline}}</p>
      <p><a href="{{activityUrl}}">Entregar agora</a></p>
    `,variables:["activityName","deadline","time","activityUrl"]},activityCorrected:{id:"activityCorrected",type:u.CORRECTION,channel:d.BOTH,priority:p.HIGH,title:"Atividade corrigida! üéâ",message:"{{activityName}} ‚Ä¢ Nota: {{grade}}/{{maxGrade}}",emailSubject:"Corre√ß√£o dispon√≠vel: {{activityName}}",emailHtml:`
      <h2>‚úÖ Atividade Corrigida</h2>
      <p>{{activityName}} ‚Äî Nota: {{grade}}/{{maxGrade}}</p>
      <p><a href="{{viewUrl}}">Ver detalhes</a></p>
    `,variables:["activityName","grade","maxGrade","viewUrl"]},plagiarismDetected:{id:"plagiarismDetected",type:u.PLAGIARISM,channel:d.EMAIL,priority:p.CRITICAL,title:"üö® Pl√°gio detectado",message:"{{studentName}} ‚Ä¢ {{percentage}}% similaridade ‚Ä¢ {{activityName}}",emailSubject:"Alerta de Pl√°gio: {{activityName}}",emailHtml:`
      <h2>üö® Alerta de Pl√°gio</h2>
      <p>Aluno: {{studentName}}</p>
      <p>Atividade: {{activityName}}</p>
      <p>Similaridade: {{percentage}}%</p>
      <p><a href="{{reviewUrl}}">Revisar submiss√£o</a></p>
    `,variables:["studentName","activityName","percentage","reviewUrl"]},analysisStarted:{id:"analysisStarted",type:u.PLAGIARISM,channel:d.PUSH,priority:p.LOW,title:"An√°lise anti-pl√°gio iniciada",message:"Verificando {{activityName}}..."},falsePositiveMarked:{id:"falsePositiveMarked",type:u.PLAGIARISM,channel:d.PUSH,priority:p.LOW,title:"Falso positivo marcado",message:"An√°lise de pl√°gio atualizada para {{activityName}}"},chatbotTrainingComplete:{id:"chatbotTrainingComplete",type:u.CHATBOT,channel:d.PUSH,priority:p.MEDIUM,title:"Chatbot treinado com sucesso!",message:"Base atualizada com {{filesCount}} arquivos",variables:["filesCount"]},chatbotTrainingError:{id:"chatbotTrainingError",type:u.CHATBOT,channel:d.PUSH,priority:p.HIGH,title:"Erro no treinamento",message:"Falha ao processar {{fileName}}",variables:["fileName"]},newMaterialProcessed:{id:"newMaterialProcessed",type:u.CHATBOT,channel:d.PUSH,priority:p.LOW,title:"Material processado",message:"{{fileName}} adicionado √† base",variables:["fileName"]},outOfScopeInteraction:{id:"outOfScopeInteraction",type:u.CHATBOT,channel:d.PUSH,priority:p.LOW,title:"Pergunta fora do escopo",message:"Aluno perguntou sobre: {{topic}}",variables:["topic"]},monthlyReportGenerated:{id:"monthlyReportGenerated",type:u.ANALYTICS,channel:d.EMAIL,priority:p.MEDIUM,title:"Relat√≥rio mensal gerado",message:"Seu relat√≥rio de {{monthYear}} est√° pronto",emailSubject:"Relat√≥rio mensal - {{monthYear}}",emailHtml:"<h2>Relat√≥rio mensal</h2><p>Seu relat√≥rio de {{monthYear}} est√° pronto.</p>",variables:["monthYear"]},performanceGoalAchieved:{id:"performanceGoalAchieved",type:u.ANALYTICS,channel:d.BOTH,priority:p.MEDIUM,title:"Meta de desempenho atingida",message:"Parab√©ns! Voc√™ atingiu sua meta",emailSubject:"Meta de desempenho atingida",emailHtml:"<h2>Meta de desempenho atingida</h2><p>Parab√©ns!</p>",variables:[]},lowPerformanceDetected:{id:"lowPerformanceDetected",type:u.ANALYTICS,channel:d.EMAIL,priority:p.HIGH,title:"Baixo desempenho detectado",message:"Identificamos baixo desempenho em {{subject}}",emailSubject:"Baixo desempenho detectado",emailHtml:"<h2>Baixo desempenho detectado</h2><p>√Årea: {{subject}}</p>",variables:["subject"]},classReportAvailable:{id:"classReportAvailable",type:u.ANALYTICS,channel:d.PUSH,priority:p.LOW,title:"Relat√≥rio de turma dispon√≠vel",message:"O relat√≥rio da turma {{className}} est√° dispon√≠vel",variables:["className"]},xpEarned:{id:"xpEarned",type:u.GAMIFICATION,channel:d.PUSH,priority:p.LOW,title:"üåü +{{xp}} XP ganho!",message:"{{reason}} ‚Ä¢ Total: {{totalXP}} XP",variables:["xp","reason","totalXP"]},badgeEarned:{id:"badgeEarned",type:u.GAMIFICATION,channel:d.BOTH,priority:p.MEDIUM,title:"üèÜ Nova badge desbloqueada!",message:"{{badgeName}} - {{badgeDescription}}",emailSubject:"Voc√™ desbloqueou: {{badgeName}}",emailHtml:`
      <h2>üèÜ Nova Badge Desbloqueada!</h2>
      <p><strong>{{badgeName}}</strong></p>
      <p>{{badgeDescription}}</p>
      <p><a href="{{profileUrl}}">Ver seu perfil</a></p>
    `,variables:["badgeName","badgeDescription","profileUrl"]},levelUp:{id:"levelUp",type:u.GAMIFICATION,channel:d.BOTH,priority:p.HIGH,title:"üéâ Level Up! N√≠vel {{level}}",message:"Parab√©ns! Voc√™ alcan√ßou o n√≠vel {{level}}!",emailSubject:"Parab√©ns! Voc√™ subiu para o n√≠vel {{level}}",emailHtml:`
      <h2>üéâ Level Up!</h2>
      <p>Parab√©ns! Voc√™ alcan√ßou o <strong>n√≠vel {{level}}</strong>!</p>
      <p>Continue assim e desbloqueie novas conquistas.</p>
    `,variables:["level"]},feedbackReceived:{id:"feedbackReceived",type:u.FEEDBACK,channel:d.BOTH,priority:p.HIGH,title:"üí¨ Novo feedback do professor",message:"{{teacherName}} comentou em {{activityName}}",emailSubject:"Feedback em {{activityName}}",emailHtml:`
      <h2>üí¨ Novo Feedback</h2>
      <p>Professor(a) <strong>{{teacherName}}</strong> deixou um coment√°rio em <strong>{{activityName}}</strong></p>
      <p><a href="{{viewUrl}}">Ver feedback</a></p>
    `,variables:["teacherName","activityName","viewUrl"]},meetingScheduled:{id:"meetingScheduled",type:u.MEETING,channel:d.BOTH,priority:p.MEDIUM,title:"üìÖ Reuni√£o agendada",message:"{{meetingTitle}} em {{date}} √†s {{time}}",emailSubject:"Reuni√£o agendada: {{meetingTitle}}",emailHtml:`
      <h2>üìÖ Reuni√£o Agendada</h2>
      <p><strong>{{meetingTitle}}</strong></p>
      <p>Data: {{date}} √†s {{time}}</p>
      <p><a href="{{meetingUrl}}">Adicionar ao calend√°rio</a></p>
    `,variables:["meetingTitle","date","time","meetingUrl"]},meetingReminder1h:{id:"meetingReminder1h",type:u.MEETING,channel:d.BOTH,priority:p.HIGH,title:"‚è∞ Reuni√£o em 1 hora!",message:"{{meetingTitle}} √†s {{time}}",emailSubject:"Lembrete: {{meetingTitle}} em 1 hora",emailHtml:`
      <h2>‚è∞ Reuni√£o em 1 hora</h2>
      <p><strong>{{meetingTitle}}</strong> √†s {{time}}</p>
      <p><a href="{{meetingUrl}}">Entrar na reuni√£o</a></p>
    `,variables:["meetingTitle","time","meetingUrl"]},meetingReminder5min:{id:"meetingReminder5min",type:u.MEETING,channel:d.PUSH,priority:p.CRITICAL,title:"‚è∞ Reuni√£o em 5 minutos!",message:"{{meetingTitle}} - Prepare-se!",variables:["meetingTitle","meetingUrl"]},liveClassStarting:{id:"liveClassStarting",type:u.LIVE_CLASS,channel:d.BOTH,priority:p.CRITICAL,title:"üî¥ Aula ao vivo come√ßando AGORA!",message:"{{className}} - Clique para entrar",emailSubject:"Aula ao vivo: {{className}}",emailHtml:`
      <h2>üî¥ Aula Ao Vivo</h2>
      <p><strong>{{className}}</strong> est√° come√ßando agora!</p>
      <p><a href="{{liveClassUrl}}">Entrar na aula</a></p>
    `,variables:["className","liveClassUrl"]},liveClassReminder15min:{id:"liveClassReminder15min",type:u.LIVE_CLASS,channel:d.BOTH,priority:p.HIGH,title:"‚è∞ Aula ao vivo em 15 minutos",message:"{{className}} - Prepare seus materiais!",emailSubject:"Aula ao vivo em 15 minutos: {{className}}",emailHtml:`
      <h2>‚è∞ Aula ao vivo em 15 minutos</h2>
      <p><strong>{{className}}</strong></p>
      <p>Prepare seus materiais e esteja pronto!</p>
      <p><a href="{{liveClassUrl}}">Link da aula</a></p>
    `,variables:["className","liveClassUrl"]},liveClassReminder5min:{id:"liveClassReminder5min",type:u.LIVE_CLASS,channel:d.PUSH,priority:p.HIGH,title:"‚è∞ Aula ao vivo em 5 minutos",message:"{{className}} - N√£o se atrase!",variables:["className"]}},T={async send(i,{userId:e,email:a,variables:t={},priorityOverride:r,channelOverride:s,metadata:n}={}){const l=j[i];if(!l)throw new Error(`Unknown notification template: ${i}`);const g=L(r||l.priority,s||l.channel),m=w=>_.render(w,t),h=[];if(g.includes("push")){const w=m(l.title||""),b=m(l.message||"");h.push(D.sendNotification({title:w,message:b,type:l.type,category:l.type,priority:(r||l.priority||"medium").toLowerCase(),metadata:n},e))}if(g.includes("email")){if(!a)throw new Error("Email recipient is required for email delivery");const b={accountCreated:"welcome",classInviteSent:"class-invite",classInviteAccepted:"class-invite-accepted",newActivity:"new-activity",deadlineWarning24h:"deadline-warning",activityCorrected:"activity-corrected",plagiarismDetected:"plagiarism-alert",monthlyReportGenerated:"monthly-report",passwordRecoveryRequested:"password-recovery",passwordChanged:"password-changed",accountConfirmed:"account-confirmed",loginNewDevice:"login-new-device",studentAddedToClass:"student-added",studentRemovedFromClass:"student-removed",classCreated:"class-created"}[i];if(b)h.push(q.send(b,{to:a,variables:t,language:t.language||"pt"}));else{const E=m(l.emailSubject||l.title||"Notifica√ß√£o"),A=l.emailHtml?m(l.emailHtml):void 0,C=A?void 0:m(l.message||"");h.push(_.sendEmail({to:a,subject:E,html:A,text:C}))}}return await Promise.allSettled(h)},async notifyNewActivity({userId:i,email:e,variables:a,metadata:t}){return this.send("newActivity",{userId:i,email:e,variables:a,metadata:t})},async notifyDeadline24h({userId:i,email:e,variables:a,metadata:t}){return this.send("deadlineWarning24h",{userId:i,email:e,variables:a,metadata:t})},async notifyActivityCorrected({userId:i,email:e,variables:a,metadata:t}){return this.send("activityCorrected",{userId:i,email:e,variables:a,metadata:t})},async notifyPlagiarismDetected({userId:i,email:e,variables:a,metadata:t}){return this.send("plagiarismDetected",{userId:i,email:e,variables:a,metadata:t})}},B={async getClasses({teacherId:i,studentId:e,activeOnly:a=!0}={}){try{let t=o.from("classes").select(`
          *,
          members:class_members(*, user:profiles(*)),
          meetings!inner(*)
        `).order("name",{ascending:!0});i&&(t=t.eq("created_by",i)),a&&(t=t.eq("is_active",!0));const r=t,s=new Promise((g,m)=>setTimeout(()=>m(new Error("Query timeout")),5e3)),{data:n,error:l}=await Promise.race([r,s]);return l?(c.error("Error fetching classes:",l),[]):e?(n||[]).filter(g=>g.members?.some(m=>m.user_id===e&&m.role==="student")):n||[]}catch(t){return c.error("Error or timeout fetching classes:",t.message),[]}},async getClassById(i){try{const e=o.from("classes").select(`
          *,
          members:class_members(*, user:profiles(*)),
          meetings!inner(*)
        `).eq("id",i).single(),a=new Promise((s,n)=>setTimeout(()=>n(new Error("Query timeout")),5e3)),{data:t,error:r}=await Promise.race([e,a]);return r?(c.error(`Error fetching class ${i}:`,r),null):t}catch(e){return c.error(`Error or timeout fetching class ${i}:`,e.message),null}},async createClass(i,e=[]){const{name:a,description:t,teacher_id:r,subject:s,course:n,period:l,grade_level:g,academic_year:m,color:h,student_capacity:v,school_id:w,is_school_managed:b,grading_system:E}=i;try{const f=o.from("profiles").select("id").eq("id",r).maybeSingle(),H=new Promise((S,M)=>setTimeout(()=>M(new Error("Profile check timeout")),3e3)),{data:O,error:R}=await Promise.race([f,H]);if(!O&&!R){c.debug("Profile not found for teacher, creating one...");const{error:S}=await o.from("profiles").insert([{id:r,role:"teacher",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]);if(S&&(c.error("Error creating teacher profile:",S),S.code!=="23505"))throw new Error(`Erro ao criar perfil do professor: ${S.message}`)}}catch(f){c.warn("Profile check timed out, continuing without profile verification:",f.message)}const A={name:a,description:t||null,created_by:r,subject:s||null,course:n||null,period:l||null,grade_level:g||null,academic_year:(()=>{const f=parseInt(m,10);return Number.isFinite(f)?f:new Date().getFullYear()})(),grading_system:E||"0-10",color:h||"#6366f1",student_capacity:typeof v=="number"?v:30,room_number:i.room_number||null,is_online:!!i.is_online,meeting_link:i.meeting_link||null,chatbot_enabled:!!i.chatbot_enabled,school_id:w||null,is_school_managed:!!b,is_active:!0};c.debug("Creating class with data:",A);const{data:C,error:N}=await o.from("classes").insert([A]).select().single();if(N)throw c.error("Error creating class:",N),console.error("Error details:",{code:N.code,message:N.message,details:N.details,hint:N.hint}),new Error(`Erro ao criar turma: ${N.message}. Detalhes: ${N.hint||N.details||"Nenhum detalhe adicional"}`);c.debug("Class created successfully:",C);try{await T.send("classCreated",{userId:r,variables:{className:a},channelOverride:"push",metadata:{classId:C.id}})}catch(f){c.warn("Falha ao notificar cria√ß√£o de turma:",f)}try{const{error:f}=await o.from("class_members").insert([{class_id:C.id,user_id:r,role:"teacher",joined_at:new Date().toISOString()}]);f&&f.code!=="23505"&&c.warn("Erro ao adicionar professor como membro:",f)}catch(f){c.warn("Falha ao adicionar professor como membro da turma:",f)}if(e&&e.length>0)try{await this.addStudentsToClass(C.id,e)}catch(f){c.warn("Falha ao adicionar alunos:",f)}try{const{error:f}=await o.from("chatbot_configurations").upsert({class_id:C.id,enabled:!0,keywords:[],themes:[],scope_restrictions:[],created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{onConflict:"class_id"});f?c.warn("Erro ao garantir configura√ß√£o do chatbot:",f):c.debug("Chatbot configuration ensured for class:",C.id)}catch(f){c.warn("Falha ao garantir chatbot para a turma:",f)}return this.getClassById(C.id)},async updateClass(i,e,a){const t={...e||{}};if(Object.prototype.hasOwnProperty.call(t,"academic_year")){const s=parseInt(t.academic_year,10);t.academic_year=Number.isFinite(s)?s:new Date().getFullYear()}const{error:r}=await o.from("classes").update({...t,updated_at:new Date().toISOString()}).eq("id",i);if(r)throw c.error(`Error updating class ${i}:`,r),r;if(Array.isArray(a)){const{data:s}=await o.from("class_members").select("user_id").eq("class_id",i).eq("role","student"),n=(s||[]).map(m=>m.user_id),l=a.filter(m=>!n.includes(m)),g=n.filter(m=>!a.includes(m));await Promise.all([this.addStudentsToClass(i,l),this.removeStudentsFromClass(i,g)])}return this.getClassById(i)},async deleteClass(i){const{error:e}=await o.from("classes").update({is_active:!1,updated_at:new Date().toISOString()}).eq("id",i);if(e)throw c.error(`Error deleting class ${i}:`,e),e;return!0},async addStudentsToClass(i,e){if(!e||e.length===0)return[];const{data:a,error:t}=await o.from("class_members").insert(e.map(r=>({class_id:i,user_id:r,role:"student",joined_at:new Date().toISOString()}))).select();if(t)throw c.error(`Error adding students to class ${i}:`,t),t;try{const[{data:r},{data:s}]=await Promise.all([o.from("classes").select("id, name, created_by").eq("id",i).single(),o.from("profiles").select("id, full_name").in("id",e)]);if(r?.created_by&&s?.length)for(const n of s)await T.send("studentAddedToClass",{userId:r.created_by,variables:{studentName:n.full_name||"Aluno",className:r.name||"Turma"},channelOverride:"push",metadata:{classId:i,studentId:n.id}})}catch(r){c.warn("Falha ao notificar alunos adicionados:",r)}return a},async removeStudentsFromClass(i,e){if(!e||e.length===0)return!0;const{error:a}=await o.from("class_members").delete().eq("class_id",i).in("user_id",e).eq("role","student");if(a)throw c.error(`Error removing students from class ${i}:`,a),a;try{const[{data:t},{data:r}]=await Promise.all([o.from("classes").select("id, name").eq("id",i).single(),o.from("profiles").select("id, full_name").in("id",e)]);for(const s of r||[])await T.send("studentRemovedFromClass",{userId:s.id,email:void 0,variables:{className:t?.name||"Turma"},metadata:{classId:i}})}catch(t){c.warn("Falha ao notificar alunos removidos:",t)}return!0},async searchClasses(i,{onlyActive:e=!0}={}){let a=o.from("classes").select("*").or(`name.ilike.%${i}%,description.ilike.%${i}%`);e&&(a=a.eq("is_active",!0));const{data:t,error:r}=await a;if(r)throw c.error("Error searching classes:",r),r;return t},async updateClassSchedule(i,e){const{data:a,error:t}=await o.from("classes").update({vacation_start:e.vacation_start||null,vacation_end:e.vacation_end||null,cancelled_dates:e.cancelled_dates||null,updated_at:new Date().toISOString()}).eq("id",i).select().single();if(t)throw c.error(`Error updating class schedule ${i}:`,t),t;return a},async getClassStats(i){try{const{data:e,error:a}=await o.from("class_members").select("user_id, role").eq("class_id",i);if(a)throw a;const{count:t,error:r}=await o.from("activity_class_assignments").select("*",{count:"exact",head:!0}).eq("class_id",i);if(r)throw r;const{data:s,error:n}=await o.from("submissions").select("id, activity_id").eq("status","pending").in("activity_id",o.from("activity_class_assignments").select("activity_id").eq("class_id",i)),l=e?.filter(m=>m.role==="student").length||0,g=e?.filter(m=>m.role==="teacher").length||0;return{studentCount:l,teacherCount:g,activitiesCount:t||0,pendingCorrections:s?.length||0,totalMembers:e?.length||0}}catch(e){return c.error(`Error getting stats for class ${i}:`,e),{studentCount:0,teacherCount:0,activitiesCount:0,pendingCorrections:0,totalMembers:0}}},async generateInviteCode(i){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let a="";for(let s=0;s<8;s++)a+=e.charAt(Math.floor(Math.random()*e.length));const{data:t,error:r}=await o.from("classes").update({invite_code:a,updated_at:new Date().toISOString()}).eq("id",i).select("invite_code").single();if(r)throw c.error(`Error generating invite code for class ${i}:`,r),r;return t.invite_code},async archiveClass(i){const{error:e}=await o.from("classes").update({is_active:!1,updated_at:new Date().toISOString()}).eq("id",i);if(e)throw c.error(`Error archiving class ${i}:`,e),e;return!0},async getClassMembers(i,{role:e=null}={}){let a=o.from("class_members").select(`
        *,
        user:profiles(*)
      `).eq("class_id",i).order("joined_at",{ascending:!1});e&&(a=a.eq("role",e));const{data:t,error:r}=await a;if(r)throw c.error(`Error fetching members for class ${i}:`,r),r;return t},async joinClassByCode(i,e){const{data:a,error:t}=await o.from("classes").select("*").eq("invite_code",i).eq("is_active",!0).single();if(t||!a)throw new Error("C√≥digo de turma inv√°lido ou turma n√£o encontrada");const{data:r}=await o.from("class_members").select("id").eq("class_id",a.id).eq("user_id",e).single();if(r)throw new Error("Voc√™ j√° √© membro desta turma");const{data:s,error:n}=await o.from("class_members").insert({class_id:a.id,user_id:e,role:"student",joined_at:new Date().toISOString()}).select().single();if(n)throw c.error("Error joining class:",n),new Error("Erro ao entrar na turma");try{const{data:l}=await o.from("profiles").select("full_name").eq("id",e).single();await T.send("studentJoinedClass",{userId:a.created_by,variables:{studentName:l?.full_name||"Novo aluno",className:a.name},channelOverride:"push",metadata:{classId:a.id,studentId:e}})}catch(l){c.warn("Failed to notify teacher:",l)}return a},async getTeacherClasses(i){try{const{data:e,error:a}=await o.from("classes").select("*").eq("created_by",i).eq("is_active",!0).order("name",{ascending:!0});if(a)throw a;return e||[]}catch(e){throw c.error("Error fetching teacher classes:",e),e}},async getClassByInviteCode(i){const{data:e,error:a}=await o.from("classes").select(`
        *,
        teacher:profiles!classes_created_by_fkey(id, full_name, name, avatar_url)
      `).eq("invite_code",i).eq("is_active",!0).single();if(a||!e)throw c.error("Error fetching class by invite code:",a),new Error(a?.message||"C√≥digo de turma inv√°lido");return e},subscribeToClasses(i){const e=o.channel("classes_changes").on("postgres_changes",{event:"*",schema:"public",table:"classes"},a=>{i(a)}).subscribe();return()=>{o.removeChannel(e)}}};export{B as C,T as N,D as a};
