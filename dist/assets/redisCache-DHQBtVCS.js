import{l as n}from"./main-Bl3iyOV8.js";const c="https://wapbwaimkurbuihatmix.supabase.co/functions/v1/redis-cache",l="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhcGJ3YWlta3VyYnVpaGF0bWl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODY3MjksImV4cCI6MjA3NDg2MjcyOX0.x-NQQ2TtRgaUjjBZCf6j49eWOW4XSqjTFKC_KB1L56A",r={classStats:300,students:600,activities:300,materials:900,posts:180,default:300};class u{constructor(){this.enabled=!0}async invalidatePattern(t){return await this.deletePattern(t)}async request(t,e={}){if(!this.enabled)return null;try{const s=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({action:t,...e})});if(!s.ok)return s.status===500&&(this.enabled=!1,n.debug("[Redis] Cache temporariamente desabilitado (Edge Function não disponível)")),null;const a=await s.json();return a.success?a.result:null}catch{return this.enabled=!1,n.debug("[Redis] Cache desabilitado devido a erro de conexão"),null}}async get(t){const e=await this.request("get",{key:t});if(e)try{return JSON.parse(e)}catch{return e}return null}async set(t,e,s=null){const a=typeof e=="string"?e:JSON.stringify(e),i=s||r.default;return await this.request("set",{key:t,value:a,ttl:i})}async delete(t){return await this.request("del",{key:t})}async deletePattern(t){try{const e=await this.request("keys",{pattern:t});if(e&&e.length>0){const s=e.map(a=>({command:"DEL",args:[a]}));return await this.request("batch",{operations:s})}}catch(e){n.warn("Error deleting pattern:",e)}return null}async cacheQuery(t,e,s=null){const a=await this.get(t);if(a!==null)return n.debug(`[Cache HIT] ${t}`),a;n.debug(`[Cache MISS] ${t}`);const i=await e();return i!=null&&await this.set(t,i,s),i}generateKey(t,...e){return`${t}:${e.join(":")}`}async invalidateClass(t){await this.deletePattern(`class:${t}:*`),await this.deletePattern(`stats:${t}:*`),n.debug(`[Cache] Invalidated class ${t}`)}async invalidateUser(t){await this.deletePattern(`user:${t}:*`),n.debug(`[Cache] Invalidated user ${t}`)}async getClassStats(t,e){const s=this.generateKey("stats",t,"overview");return await this.cacheQuery(s,e,r.classStats)}async getClassStudents(t,e){const s=this.generateKey("class",t,"students");return await this.cacheQuery(s,e,r.students)}async getClassActivities(t,e){const s=this.generateKey("class",t,"activities");return await this.cacheQuery(s,e,r.activities)}async getClassMaterials(t,e){const s=this.generateKey("class",t,"materials");return await this.cacheQuery(s,e,r.materials)}async getClassPosts(t,e){const s=this.generateKey("class",t,"posts");return await this.cacheQuery(s,e,r.posts)}async ping(){try{return await this.request("ping")==="PONG"}catch{return!1}}disable(){this.enabled=!1,n.warn("[Cache] Disabled")}enable(){this.enabled=!0,n.debug("[Cache] Enabled")}}const d=new u;export{d as r};
