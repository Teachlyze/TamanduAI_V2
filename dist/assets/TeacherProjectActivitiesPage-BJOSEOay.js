import{c as W,u as Y,b as Z,r,l as _,s as F,j as e}from"./main-BtydHokz.js";import{u as I}from"./use-toast-BD7ojcJx.js";import{B as f}from"./button-pkZcz0fw.js";import{C as B}from"./card-BLN8IVBT.js";import{I as m}from"./input-DevW5dIO.js";import{L as v}from"./label-Do1Gcpls.js";import{B as O}from"./badge-DpVvk9bK.js";import{D as Q,a as G,b as H,c as V,e as X}from"./dialog-BI66C03T.js";import{B as ee}from"./Breadcrumb-BaVmLvd0.js";import{D as ae}from"./DashboardHeader-Do_OLCE8.js";import{E as se}from"./EmptyState-B9PjJzZx.js";import"./dropdown-menu-DQk5WS44.js";import{u as te}from"./useActivityFiles-DaIH2UKY.js";import{P as re}from"./PostActivityModal-OGtpzdSA.js";import{P as R}from"./plus-MdU524Dr.js";import{F as $}from"./file-text-GwBv-P3B.js";import{m as ie}from"./proxy-BKNTM3tf.js";import{F as oe}from"./folder-U4AUjcce.js";import{C as ne}from"./calendar-xkfkZRmm.js";import{U as le}from"./upload-C88KdNIl.js";import{S as U}from"./share-2-CC-aHbkA.js";import{T as J}from"./trash-2-CZHoMkaq.js";import"./index-BRR_QA-l.js";import"./index-C0ZNntAv.js";import"./Combination-DK-gSie6.js";import"./SidebarPremium-BEHUuQck.js";import"./house-dUPObbYn.js";import"./users-CntpuLnR.js";import"./book-open-BQJiPDff.js";import"./graduation-cap-Bm5psu3Q.js";import"./chart-column-B3n9ZMAW.js";import"./message-circle-DTeSrK_w.js";import"./settings-BNGXdjmZ.js";import"./brain-DIkHdpFj.js";import"./index-BpBd5wiB.js";import"./chevron-right-Bh44L5jc.js";import"./x-BtLVjj0F.js";import"./index-DOzlJ45Y.js";import"./index-sWFH3d_M.js";import"./index-DsrKRt14.js";import"./check-B1zY7uXK.js";import"./textarea-BolYe6PH.js";import"./checkbox-ByVj5oTw.js";import"./index-C35Ckziv.js";import"./switch-BZnWEHpm.js";import"./circle-alert-COBXyI8K.js";const ce=[["path",{d:"M13 21h8",key:"1jsn5i"}],["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],de=W("pen-line",ce),ia=()=>{const o=Y(),{user:l}=Z(),{toast:u}=I(),[z,S]=r.useState(!0),[n,y]=r.useState([]),[D,P]=r.useState([]),[p,j]=r.useState(""),[T,b]=r.useState(!1),[C,N]=r.useState(null),[A,h]=r.useState(null);r.useEffect(()=>{l?(w(),i()):_.warn("[TeacherProjectActivitiesPage] ⚠️ User not found!")},[l]);const w=async()=>{if(l)try{S(!0);const{data:a,error:s}=await F.from("activities").select(`
          *,
          assignments:activity_class_assignments(
            id,
            class_id,
            assigned_at,
            class:classes(id, name)
          )
        `).eq("created_by",l.id).eq("type","project").is("deleted_at",null).order("created_at",{ascending:!1});if(s)throw s;y(a||[])}catch(a){_.error("Erro ao carregar atividades por arquivo:",a),u({title:"Erro",description:"Não foi possível carregar suas tarefas por arquivo.",variant:"destructive"})}finally{S(!1)}},i=async()=>{if(l)try{const{data:a,error:s}=await F.from("classes").select("id, name").eq("created_by",l.id).eq("is_active",!0);if(s)throw s;P(a||[])}catch(a){_.error("Erro ao carregar turmas para tarefas por arquivo:",a)}},E=r.useMemo(()=>{if(!p)return n;const a=p.toLowerCase();return n.filter(s=>s.title?.toLowerCase().includes(a)||s.description?.toLowerCase().includes(a)||s.content?.subject?.toLowerCase().includes(a)||Array.isArray(s.content?.tags)&&s.content.tags.some(x=>x.toLowerCase().includes(a)))},[n,p]),k=async a=>{try{const{error:s}=await F.from("activities").update({status:"archived",updated_at:new Date().toISOString()}).eq("id",a);if(s)throw s;u({title:"Atividade arquivada"}),y(x=>x.filter(g=>g.id!==a))}catch(s){_.error("Erro ao arquivar tarefa por arquivo:",s),u({title:"Erro ao arquivar",variant:"destructive"})}},q=async a=>{try{const{error:s}=await F.from("activities").update({deleted_at:new Date().toISOString()}).eq("id",a);if(s)throw s;u({title:"Tarefa excluída"}),y(x=>x.filter(g=>g.id!==a))}catch(s){_.error("Erro ao excluir tarefa por arquivo:",s),u({title:"Erro ao excluir",variant:"destructive"})}},M=r.useMemo(()=>{const a=n.length,s=n.filter(g=>g.status==="draft").length,x=n.filter(g=>g.status==="published").length;return{total:a,drafts:s,published:x}},[n]);return z?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("p",{className:"text-sm text-slate-500",children:"Carregando tarefas por arquivo..."})}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 p-6",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx(ee,{items:[{label:"Atividades",path:"/dashboard/activities"},{label:"Tarefas por Arquivo",path:"/dashboard/activities/projects"}],className:"mb-2"}),e.jsx(ae,{title:"Tarefas por Arquivo",subtitle:"Gerencie atividades baseadas apenas em upload de PDF/DOCX",role:"teacher"}),e.jsxs("div",{className:"flex flex-wrap gap-3 mt-4",children:[e.jsxs(f,{size:"lg",onClick:()=>b(!0),className:"bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700",children:[e.jsx(R,{className:"w-5 h-5 mr-2"}),"Nova Tarefa por Arquivo"]}),e.jsx(f,{variant:"outline",size:"lg",onClick:()=>o("/dashboard/activities"),children:"Voltar para Banco de Atividades"})]})]}),e.jsxs(B,{className:"p-4 mb-6 flex flex-col md:flex-row items-start md:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-800",children:[e.jsx("p",{className:"text-xs text-slate-500",children:"Total"}),e.jsx("p",{className:"text-lg font-semibold",children:M.total})]}),e.jsxs("div",{className:"px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-800",children:[e.jsx("p",{className:"text-xs text-slate-500",children:"Rascunhos"}),e.jsx("p",{className:"text-lg font-semibold",children:M.drafts})]}),e.jsxs("div",{className:"px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-800",children:[e.jsx("p",{className:"text-xs text-slate-500",children:"Publicadas"}),e.jsx("p",{className:"text-lg font-semibold",children:M.published})]})]}),e.jsx("div",{className:"w-full md:w-64",children:e.jsx(m,{placeholder:"Buscar por título, descrição ou tag...",value:p,onChange:a=>j(a.target.value)})})]}),E.length===0?e.jsx(se,{icon:$,title:p?"Nenhuma tarefa encontrada":"Nenhuma tarefa por arquivo ainda",description:p?"Ajuste a busca ou limpe o campo para ver todas as tarefas.":"Crie sua primeira tarefa por arquivo para começar.",actionLabel:"Nova Tarefa por Arquivo",actionIcon:R,action:()=>b(!0)}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:E.map((a,s)=>e.jsx(ie.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:s*.05},children:e.jsxs(B,{className:"p-5 flex flex-col gap-4 h-full justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"w-4 h-4 text-purple-500"}),e.jsx("h3",{className:"font-semibold text-base leading-snug",children:a.title})]}),e.jsx(O,{variant:a.status==="published"?"default":"outline",children:a.status==="published"?"Publicada":"Rascunho"})]}),a.description&&e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400 mb-2 line-clamp-3",children:a.description}),Array.isArray(a.content?.tags)&&a.content.tags.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-2",children:a.content.tags.map((x,g)=>e.jsxs(O,{variant:"outline",className:"text-xs",children:["#",x]},g))}),e.jsxs("div",{className:"mt-3 space-y-1 text-xs text-slate-500",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"w-3 h-3"}),e.jsx("span",{children:a.due_date?new Date(a.due_date).toLocaleString("pt-BR"):"Sem prazo definido"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"w-3 h-3"}),e.jsxs("span",{children:[a.content?.attachments?.length||0," arquivo(s) de enunciado"]})]}),Array.isArray(a.assignments)&&a.assignments.length>0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{className:"w-3 h-3"}),e.jsxs("span",{children:["Postada em ",a.assignments.length," turma(s)"]})]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-3",children:[e.jsxs(f,{size:"sm",variant:"outline",onClick:()=>N(a),children:[e.jsx(de,{className:"w-4 h-4 mr-1"}),"Editar"]}),e.jsxs(f,{size:"sm",variant:"outline",onClick:()=>h(a),children:[e.jsx(U,{className:"w-4 h-4 mr-1"}),"Postar"]}),e.jsx(f,{size:"sm",variant:"outline",className:"ml-auto text-slate-600",onClick:()=>k(a.id),children:"Arquivar"}),e.jsxs(f,{size:"sm",variant:"destructive",onClick:()=>q(a.id),children:[e.jsx(J,{className:"w-4 h-4 mr-1"}),"Excluir"]})]})]})},a.id))}),T&&e.jsx(me,{open:T,onClose:()=>b(!1),onCreated:a=>{b(!1),a&&N(a),w()},userId:l?.id}),C&&e.jsx(ue,{activity:C,open:!!C,onClose:()=>N(null),onSaved:()=>{N(null),w()},userId:l?.id}),A&&e.jsx(re,{activities:[A],classes:D,onClose:()=>h(null),onSuccess:()=>{h(null),w()}})]})},me=({open:o,onClose:l,onCreated:u,userId:z})=>{const{toast:S}=I(),[n,y]=r.useState(""),[D,P]=r.useState(""),[p,j]=r.useState(""),[T,b]=r.useState(""),[C,N]=r.useState(10),[A,h]=r.useState(!1),w=async()=>{if(!n.trim()){S({title:"Título obrigatório",description:"Defina um título para a tarefa.",variant:"destructive"});return}try{h(!0);const i=p.split(",").map(q=>q.trim()).filter(q=>q.length>0),{data:E,error:k}=await F.from("activities").insert({title:n.trim(),description:D.trim(),type:"project",status:"draft",is_published:!1,max_score:C,due_date:T||null,created_by:z,content:{tags:i,attachments:[],advanced_settings:{submissionMode:"file_upload",plagiarismEnabled:!1,autoGradingEnabled:!1,shuffleQuestions:!1}}}).select().single();if(k)throw k;S({title:"Tarefa criada",description:"Agora você pode adicionar arquivos de enunciado e postar nas turmas."}),u&&u(E)}catch(i){_.error("Erro ao criar tarefa por arquivo:",i),S({title:"Erro ao criar tarefa",description:"Tente novamente em instantes.",variant:"destructive"})}finally{h(!1)}};return e.jsx(Q,{open:o,onOpenChange:l,children:e.jsxs(G,{className:"max-w-xl",children:[e.jsx(H,{children:e.jsx(V,{children:"Nova Tarefa por Arquivo"})}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{children:[e.jsx(v,{htmlFor:"title",children:"Título *"}),e.jsx(m,{id:"title",value:n,onChange:i=>y(i.target.value),placeholder:"Ex: Projeto de Pesquisa - Tema Livre"})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"description",children:"Descrição / Enunciado"}),e.jsx(m,{id:"description",value:D,onChange:i=>P(i.target.value),placeholder:"Explique brevemente o que os alunos devem fazer."})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"tags",children:"Tags (separadas por vírgula)"}),e.jsx(m,{id:"tags",value:p,onChange:i=>j(i.target.value),placeholder:"ex: redação, projeto, pesquisa"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(v,{htmlFor:"dueDate",children:"Prazo (opcional)"}),e.jsx(m,{id:"dueDate",type:"datetime-local",value:T,onChange:i=>b(i.target.value)})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"maxScore",children:"Pontuação Máxima"}),e.jsx(m,{id:"maxScore",type:"number",min:"0",step:"0.5",value:C,onChange:i=>N(parseFloat(i.target.value)||0)})]})]})]}),e.jsxs(X,{children:[e.jsx(f,{variant:"outline",onClick:l,disabled:A,children:"Cancelar"}),e.jsx(f,{onClick:w,disabled:A,children:A?"Salvando...":"Salvar Tarefa"})]})]})})},ue=({activity:o,open:l,onClose:u,onSaved:z,userId:S})=>{const{toast:n}=I(),[y,D]=r.useState(o.title||""),[P,p]=r.useState(o.description||""),[j,T]=r.useState(o.content?.tags||[]),[b,C]=r.useState(o.due_date?o.due_date.substring(0,16):""),[N,A]=r.useState(o.max_score||10),[h,w]=r.useState(o.content?.attachments||[]),[i,E]=r.useState(!1),{uploadActivityFile:k,isUploading:q,uploadProgress:M}=te(o.id,S,!1),a=async t=>{const c=t.target.files?.[0];if(c)try{const d=await k(c),L=[...h,{name:d.name,url:d.url,path:d.path,size:d.size,type:d.type}];w(L)}catch(d){n({title:"Erro ao enviar arquivo",description:d?.message||"Tente novamente em instantes.",variant:"destructive"})}finally{t.target.value=""}},s=t=>{w(c=>c.filter((d,L)=>L!==t))},x=async()=>{try{E(!0);const t=Array.isArray(j)?j:[],{error:c}=await F.from("activities").update({title:y.trim(),description:P.trim(),max_score:N,due_date:b||null,content:{...o.content||{},tags:t,attachments:h,advanced_settings:{...o.content?.advanced_settings||{},submissionMode:"file_upload",plagiarismEnabled:!1,autoGradingEnabled:!1,shuffleQuestions:!1}},updated_at:new Date().toISOString()}).eq("id",o.id);if(c)throw c;n({title:"Tarefa atualizada com sucesso!"}),z()}catch(t){_.error("Erro ao atualizar tarefa por arquivo:",t),n({title:"Erro ao salvar alterações",description:"Tente novamente em instantes.",variant:"destructive"})}finally{E(!1)}},g=t=>{const c=t.split(",").map(d=>d.trim()).filter(d=>d.length>0);T(c)},K=r.useMemo(()=>Array.isArray(j)?j.join(", "):"",[j]);return e.jsx(Q,{open:l,onOpenChange:u,children:e.jsxs(G,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(H,{children:e.jsx(V,{children:"Editar Tarefa por Arquivo"})}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{children:[e.jsx(v,{htmlFor:"title-edit",children:"Título *"}),e.jsx(m,{id:"title-edit",value:y,onChange:t=>D(t.target.value)})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"description-edit",children:"Descrição / Enunciado"}),e.jsx(m,{id:"description-edit",value:P,onChange:t=>p(t.target.value)})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"tags-edit",children:"Tags (separadas por vírgula)"}),e.jsx(m,{id:"tags-edit",value:K,onChange:t=>g(t.target.value)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(v,{htmlFor:"dueDate-edit",children:"Prazo (opcional)"}),e.jsx(m,{id:"dueDate-edit",type:"datetime-local",value:b||"",onChange:t=>C(t.target.value)})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"maxScore-edit",children:"Pontuação Máxima"}),e.jsx(m,{id:"maxScore-edit",type:"number",min:"0",step:"0.5",value:N,onChange:t=>A(parseFloat(t.target.value)||0)})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Arquivos de Enunciado"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(m,{type:"file",accept:".pdf,.doc,.docx,.odt,.txt",onChange:a,disabled:q}),q&&e.jsxs("span",{className:"text-xs text-slate-500",children:["Enviando... ",M,"%"]})]}),h.length>0&&e.jsx("div",{className:"mt-2 space-y-2",children:h.map((t,c)=>e.jsxs("div",{className:"flex items-center justify-between text-sm border rounded px-3 py-2",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx($,{className:"w-4 h-4 text-purple-500 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:t.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[t.url&&e.jsx("a",{href:t.url,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-blue-600 hover:underline",children:"Abrir"}),e.jsx(f,{size:"icon",variant:"ghost",className:"h-7 w-7 text-red-500",onClick:()=>s(c),children:e.jsx(J,{className:"w-4 h-4"})})]})]},`${t.path||t.url||c}`))})]})]}),e.jsxs(X,{children:[e.jsx(f,{variant:"outline",onClick:u,disabled:i,children:"Cancelar"}),e.jsx(f,{onClick:x,disabled:i,children:i?"Salvando...":"Salvar alterações"})]})]})})};export{ia as default};
