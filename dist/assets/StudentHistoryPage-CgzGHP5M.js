import{a as ee,r as h,s as te,l as Y,j as e,m as ae}from"./main-BXI8jImK.js";import{S as A}from"./StatsCard-BvzfNeJ2.js";import{D as se}from"./DashboardHeader-BC80IxDW.js";import{B as G}from"./button-DhJSXayK.js";import{C as D}from"./card-Dts-jKab.js";import{A as re,B as M}from"./SidebarPremium-CqhK_O_u.js";import"./input-YtE9-IyT.js";import"./dropdown-menu-7nHS86TP.js";import"./label-DZTyMoK9.js";import{P as le}from"./progress-C4xxo9fK.js";import{S as L,a as H,b as O,c as V,d as F}from"./select-BYpegp6M.js";import{t as T}from"./use-toast-B4cJHS9G.js";import{E as de,a as oe}from"./exceljs.min-D4xxOZfQ.js";import{F as ie}from"./funnel-rLvg5Q-7.js";import{F as ce}from"./file-text-B1_cTV9D.js";import{D as ne}from"./download-COsSi_Yf.js";import{G as me}from"./graduation-cap-BVXXkz0b.js";import{C as xe}from"./chart-column-D6pi1FRc.js";import{C as ue}from"./clock-Ic71-9yN.js";import{C as he}from"./circle-check-big-BGyFuaS8.js";import{ag as q,ai as K,aj as U,ak as W,ah as J}from"./CartesianChart-CT_d4aWO.js";import{B as X,d as Q}from"./BarChart-BxSKjVb3.js";import{f as I}from"./format-D0LVKLFA.js";import{p as $}from"./pt-BR-zMqltMoH.js";import"./chevron-right-DFiBXpQq.js";import"./bell-De3gaLfU.js";import"./book-open-BMCImb8A.js";import"./trending-up-C_AGH9Be.js";import"./user-XMBxPeUS.js";import"./settings-Dn83Owos.js";import"./users-1MVt23UL.js";import"./index-Cyt6Mlq7.js";import"./x-DhRNfShw.js";import"./index-laUz9pSU.js";import"./index-D63a-v4Z.js";import"./Combination-7NRWB7dp.js";import"./index-PCXR_M5s.js";import"./check-P2w7Pyl_.js";import"./index-DWCzEl6o.js";import"./chevron-down-vfmnlur0.js";import"./chevron-up-3f7I9tWa.js";import"./index-Bl3P6sXQ.js";import"./en-US-Bd7_-tVp.js";const ge=(p,j,y)=>{const l=new de;l.setFontSize(18),l.text("Relatório de Notas",14,22),l.setFontSize(12),l.text(`Aluno: ${p}`,14,32),l.text(`Turma: ${y}`,14,40),l.text(`Data: ${new Date().toLocaleDateString("pt-BR")}`,14,48);const i=j.map(o=>[o.activityName||"Sem título",o.finalGrade!==null?`${o.finalGrade}%`:"Não avaliada",o.submittedAt?new Date(o.submittedAt).toLocaleDateString("pt-BR"):"-",o.status||"-"]);l.autoTable({startY:56,head:[["Atividade","Nota","Data de Entrega","Status"]],body:i,theme:"striped",headStyles:{fillColor:[59,130,246]},styles:{fontSize:10}});const f=j.filter(o=>o.finalGrade!==null);if(f.length>0){const o=f.reduce((S,x)=>S+x.finalGrade,0)/f.length,m=l.lastAutoTable.finalY+10;l.setFontSize(12),l.setFont(void 0,"bold"),l.text(`Média Geral: ${o.toFixed(2)}%`,14,m)}l.save(`notas_${p.replace(/\s+/g,"_")}_${new Date().toISOString().split("T")[0]}.pdf`)},pe=async(p,j,y)=>{const l=new oe.Workbook,i=l.addWorksheet("Notas");i.mergeCells("A1:E1");const f=i.getCell("A1");f.value="Relatório de Notas",f.font={size:16,bold:!0,color:{argb:"FF3B82F6"}},f.alignment={horizontal:"center"},i.getCell("A3").value="Aluno:",i.getCell("B3").value=p,i.getCell("A4").value="Turma:",i.getCell("B4").value=y,i.getCell("A5").value="Data:",i.getCell("B5").value=new Date().toLocaleDateString("pt-BR");const o=i.getRow(7);o.values=["Atividade","Nota","Data de Entrega","Status","Feedback"],o.font={bold:!0,color:{argb:"FFFFFFFF"}},o.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF3B82F6"}},o.alignment={horizontal:"center"},j.forEach((n,v)=>{const k=i.getRow(8+v);k.values=[n.activityName||"Sem título",n.finalGrade!==null?n.finalGrade:"-",n.submittedAt?new Date(n.submittedAt).toLocaleDateString("pt-BR"):"-",n.status||"-",n.feedback||"-"],v%2===0&&(k.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF3F4F6"}})});const m=j.filter(n=>n.finalGrade!==null);if(m.length>0){const n=m.reduce((k,R)=>k+R.finalGrade,0)/m.length,v=i.getRow(8+j.length+1);v.values=["Média Geral:",`${n.toFixed(2)}%`],v.font={bold:!0}}i.columns=[{width:30},{width:12},{width:18},{width:15},{width:40}];const S=await l.xlsx.writeBuffer(),x=new Blob([S],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),_=window.URL.createObjectURL(x),N=document.createElement("a");N.href=_,N.download=`notas_${p.replace(/\s+/g,"_")}_${new Date().toISOString().split("T")[0]}.xlsx`,N.click(),window.URL.revokeObjectURL(_)},dt=()=>{const{user:p}=ee(),[j,y]=h.useState(!0),[l,i]=h.useState([]),[f,o]=h.useState([]),[m,S]=h.useState("all"),[x,_]=h.useState("all"),[N,n]=h.useState(""),[v,k]=h.useState("");h.useEffect(()=>{p?.id?R():y(!1)},[p?.id]);const R=async()=>{try{y(!0);const{data:t,error:a}=await te.from("submissions").select(`
          id,
          activity_id,
          grade,
          feedback,
          status,
          submitted_at,
          graded_at,
          activity:activities (
            id,
            title,
            max_score,
            due_date,
            activity_class_assignments (
              class_id,
              class_info:classes ( id, name, subject, color )
            )
          )
        `).eq("student_id",p.id).order("submitted_at",{ascending:!1});if(a)throw a;const d=(t||[]).map(s=>{const u=s.activity||{},b=u.activity_class_assignments?.[0],c=b?.class_info;return{...s,activity:u,classId:b?.class_id||c?.id||null,className:c?.name||"Turma",classSubject:c?.subject||"Disciplina",classColor:c?.color||"#3B82F6"}}),r=d.filter(s=>s.classId).reduce((s,u)=>(s.find(b=>b.id===u.classId)||s.push({id:String(u.classId),name:u.className,subject:u.classSubject,color:u.classColor}),s),[]);i(d),o(r)}catch(t){Y.error("Erro ao carregar histórico do aluno:",t),T({title:"Não foi possível carregar seu histórico",description:"Tente novamente mais tarde.",variant:"destructive"})}finally{y(!1)}},g=h.useMemo(()=>{let t=l;if(m!=="all"&&(t=t.filter(a=>String(a.classId)===m)),x!=="all"){const a=new Date;let d,r;if(x==="thisYear")d=new Date(a.getFullYear(),0,1),r=new Date(a.getFullYear(),11,31,23,59,59);else if(x==="thisMonth")d=new Date(a.getFullYear(),a.getMonth(),1),r=new Date(a.getFullYear(),a.getMonth()+1,0,23,59,59);else if(x==="thisSemester"){const s=a.getMonth()<6?0:6;d=new Date(a.getFullYear(),s,1),r=new Date(a.getFullYear(),s+6,0,23,59,59)}else x==="custom"&&N&&v&&(d=new Date(N),r=new Date(v),r.setHours(23,59,59));d&&r&&(t=t.filter(s=>{const u=s.graded_at||s.submitted_at;if(!u)return!1;const b=new Date(u);return b>=d&&b<=r}))}return t},[m,l,x,N,v]),w=h.useMemo(()=>{if(g.length===0)return{averageGrade:0,delivered:0,evaluated:0,onTimeRate:0,feedbackCount:0};const t=g.filter(c=>c.grade!==null&&c.activity?.max_score),a=g.length,d=t.length,r=t.reduce((c,C)=>{const Z=C.activity?.max_score||1;return c+C.grade/Z*100},0),s=t.length?Number((r/t.length).toFixed(1)):0,u=g.reduce((c,C)=>!C.activity?.due_date||!C.submitted_at?c:new Date(C.submitted_at)<=new Date(C.activity.due_date)?c+1:c,0),b=g.filter(c=>!!c.feedback).length;return{averageGrade:s,delivered:a,evaluated:d,onTimeRate:a?Math.round(u/a*100):0,feedbackCount:b}},[g]),E=h.useMemo(()=>{const t=new Map;return l.forEach(a=>{const d=a.classId?String(a.classId):"sem-classe",r=t.get(d)||{classId:a.classId?String(a.classId):null,className:a.className,classColor:a.classColor,total:0,gradedCount:0,submissionsCount:0,onTime:0,feedback:0};r.submissionsCount+=1,a.feedback&&(r.feedback+=1),a.activity?.due_date&&a.submitted_at&&new Date(a.submitted_at)<=new Date(a.activity.due_date)&&(r.onTime+=1),a.grade!==null&&a.activity?.max_score&&(r.gradedCount+=1,r.total+=a.grade/(a.activity.max_score||1)*100),t.set(d,r)}),Array.from(t.values()).map(a=>({...a,average:a.gradedCount?Number((a.total/a.gradedCount).toFixed(1)):0,onTimeRate:a.submissionsCount?Math.round(a.onTime/a.submissionsCount*100):0}))},[l]),P=h.useMemo(()=>g.filter(t=>t.grade!==null&&t.activity?.max_score).sort((t,a)=>new Date(t.submitted_at)-new Date(a.submitted_at)).slice(-10).map(t=>({label:I(new Date(t.submitted_at),"dd/MM",{locale:$}),value:Number((t.grade/(t.activity?.max_score||1)*100).toFixed(1))})),[g]),B=h.useMemo(()=>E.filter(t=>t.classId).map(t=>({name:t.className,media:t.average,color:t.classColor})).sort((t,a)=>a.media-t.media),[E]),z=async t=>{if(!g.length){T({title:"Nada para exportar",description:"Não há dados disponíveis para o filtro selecionado.",variant:"destructive"});return}const a=p?.user_metadata?.name||"Aluno",d=m==="all"?"Todas as turmas":f.find(s=>s.id===m)?.name||"Turma",r=g.map(s=>({activityName:s.activity?.title||"Atividade",finalGrade:s.activity?.max_score?Number((s.grade??0)/(s.activity.max_score||1)*100).toFixed(1):s.grade??"-",submittedAt:s.submitted_at,status:s.grade!==null?"Avaliada":"Pendente",feedback:s.feedback||null}));try{t==="pdf"?(ge(a,r,d),T({title:"PDF exportado com sucesso!"})):(await pe(a,r,d),T({title:"Planilha exportada com sucesso!"}))}catch(s){Y.error("Erro ao exportar histórico:",s),T({title:"Erro ao exportar",description:"Tente novamente mais tarde.",variant:"destructive"})}};return j?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(ae,{size:"lg"})}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-brand-50 via-sky-50 to-brand-100 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950 p-6",children:[e.jsx(se,{title:"Histórico Acadêmico",subtitle:"Acompanhe sua evolução e exporte os dados completos",role:"student"}),e.jsxs(D,{className:"p-4 mb-6 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(ie,{className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"font-semibold text-slate-900 dark:text-white",children:"Filtros"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-slate-600 dark:text-slate-400 mb-1 block",children:"Turma"}),e.jsxs(L,{value:m,onValueChange:S,children:[e.jsx(H,{className:"bg-card border border-border",children:e.jsx(O,{placeholder:"Todas as turmas"})}),e.jsxs(V,{children:[e.jsx(F,{value:"all",children:"Todas as turmas"}),f.map(t=>e.jsx(F,{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-slate-600 dark:text-slate-400 mb-1 block",children:"Período"}),e.jsxs(L,{value:x,onValueChange:_,children:[e.jsx(H,{className:"bg-card border border-border",children:e.jsx(O,{placeholder:"Todo o histórico"})}),e.jsxs(V,{children:[e.jsx(F,{value:"all",children:"Todo o histórico"}),e.jsx(F,{value:"thisYear",children:"Este ano"}),e.jsx(F,{value:"thisSemester",children:"Este semestre"}),e.jsx(F,{value:"thisMonth",children:"Este mês"}),e.jsx(F,{value:"custom",children:"Período personalizado"})]})]})]}),x==="custom"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-slate-600 dark:text-slate-400 mb-1 block",children:"Data Início"}),e.jsx("input",{type:"date",value:N,onChange:t=>n(t.target.value),className:"w-full px-3 py-2 rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-slate-600 dark:text-slate-400 mb-1 block",children:"Data Fim"}),e.jsx("input",{type:"date",value:v,onChange:t=>k(t.target.value),className:"w-full px-3 py-2 rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm"})]})]})]}),(m!=="all"||x!=="all")&&e.jsx(G,{variant:"outline",size:"sm",onClick:()=>{S("all"),_("all"),n(""),k("")},className:"mt-4",children:"Limpar filtros"})]}),e.jsx("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(G,{variant:"outline",className:"whitespace-nowrap inline-flex items-center gap-2 border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800",onClick:()=>z("pdf"),children:[e.jsx(ce,{className:"w-4 h-4"}),"Exportar PDF"]}),e.jsxs(G,{variant:"outline",className:"whitespace-nowrap inline-flex items-center gap-2 border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800",onClick:()=>z("excel"),children:[e.jsx(ne,{className:"w-4 h-4"}),"Exportar Excel"]})]})}),l.length===0?e.jsxs(D,{className:"p-8 bg-white dark:bg-slate-900 text-center border border-slate-200 dark:border-slate-800",children:[e.jsx(me,{className:"w-10 h-10 mx-auto mb-3 text-slate-400"}),e.jsx("p",{className:"text-slate-600 dark:text-slate-300",children:"Você ainda não possui atividades registradas. Assim que entregar suas atividades, elas aparecerão aqui."})]}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsx(A,{title:"Média Geral",value:`${w.averageGrade}%`,icon:xe,gradient:"from-cyan-500 to-blue-700",change:`${w.evaluated} avaliações`,delay:0}),e.jsx(A,{title:"Atividades Entregues",value:w.delivered.toString(),icon:re,gradient:"from-cyan-500 to-indigo-700",change:`${w.evaluated} avaliadas`,delay:.1}),e.jsx(A,{title:"Entregues no Prazo",value:`${w.onTimeRate}%`,icon:ue,gradient:"from-emerald-500 to-cyan-600",change:w.onTimeRate>=80?"Excelente":"Pode melhorar",delay:.2}),e.jsx(A,{title:"Feedbacks Recebidos",value:w.feedbackCount.toString(),icon:he,gradient:"from-blue-500 to-indigo-600",change:w.feedbackCount?"Confira suas observações":"Sem feedbacks recentes",delay:.3})]}),B.length>0&&e.jsxs(D,{className:"p-6 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:"Média por Turma"}),e.jsx(q,{width:"100%",height:320,children:e.jsxs(X,{data:B,layout:"vertical",margin:{left:80},children:[e.jsx(K,{strokeDasharray:"3 3"}),e.jsx(U,{type:"number",domain:[0,100],tickFormatter:t=>`${t}%`}),e.jsx(W,{type:"category",dataKey:"name",width:120}),e.jsx(J,{formatter:t=>`${t}%`}),e.jsx(Q,{dataKey:"media",radius:[0,12,12,0],children:B.map((t,a)=>e.jsx("cell",{fill:t.color||"#2563EB"},`bar-${t.name}-${a}`))})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(D,{className:"p-6 bg-card border border-border",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:"Evolução das Notas"}),P.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Faça suas próximas atividades para visualizar sua evolução."}):e.jsx(q,{width:"100%",height:280,children:e.jsxs(X,{data:P,children:[e.jsx(K,{strokeDasharray:"3 3"}),e.jsx(U,{dataKey:"label"}),e.jsx(W,{domain:[0,100],tickFormatter:t=>`${t}%`}),e.jsx(J,{formatter:t=>`${t}%`}),e.jsx(Q,{dataKey:"value",fill:"url(#gradeGradient)",radius:[6,6,0,0]}),e.jsx("defs",{children:e.jsxs("linearGradient",{id:"gradeGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:"#2563EB",stopOpacity:.85}),e.jsx("stop",{offset:"100%",stopColor:"#0EA5E9",stopOpacity:.65})]})})]})})]}),e.jsxs(D,{className:"p-6 space-y-4 bg-card border border-border",children:[e.jsx("h3",{className:"text-lg font-bold",children:"Resumo por Turma"}),E.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Você ainda não possui atividades vinculadas a turmas."}):E.map(t=>e.jsxs("div",{className:"rounded-xl border border-border p-4 bg-background/60",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:t.className}),e.jsxs("p",{className:"text-2xl font-semibold",children:[t.average.toFixed(1),"%"]})]}),e.jsxs(M,{variant:"secondary",className:"whitespace-nowrap",children:[t.gradedCount," avaliações"]})]}),e.jsx(le,{value:t.onTimeRate,className:"h-2 mb-2"}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[e.jsxs("span",{children:["No prazo: ",t.onTimeRate,"%"]}),e.jsxs("span",{children:["Feedbacks: ",t.feedback]})]})]},t.classId||"sem-classe"))]})]}),e.jsxs(D,{className:"p-6 bg-card border border-border mt-6",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:"Histórico de Atividades"}),e.jsx("div",{className:"space-y-4",children:g.map(t=>{const a=t.submitted_at?I(new Date(t.submitted_at),"dd/MM/yyyy 'às' HH:mm",{locale:$}):"—",d=t.activity?.due_date?I(new Date(t.activity.due_date),"dd/MM/yyyy 'às' HH:mm",{locale:$}):null,r=d?t.submitted_at&&new Date(t.submitted_at)<=new Date(t.activity.due_date):null;return e.jsx(D,{className:"p-5 bg-background/80 border border-border",children:e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-semibold text-lg",children:t.activity?.title||"Atividade"}),t.className&&e.jsx(M,{variant:"outline",className:"text-xs",children:t.className})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Entregue em ",a]}),d&&e.jsxs("p",{className:"text-xs mt-1",children:["Prazo: ",e.jsx("span",{className:r?"text-green-600":"text-red-500",children:d})]}),t.feedback&&e.jsxs("div",{className:"mt-3 p-3 rounded-lg bg-card border border-border text-sm",children:[e.jsx("p",{className:"font-medium mb-1",children:"Feedback do professor"}),e.jsx("p",{children:t.feedback})]})]}),e.jsx("div",{className:"flex items-center gap-4",children:t.grade!==null&&t.activity?.max_score?e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Nota"}),e.jsxs("p",{className:"text-3xl font-bold",children:[t.grade,e.jsxs("span",{className:"text-base text-muted-foreground",children:["/",t.activity.max_score]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[(t.grade/t.activity.max_score*100).toFixed(0),"%"]})]}):e.jsx(M,{variant:"secondary",className:"whitespace-nowrap",children:"Em avaliação"})})]})},t.id)})})]})]})]})};export{dt as default};
