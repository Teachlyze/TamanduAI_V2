import{s as c,l as b,r as p}from"./main-BSajwT7t.js";const i=[];for(let r=0;r<256;++r)i.push((r+256).toString(16).slice(1));function j(r,t=0){return(i[r[t+0]]+i[r[t+1]]+i[r[t+2]]+i[r[t+3]]+"-"+i[r[t+4]]+i[r[t+5]]+"-"+i[r[t+6]]+i[r[t+7]]+"-"+i[r[t+8]]+i[r[t+9]]+"-"+i[r[t+10]]+i[r[t+11]]+i[r[t+12]]+i[r[t+13]]+i[r[t+14]]+i[r[t+15]]).toLowerCase()}let x;const H=new Uint8Array(16);function K(){if(!x){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");x=crypto.getRandomValues.bind(crypto)}return x(H)}const L=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),q={randomUUID:L};function W(r,t,s){r=r||{};const a=r.random??r.rng?.()??K();if(a.length<16)throw new Error("Random bytes length must be >= 16");return a[6]=a[6]&15|64,a[8]=a[8]&63|128,j(a)}function I(r,t,s){return q.randomUUID&&!r?q.randomUUID():W(r)}const $={DRAFTS:"drafts",ACTIVITIES:"activities",SUBMISSIONS:"submissions"},_=async(r,t,s="")=>{try{const a=r.name.split(".").pop(),l=`${Math.random().toString(36).substring(2,15)}-${Date.now()}.${a}`,g=s?`${s}/${l}`:l,{data:m,error:h}=await c.storage.from(t).upload(g,r,{cacheControl:"3600",upsert:!1});if(h)throw h;const{data:{publicUrl:d}}=c.storage.from(t).getPublicUrl(g);return{data:{path:m.path,publicUrl:d,fileName:r.name,fileType:r.type,size:r.size},error:null}}catch(a){return b.error("Error uploading file:",a),{data:null,error:a}}},A=async(r,t)=>{try{const{data:s,error:a}=await c.storage.from(r).remove([t]);if(a)throw a;return{data:s,error:null}}catch(s){return b.error("Error removing file:",s),{data:null,error:s}}},G=(r,t)=>{const{data:s}=c.storage.from(r).getPublicUrl(t);return s.publicUrl},J=async(r,t,s,a)=>{try{const{data:l,error:g}=await c.storage.from(r).download(t);if(g)throw g;const{data:m,error:h}=await _(new File([l],a.split("/").pop(),{type:l.type}),s,a.split("/").slice(0,-1).join("/"));if(h)throw h;return await A(r,t),{data:m,error:null}}catch(l){return b.error("Error moving file:",l),{data:null,error:l}}},D=r=>r&&r.startsWith("image/"),z=(r,t,s={})=>{const{width:a=300,height:l=300,quality:g=80,resize:m="cover"}=s,{data:h}=c.storage.from(r).getPublicUrl(t,{transform:{width:a,height:l,resize:m,quality:g}});return h.publicUrl},k=(r,t)=>({small:z(r,t,{width:150,height:150}),medium:z(r,t,{width:300,height:300}),large:z(r,t,{width:600,height:600}),original:G(r,t)}),X=(r,t,s=!1)=>{const[a,l]=p.useState(!1),[g,m]=p.useState(0),[h,d]=p.useState(null),F=p.useCallback(()=>s?$.DRAFTS:$.ACTIVITIES,[s]),T=p.useCallback(e=>{const o=Date.now(),n=e.split(".").pop(),w=I();return`${t}/${r||"temp"}/${o}-${w}.${n}`},[r,t]),M=p.useCallback(async e=>{if(!e)return null;l(!0),d(null);try{const o=F(),n=T(e.name),w={cacheControl:"3600",upsert:!1,onProgress:u=>{const U=Math.round(u.loaded/u.total*100);m(U)}},{data:f,error:v}=await c.storage.from(o).upload(n,e,w);if(v)throw v;const{data:{publicUrl:E}}=c.storage.from(o).getPublicUrl(n),y={id:I(),name:e.name,url:E,path:f.path,size:e.size,type:e.type,isNew:!0,isImage:D(e.type)};return y.isImage&&(y.thumbnails=k(o,f.path)),y}catch(o){throw b.error("Erro ao fazer upload do arquivo:",o),d(o.message||"Erro ao fazer upload do arquivo"),o}finally{l(!1),m(0)}},[F,T]),N=p.useCallback(async e=>{if(!e)return!1;try{const o=F(),{error:n}=await A(o,e);if(n)throw n;return!0}catch(o){throw b.error("Erro ao remover arquivo:",o),d(o.message||"Erro ao remover o arquivo"),o}},[F]),R=p.useCallback(async e=>{if(!e)return!1;try{const o=$.SUBMISSIONS,{error:n}=await A(o,e);if(n)throw n;return!0}catch(o){throw b.error("Erro ao remover arquivo da submissão:",o),d(o.message||"Erro ao remover o arquivo da submissão"),o}},[]),B=p.useCallback(async(e=null)=>{try{if(!s)throw new Error("Apenas rascunhos podem ser publicados");const o=$.DRAFTS,n=$.ACTIVITIES,w=`${t}/${r||"temp"}`,f=`${t}/${e||r}`,{data:v,error:E}=await c.storage.from(o).list(w);if(E)throw E;const y=[];for(const u of v){const U=`${w}/${u.name}`,P=`${f}/${u.name}`,{error:S}=await J(o,U,n,P);if(S){b.warn(`Falha ao mover o arquivo ${u.name}:`,S);continue}const{data:{publicUrl:C}}=c.storage.from(n).getPublicUrl(P);y.push({originalPath:U,newPath:P,url:C,name:u.name,type:u.metadata?.mimetype||"application/octet-stream",size:u.metadata?.size||0})}return y}catch(o){throw b.error("Erro ao publicar arquivos da atividade:",o),d(o.message||"Erro ao publicar os arquivos da atividade"),o}},[r,s,t]),V=p.useCallback(async(e,o)=>{if(!e||!o)throw new Error("Arquivo e ID de submissão são obrigatórios");l(!0),d(null);try{const n=$.SUBMISSIONS,w=e.name.includes(".")?e.name.split(".").pop():"",f=`${Date.now()}-${I()}`,v=w?`${f}.${w}`:f,E=`${t}/${r}/${o}/${v}`,y={cacheControl:"3600",upsert:!1,onProgress:C=>{const O=Math.round(C.loaded/C.total*100);m(O)}},{data:u,error:U}=await c.storage.from(n).upload(E,e,y);if(U)throw U;const{data:{publicUrl:P}}=c.storage.from(n).getPublicUrl(E),S={id:I(),name:e.name,url:P,path:u.path,size:e.size,type:e.type,isNew:!0,isImage:D(e.type)};return S.isImage&&(S.thumbnails=k(n,u.path)),S}catch(n){throw b.error("Erro ao fazer upload da submissão:",n),d(n.message||"Erro ao fazer upload da submissão"),n}finally{l(!1),m(0)}},[r,t]);return{isUploading:a,uploadProgress:g,error:h,uploadActivityFile:M,removeActivityFile:N,publishActivityFiles:B,uploadSubmission:V,removeSubmissionFile:R,resetError:()=>d(null)}};export{X as u};
