import{s as g,l as h}from"./main-KTzSHcut.js";const w=async d=>{try{const{data:e,error:a}=await g.functions.invoke("process-notifications",{body:{notifications:d}});if(a)throw h.error("Erro na Edge Function process-notifications:",a),a;return e}catch(e){throw h.error("Erro ao processar notifica√ß√µes em lote:",e),e}},E=async(d,e)=>{try{const{data:a,error:t}=await g.from("notifications").insert({user_id:d,type:e.type,title:e.title,message:e.message,data:e.data||{},read:!1,created_at:new Date().toISOString()}).select().single();if(t)throw h.error("Erro ao criar notifica√ß√£o:",t),t;return a}catch(a){throw h.error("Erro ao criar notifica√ß√£o:",a),a}};class y{static NotificationType=Object.freeze({EVENT:"event",ASSIGNMENT:"assignment",ANNOUNCEMENT:"announcement",SYSTEM:"system",FEEDBACK:"feedback",REMINDER:"reminder"});static NotificationPriority=Object.freeze({LOW:"low",NORMAL:"normal",HIGH:"high",URGENT:"urgent"});static NotificationCategory=Object.freeze({SYSTEM_UPDATE:"system_update",ACCOUNT:"account",COURSE:"course",ASSIGNMENT:"assignment",EXAM:"exam",GRADE:"grade",MENTION:"mention",COMMENT:"comment",MESSAGE:"message",ANNOUNCEMENT:"announcement",REMINDER:"reminder",ALERT:"alert",PLAGIARISM_ALERT:"plagiarism_alert",AI_DETECTION:"ai_detection"});static async sendNotificationsBatch(e){try{return await w(e)}catch(a){throw h.error("Error sending notifications in batch:",a),a}}static NotificationStatus=Object.freeze({UNREAD:"unread",READ:"read",ARCHIVED:"archived"});static sleep=e=>new Promise(a=>setTimeout(a,e));static withRetry=async(e,a=3)=>{for(let t=0;t<a;t++)try{return await e()}catch(i){if(t===a-1)throw i;await y.sleep(1e3*(t+1))}};static async getNotifications({unreadOnly:e=!1,limit:a=50,offset:t=0,type:i=null,category:r=null}={}){const{data:s,error:l}=await g.auth.getUser();if(l)throw l;const u=s.user?.id;if(!u)throw new Error("No user is currently signed in");let p=g.from("notifications").select("*").eq("user_id",u).order("created_at",{ascending:!1}).range(t,t+a-1);e&&(p=p.eq("is_read",!1)),i&&(p=p.eq("type",i)),r&&(p=p.eq("category",r));const{data:m,error:v}=await p;if(v)throw v;return m||[]}static async markAsRead(e,{userId:a}={}){const t=Array.isArray(e)?e:[e];try{let i=g.from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).in("id",t);a&&(i=i.eq("user_id",a));const{data:r,error:s}=await i;if(s)throw s;return{success:!0,message:"Notifications marked as read successfully",affected:r?.length||0}}catch(i){return h.error("Error marking notifications as read:",i),{success:!1,message:i.message,affected:0}}}static async markAllAsRead(){const{error:e}=await g.from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("is_read",!1);if(e)throw e;return!0}static async deleteNotification(e,{userId:a}={}){const t=Array.isArray(e)?e:[e];try{let i=g.from("notifications").delete().in("id",t);a&&(i=i.eq("user_id",a));const{data:r,error:s}=await i;if(s)throw s;return{success:!0,message:"Notifications deleted successfully",deleted:r?.length||0}}catch(i){return h.error("Error deleting notifications:",i),{success:!1,message:i.message,deleted:0}}}static async sendNotification({title:e,message:a,type:t,category:i,priority:r=y.NotificationPriority.NORMAL,referenceId:s,referenceType:l,actionUrl:u,metadata:p={}},m=null){if(!Object.values(y.NotificationType).includes(t))throw new Error(`Invalid notification type: ${t}`);if(r&&!Object.values(y.NotificationPriority).includes(r))throw new Error(`Invalid priority: ${r}`);if(!m){const{data:f,error:N}=await g.auth.getUser();if(N)throw N;if(m=f.user?.id,!m)throw new Error("No user is currently signed in")}const v={type:t,title:e,message:a,data:{category:i||null,priority:r,referenceId:s||null,referenceType:l||null,actionUrl:u||null,...p}};try{return await E(m,v)}catch(f){h.error("Error using Edge Function, falling back to direct insert:",f);const{data:N,error:A}=await g.from("notifications").insert({...v,user_id:m,created_at:new Date().toISOString()}).select().single();if(A)throw A;return N}}static async getUnreadCount(){const{data:e,error:a}=await g.auth.getUser();if(a)throw a;const t=e.user?.id;if(!t)return 0;const{data:i,error:r}=await g.from("notifications").select("id").eq("user_id",t).eq("is_read",!1).range(0,999);if(r)throw r;return i?.length||0}static async subscribeToNotifications(e){const{data:{user:a}}=await g.auth.getUser(),t=a?.id;if(!t)return{unsubscribe:()=>{}};const i=g.channel("notifications").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${t}`},r=>{typeof e=="function"&&e(r.new)}).subscribe();return{unsubscribe:()=>{try{g.removeChannel(i)}catch{}}}}async subscribeToNotifications(e){return await y.subscribeToNotifications(e)}async getNotifications(e={}){return{data:await y.getNotifications(e)}}async markAsRead(e,a={}){return await y.markAsRead(e,a)}async deleteNotification(e,a={}){return await y.deleteNotification(e,a)}async markAllAsRead(){return await y.markAllAsRead()}async getUnreadCount(){return await y.getUnreadCount()}async sendNotification(e,a=null){return await y.sendNotification(e,a)}static async sendCorrectionNotification({submissionId:e,studentId:a,activityTitle:t,grade:i,maxScore:r}){try{const u=await fetch("https://wapbwaimkurbuihatmix.supabase.co/functions/v1/send-correction-notification",{method:"POST",headers:{Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhcGJ3YWlta3VyYnVpaGF0bWl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODY3MjksImV4cCI6MjA3NDg2MjcyOX0.x-NQQ2TtRgaUjjBZCf6j49eWOW4XSqjTFKC_KB1L56A","Content-Type":"application/json"},body:JSON.stringify({submissionId:e,studentId:a,activityTitle:t,grade:i,maxScore:r})});if(!u.ok){const m=await u.json();throw new Error(m.error||"Erro ao enviar notifica√ß√£o")}return{data:await u.json(),error:null}}catch(s){h.error("Erro ao enviar notifica√ß√£o de corre√ß√£o:",s);try{return await y.sendNotification({title:"Atividade Corrigida",message:`Sua atividade "${t}" foi corrigida. Nota: ${i}/${r}`,type:y.NotificationType.FEEDBACK,category:y.NotificationCategory.GRADE,priority:y.NotificationPriority.HIGH,referenceId:e,referenceType:"submission",metadata:{grade:i,maxScore:r,activityTitle:t}},a),{data:{notificationSent:!0,emailSent:!1},error:null}}catch(l){return{data:null,error:l}}}}}const S=new y,I={async sendEmail({to:d,subject:e,html:a,text:t,from:i}){if(!d||!e||!a&&!t)return{success:!1,error:"Missing required fields: to, subject, and html or text"};const{data:r,error:s}=await g.functions.invoke("send-email",{body:{to:d,subject:e,html:a,text:t,from:i}});return s?(h.error("EmailService.sendEmail error:",s),{success:!1,error:s.message||"invoke failed"}):{success:!!r?.success,emailId:r?.emailId,error:r?.error}},render(d="",e={}){return String(d).replace(/{{\s*([\w.]+)\s*}}/g,(a,t)=>t.split(".").reduce((r,s)=>r&&r[s]!==void 0?r[s]:"",e)??"")}};class H{static async send(e,a={}){const{to:t,variables:i={},language:r="pt",from:s,replyTo:l,attachments:u,tracking:p=!1}=a;if(!t)return{success:!1,error:"Recipient email is required"};if(!e)return{success:!1,error:"Template ID is required"};try{const{data:m,error:v}=await g.functions.invoke("send-email-v2",{body:{templateId:e,to:t,variables:i,language:r,from:s,replyTo:l,attachments:u,tracking:p}});return v?(h.error("EmailTemplateService.send error:",v),{success:!1,error:v.message||"Failed to send email"}):{success:m?.success||!1,emailId:m?.emailId,template:m?.template,error:m?.error}}catch(m){return h.error("EmailTemplateService.send exception:",m),{success:!1,error:m.message||"Unexpected error"}}}static async sendWelcome({to:e,userName:a,confirmationUrl:t,language:i="pt"}){return this.send("welcome",{to:e,variables:{userName:a,confirmationUrl:t},language:i})}static async sendLoginNewDevice({to:e,device:a,time:t,location:i,language:r="pt"}){return this.send("login-new-device",{to:e,variables:{device:a,time:t,location:i},language:r})}static async sendPasswordRecovery({to:e,userName:a,resetUrl:t,language:i="pt"}){return this.send("password-recovery",{to:e,variables:{userName:a,resetUrl:t},language:i})}static async sendPasswordChanged({to:e,time:a,language:t="pt"}){return this.send("password-changed",{to:e,variables:{time:a},language:t})}static async sendAccountConfirmed({to:e,userName:a,dashboardUrl:t,language:i="pt"}){return this.send("account-confirmed",{to:e,variables:{userName:a,dashboardUrl:t},language:i})}static async sendClassInvite({to:e,className:a,teacherName:t,acceptUrl:i,language:r="pt"}){return this.send("class-invite",{to:e,variables:{className:a,teacherName:t,acceptUrl:i},language:r})}static async sendClassInviteAccepted({to:e,studentName:a,className:t,time:i,language:r="pt"}){return this.send("class-invite-accepted",{to:e,variables:{studentName:a,className:t,time:i},language:r})}static async sendStudentAdded({to:e,studentName:a,className:t,teacherName:i,classUrl:r,language:s="pt"}){return this.send("student-added",{to:e,variables:{studentName:a,className:t,teacherName:i,classUrl:r},language:s})}static async sendStudentRemoved({to:e,className:a,time:t,language:i="pt"}){return this.send("student-removed",{to:e,variables:{className:a,time:t},language:i})}static async sendClassCreated({to:e,className:a,classCode:t,classUrl:i,language:r="pt"}){return this.send("class-created",{to:e,variables:{className:a,classCode:t,classUrl:i},language:r})}static async sendNewActivity({to:e,studentName:a,className:t,activityName:i,deadline:r,points:s,activityUrl:l,language:u="pt"}){return this.send("new-activity",{to:e,variables:{studentName:a,className:t,activityName:i,deadline:r,points:s,activityUrl:l},language:u})}static async sendDeadlineWarning({to:e,activityName:a,deadline:t,timeLeft:i,activityUrl:r,language:s="pt"}){return this.send("deadline-warning",{to:e,variables:{activityName:a,deadline:t,timeLeft:i,activityUrl:r},language:s})}static async sendActivityCorrected({to:e,activityName:a,grade:t,maxGrade:i,viewUrl:r,language:s="pt"}){return this.send("activity-corrected",{to:e,variables:{activityName:a,grade:t,maxGrade:i,viewUrl:r},language:s})}static async sendPlagiarismAlert({to:e,studentName:a,activityName:t,percentage:i,severity:r,reviewUrl:s,language:l="pt"}){return this.send("plagiarism-alert",{to:e,variables:{studentName:a,activityName:t,percentage:i,severity:r,reviewUrl:s},language:l})}static async sendMonthlyReport({to:e,userName:a,monthYear:t,activitiesCount:i,averageGrade:r,completionRate:s,reportUrl:l,language:u="pt"}){return this.send("monthly-report",{to:e,variables:{userName:a,monthYear:t,activitiesCount:i,averageGrade:r,completionRate:s,reportUrl:l},language:u})}static async preview(e,a={},t="pt"){return{templateId:e,variables:a,language:t,note:"Preview functionality - implement preview endpoint if needed"}}static getAvailableTemplates(){return[{id:"welcome",category:"auth",name:"Welcome Email"},{id:"login-new-device",category:"auth",name:"New Device Login"},{id:"password-recovery",category:"auth",name:"Password Recovery"},{id:"password-changed",category:"auth",name:"Password Changed"},{id:"account-confirmed",category:"auth",name:"Account Confirmed"},{id:"class-invite",category:"classes",name:"Class Invitation"},{id:"class-invite-accepted",category:"classes",name:"Invite Accepted"},{id:"student-added",category:"classes",name:"Student Added"},{id:"student-removed",category:"classes",name:"Student Removed"},{id:"class-created",category:"classes",name:"Class Created"},{id:"new-activity",category:"activities",name:"New Activity"},{id:"deadline-warning",category:"activities",name:"Deadline Warning"},{id:"activity-corrected",category:"activities",name:"Activity Corrected"},{id:"plagiarism-alert",category:"system",name:"Plagiarism Alert"},{id:"monthly-report",category:"system",name:"Monthly Report"}]}static async getLogs(e={}){const{limit:a=50,offset:t=0,templateId:i,status:r}=e;let s=g.from("email_logs").select("*").order("sent_at",{ascending:!1}).range(t,t+a-1);i&&(s=s.eq("template_id",i)),r&&(s=s.eq("status",r));const{data:l,error:u}=await s;return u?(h.error("Failed to fetch email logs:",u),{success:!1,error:u.message}):{success:!0,data:l}}static async getStatistics(e="30days"){try{const{data:a,error:t}=await g.rpc("get_email_statistics",{period_days:e==="7days"?7:e==="30days"?30:90});if(t)throw t;return{success:!0,data:a}}catch(a){return h.error("Failed to fetch email statistics:",a),{success:!1,error:a.message}}}}const o={AUTHENTICATION:"authentication",ACTIVITY:"activity",CORRECTION:"correction",PLAGIARISM:"plagiarism",SYSTEM:"system",CHATBOT:"chatbot",ANALYTICS:"analytics",GAMIFICATION:"gamification",FEEDBACK:"feedback",MEETING:"meeting",LIVE_CLASS:"live_class"},c={CRITICAL:"critical",HIGH:"high",MEDIUM:"medium",LOW:"low"},n={EMAIL:"email",PUSH:"push",BOTH:"both"},C={critical:{channels:["email","push"],retries:3,delay:0},high:{channels:["email","push"],retries:2,delay:0},medium:{channels:["push"],retries:1,delay:300},low:{channels:["push"],retries:0,delay:1800}};function R(d,e){return e===n.BOTH?["email","push"]:e===n.EMAIL?["email"]:e===n.PUSH?["push"]:(C[String(d||"").toLowerCase()]||C.medium).channels}const M={accountCreated:{id:"accountCreated",type:o.AUTHENTICATION,channel:n.EMAIL,priority:c.CRITICAL,title:"Conta criada com sucesso! üéâ",message:"Bem-vindo(a) ao TamanduAI! Confirme seu email para come√ßar.",emailSubject:"Bem-vindo(a) ao TamanduAI! Confirme seu email",emailHtml:`
      <h2>Bem-vindo(a) ao TamanduAI! üéì</h2>
      <p>Ol√° <strong>{{userName}}</strong>, sua conta foi criada com sucesso.</p>
      <p>Clique no bot√£o para confirmar seu email:</p>
      <p><a href="{{confirmationUrl}}">Confirmar Email</a></p>
      <small>Este link expira em 24 horas.</small>
    `,variables:["userName","confirmationUrl"]},loginNewDevice:{id:"loginNewDevice",type:o.SYSTEM,channel:n.EMAIL,priority:c.MEDIUM,title:"Novo acesso detectado",message:"Login realizado em {device} √†s {time}. Foi voc√™?",emailSubject:"Novo acesso detectado",emailHtml:"<h2>Novo acesso detectado</h2><p>Dispositivo: {{device}} √†s {{time}}</p>",variables:["device","time"]},passwordRecoveryRequested:{id:"passwordRecoveryRequested",type:o.AUTHENTICATION,channel:n.EMAIL,priority:c.CRITICAL,title:"Recupera√ß√£o de senha solicitada",message:"Use o c√≥digo enviado para redefinir sua senha.",emailSubject:"Recupera√ß√£o de senha",emailHtml:"<h2>Recupera√ß√£o de senha</h2><p>Ol√° {{userName}}, utilize o c√≥digo enviado para redefinir sua senha.</p>",variables:["userName"]},passwordChanged:{id:"passwordChanged",type:o.AUTHENTICATION,channel:n.BOTH,priority:c.HIGH,title:"Senha alterada",message:"Sua senha foi alterada com sucesso √†s {time}.",emailSubject:"Senha alterada com sucesso",emailHtml:"<h2>Senha alterada</h2><p>Sua senha foi alterada √†s {{time}}</p>",variables:["time"]},profileCompleted:{id:"profileCompleted",type:o.SYSTEM,channel:n.PUSH,priority:c.MEDIUM,title:"Perfil completo!",message:"Agora voc√™ pode explorar todas as funcionalidades.",variables:[]},classInviteSent:{id:"classInviteSent",type:o.SYSTEM,channel:n.EMAIL,priority:c.HIGH,title:"Convite para turma",message:"Voc√™ foi convidado(a) para a turma {{className}}",emailSubject:"Convite para a turma {{className}}",emailHtml:'<h2>Convite para turma</h2><p>Voc√™ foi convidado(a) para a turma <strong>{{className}}</strong>.</p><p>Clique para aceitar: <a href="{{acceptUrl}}">Aceitar convite</a></p>',variables:["className","acceptUrl"]},classInviteAccepted:{id:"classInviteAccepted",type:o.SYSTEM,channel:n.PUSH,priority:c.MEDIUM,title:"Convite aceito",message:"{{studentName}} entrou na turma {{className}}",variables:["studentName","className"]},studentAddedToClass:{id:"studentAddedToClass",type:o.SYSTEM,channel:n.PUSH,priority:c.MEDIUM,title:"Aluno adicionado",message:"{{studentName}} foi adicionado na turma {{className}}",variables:["studentName","className"]},studentRemovedFromClass:{id:"studentRemovedFromClass",type:o.SYSTEM,channel:n.BOTH,priority:c.HIGH,title:"Voc√™ foi removido da turma",message:"Turma: {{className}}",emailSubject:"Remo√ß√£o da turma {{className}}",emailHtml:"<h2>Remo√ß√£o da turma</h2><p>Voc√™ foi removido da turma {{className}}</p>",variables:["className"]},classCreated:{id:"classCreated",type:o.SYSTEM,channel:n.PUSH,priority:c.LOW,title:"Nova turma criada",message:"{{className}} foi criada com sucesso",variables:["className"]},accountConfirmed:{id:"accountConfirmed",type:o.AUTHENTICATION,channel:n.BOTH,priority:c.HIGH,title:"Email confirmado! ‚úÖ",message:"Sua conta est√° ativa. Complete seu perfil para come√ßar.",emailSubject:"Sua conta foi confirmada",emailHtml:`
      <h2>Conta confirmada</h2>
      <p>Ol√° <strong>{{userName}}</strong>, sua conta foi confirmada com sucesso.</p>
    `,variables:["userName"]},newActivity:{id:"newActivity",type:o.ACTIVITY,channel:n.BOTH,priority:c.HIGH,title:"Nova atividade: {{activityName}}",message:"Prazo: {{deadline}} ‚Ä¢ Pontua√ß√£o: {{points}} pts",emailSubject:"Nova atividade em {{className}}: {{activityName}}",emailHtml:`
      <h2>üìù Nova Atividade Dispon√≠vel</h2>
      <p>Ol√° <strong>{{studentName}}</strong>,</p>
      <p>Uma nova atividade foi publicada na turma <strong>{{className}}</strong>:</p>
      <p><strong>{{activityName}}</strong></p>
      <p>Prazo: {{deadline}} | Pontos: {{points}}</p>
      <p><a href="{{activityUrl}}">Ver Atividade</a></p>
    `,variables:["studentName","className","activityName","deadline","points","activityUrl"]},deadlineWarning24h:{id:"deadlineWarning24h",type:o.ACTIVITY,channel:n.BOTH,priority:c.CRITICAL,title:"‚è∞ Prazo em 24 horas!",message:"{{activityName}} vence amanh√£ √†s {{time}}",emailSubject:"Lembrete: {{activityName}} vence em 24 horas",emailHtml:`
      <h2>‚è∞ Prazo em 24 horas</h2>
      <p>Atividade: {{activityName}}</p>
      <p>Vence em: {{deadline}}</p>
      <p><a href="{{activityUrl}}">Entregar agora</a></p>
    `,variables:["activityName","deadline","time","activityUrl"]},activityCorrected:{id:"activityCorrected",type:o.CORRECTION,channel:n.BOTH,priority:c.HIGH,title:"Atividade corrigida! üéâ",message:"{{activityName}} ‚Ä¢ Nota: {{grade}}/{{maxGrade}}",emailSubject:"Corre√ß√£o dispon√≠vel: {{activityName}}",emailHtml:`
      <h2>‚úÖ Atividade Corrigida</h2>
      <p>{{activityName}} ‚Äî Nota: {{grade}}/{{maxGrade}}</p>
      <p><a href="{{viewUrl}}">Ver detalhes</a></p>
    `,variables:["activityName","grade","maxGrade","viewUrl"]},plagiarismDetected:{id:"plagiarismDetected",type:o.PLAGIARISM,channel:n.EMAIL,priority:c.CRITICAL,title:"üö® Pl√°gio detectado",message:"{{studentName}} ‚Ä¢ {{percentage}}% similaridade ‚Ä¢ {{activityName}}",emailSubject:"Alerta de Pl√°gio: {{activityName}}",emailHtml:`
      <h2>üö® Alerta de Pl√°gio</h2>
      <p>Aluno: {{studentName}}</p>
      <p>Atividade: {{activityName}}</p>
      <p>Similaridade: {{percentage}}%</p>
      <p><a href="{{reviewUrl}}">Revisar submiss√£o</a></p>
    `,variables:["studentName","activityName","percentage","reviewUrl"]},analysisStarted:{id:"analysisStarted",type:o.PLAGIARISM,channel:n.PUSH,priority:c.LOW,title:"An√°lise anti-pl√°gio iniciada",message:"Verificando {{activityName}}..."},falsePositiveMarked:{id:"falsePositiveMarked",type:o.PLAGIARISM,channel:n.PUSH,priority:c.LOW,title:"Falso positivo marcado",message:"An√°lise de pl√°gio atualizada para {{activityName}}"},chatbotTrainingComplete:{id:"chatbotTrainingComplete",type:o.CHATBOT,channel:n.PUSH,priority:c.MEDIUM,title:"Chatbot treinado com sucesso!",message:"Base atualizada com {{filesCount}} arquivos",variables:["filesCount"]},chatbotTrainingError:{id:"chatbotTrainingError",type:o.CHATBOT,channel:n.PUSH,priority:c.HIGH,title:"Erro no treinamento",message:"Falha ao processar {{fileName}}",variables:["fileName"]},newMaterialProcessed:{id:"newMaterialProcessed",type:o.CHATBOT,channel:n.PUSH,priority:c.LOW,title:"Material processado",message:"{{fileName}} adicionado √† base",variables:["fileName"]},outOfScopeInteraction:{id:"outOfScopeInteraction",type:o.CHATBOT,channel:n.PUSH,priority:c.LOW,title:"Pergunta fora do escopo",message:"Aluno perguntou sobre: {{topic}}",variables:["topic"]},monthlyReportGenerated:{id:"monthlyReportGenerated",type:o.ANALYTICS,channel:n.EMAIL,priority:c.MEDIUM,title:"Relat√≥rio mensal gerado",message:"Seu relat√≥rio de {{monthYear}} est√° pronto",emailSubject:"Relat√≥rio mensal - {{monthYear}}",emailHtml:"<h2>Relat√≥rio mensal</h2><p>Seu relat√≥rio de {{monthYear}} est√° pronto.</p>",variables:["monthYear"]},performanceGoalAchieved:{id:"performanceGoalAchieved",type:o.ANALYTICS,channel:n.BOTH,priority:c.MEDIUM,title:"Meta de desempenho atingida",message:"Parab√©ns! Voc√™ atingiu sua meta",emailSubject:"Meta de desempenho atingida",emailHtml:"<h2>Meta de desempenho atingida</h2><p>Parab√©ns!</p>",variables:[]},lowPerformanceDetected:{id:"lowPerformanceDetected",type:o.ANALYTICS,channel:n.EMAIL,priority:c.HIGH,title:"Baixo desempenho detectado",message:"Identificamos baixo desempenho em {{subject}}",emailSubject:"Baixo desempenho detectado",emailHtml:"<h2>Baixo desempenho detectado</h2><p>√Årea: {{subject}}</p>",variables:["subject"]},classReportAvailable:{id:"classReportAvailable",type:o.ANALYTICS,channel:n.PUSH,priority:c.LOW,title:"Relat√≥rio de turma dispon√≠vel",message:"O relat√≥rio da turma {{className}} est√° dispon√≠vel",variables:["className"]},xpEarned:{id:"xpEarned",type:o.GAMIFICATION,channel:n.PUSH,priority:c.LOW,title:"üåü +{{xp}} XP ganho!",message:"{{reason}} ‚Ä¢ Total: {{totalXP}} XP",variables:["xp","reason","totalXP"]},badgeEarned:{id:"badgeEarned",type:o.GAMIFICATION,channel:n.BOTH,priority:c.MEDIUM,title:"üèÜ Nova badge desbloqueada!",message:"{{badgeName}} - {{badgeDescription}}",emailSubject:"Voc√™ desbloqueou: {{badgeName}}",emailHtml:`
      <h2>üèÜ Nova Badge Desbloqueada!</h2>
      <p><strong>{{badgeName}}</strong></p>
      <p>{{badgeDescription}}</p>
      <p><a href="{{profileUrl}}">Ver seu perfil</a></p>
    `,variables:["badgeName","badgeDescription","profileUrl"]},levelUp:{id:"levelUp",type:o.GAMIFICATION,channel:n.BOTH,priority:c.HIGH,title:"üéâ Level Up! N√≠vel {{level}}",message:"Parab√©ns! Voc√™ alcan√ßou o n√≠vel {{level}}!",emailSubject:"Parab√©ns! Voc√™ subiu para o n√≠vel {{level}}",emailHtml:`
      <h2>üéâ Level Up!</h2>
      <p>Parab√©ns! Voc√™ alcan√ßou o <strong>n√≠vel {{level}}</strong>!</p>
      <p>Continue assim e desbloqueie novas conquistas.</p>
    `,variables:["level"]},feedbackReceived:{id:"feedbackReceived",type:o.FEEDBACK,channel:n.BOTH,priority:c.HIGH,title:"üí¨ Novo feedback do professor",message:"{{teacherName}} comentou em {{activityName}}",emailSubject:"Feedback em {{activityName}}",emailHtml:`
      <h2>üí¨ Novo Feedback</h2>
      <p>Professor(a) <strong>{{teacherName}}</strong> deixou um coment√°rio em <strong>{{activityName}}</strong></p>
      <p><a href="{{viewUrl}}">Ver feedback</a></p>
    `,variables:["teacherName","activityName","viewUrl"]},meetingScheduled:{id:"meetingScheduled",type:o.MEETING,channel:n.BOTH,priority:c.MEDIUM,title:"üìÖ Reuni√£o agendada",message:"{{meetingTitle}} em {{date}} √†s {{time}}",emailSubject:"Reuni√£o agendada: {{meetingTitle}}",emailHtml:`
      <h2>üìÖ Reuni√£o Agendada</h2>
      <p><strong>{{meetingTitle}}</strong></p>
      <p>Data: {{date}} √†s {{time}}</p>
      <p><a href="{{meetingUrl}}">Adicionar ao calend√°rio</a></p>
    `,variables:["meetingTitle","date","time","meetingUrl"]},meetingReminder1h:{id:"meetingReminder1h",type:o.MEETING,channel:n.BOTH,priority:c.HIGH,title:"‚è∞ Reuni√£o em 1 hora!",message:"{{meetingTitle}} √†s {{time}}",emailSubject:"Lembrete: {{meetingTitle}} em 1 hora",emailHtml:`
      <h2>‚è∞ Reuni√£o em 1 hora</h2>
      <p><strong>{{meetingTitle}}</strong> √†s {{time}}</p>
      <p><a href="{{meetingUrl}}">Entrar na reuni√£o</a></p>
    `,variables:["meetingTitle","time","meetingUrl"]},meetingReminder5min:{id:"meetingReminder5min",type:o.MEETING,channel:n.PUSH,priority:c.CRITICAL,title:"‚è∞ Reuni√£o em 5 minutos!",message:"{{meetingTitle}} - Prepare-se!",variables:["meetingTitle","meetingUrl"]},liveClassStarting:{id:"liveClassStarting",type:o.LIVE_CLASS,channel:n.BOTH,priority:c.CRITICAL,title:"üî¥ Aula ao vivo come√ßando AGORA!",message:"{{className}} - Clique para entrar",emailSubject:"Aula ao vivo: {{className}}",emailHtml:`
      <h2>üî¥ Aula Ao Vivo</h2>
      <p><strong>{{className}}</strong> est√° come√ßando agora!</p>
      <p><a href="{{liveClassUrl}}">Entrar na aula</a></p>
    `,variables:["className","liveClassUrl"]},liveClassReminder15min:{id:"liveClassReminder15min",type:o.LIVE_CLASS,channel:n.BOTH,priority:c.HIGH,title:"‚è∞ Aula ao vivo em 15 minutos",message:"{{className}} - Prepare seus materiais!",emailSubject:"Aula ao vivo em 15 minutos: {{className}}",emailHtml:`
      <h2>‚è∞ Aula ao vivo em 15 minutos</h2>
      <p><strong>{{className}}</strong></p>
      <p>Prepare seus materiais e esteja pronto!</p>
      <p><a href="{{liveClassUrl}}">Link da aula</a></p>
    `,variables:["className","liveClassUrl"]},liveClassReminder5min:{id:"liveClassReminder5min",type:o.LIVE_CLASS,channel:n.PUSH,priority:c.HIGH,title:"‚è∞ Aula ao vivo em 5 minutos",message:"{{className}} - N√£o se atrase!",variables:["className"]}},O={async send(d,{userId:e,email:a,variables:t={},priorityOverride:i,channelOverride:r,metadata:s}={}){const l=M[d];if(!l)throw new Error(`Unknown notification template: ${d}`);const u=R(i||l.priority,r||l.channel),p=f=>I.render(f,t),m=[];if(u.includes("push")){const f=p(l.title||""),N=p(l.message||"");m.push(S.sendNotification({title:f,message:N,type:l.type,category:l.type,priority:(i||l.priority||"medium").toLowerCase(),metadata:s},e))}if(u.includes("email")){if(!a)throw new Error("Email recipient is required for email delivery");const N={accountCreated:"welcome",classInviteSent:"class-invite",classInviteAccepted:"class-invite-accepted",newActivity:"new-activity",deadlineWarning24h:"deadline-warning",activityCorrected:"activity-corrected",plagiarismDetected:"plagiarism-alert",monthlyReportGenerated:"monthly-report",passwordRecoveryRequested:"password-recovery",passwordChanged:"password-changed",accountConfirmed:"account-confirmed",loginNewDevice:"login-new-device",studentAddedToClass:"student-added",studentRemovedFromClass:"student-removed",classCreated:"class-created"}[d];if(N)m.push(H.send(N,{to:a,variables:t,language:t.language||"pt"}));else{const A=p(l.emailSubject||l.title||"Notifica√ß√£o"),b=l.emailHtml?p(l.emailHtml):void 0,T=b?void 0:p(l.message||"");m.push(I.sendEmail({to:a,subject:A,html:b,text:T}))}}return await Promise.allSettled(m)},async notifyNewActivity({userId:d,email:e,variables:a,metadata:t}){return this.send("newActivity",{userId:d,email:e,variables:a,metadata:t})},async notifyDeadline24h({userId:d,email:e,variables:a,metadata:t}){return this.send("deadlineWarning24h",{userId:d,email:e,variables:a,metadata:t})},async notifyActivityCorrected({userId:d,email:e,variables:a,metadata:t}){return this.send("activityCorrected",{userId:d,email:e,variables:a,metadata:t})},async notifyPlagiarismDetected({userId:d,email:e,variables:a,metadata:t}){return this.send("plagiarismDetected",{userId:d,email:e,variables:a,metadata:t})}};export{O as N,S as a};
