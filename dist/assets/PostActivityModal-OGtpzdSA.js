import{r as i,R as H,j as e,s as n,l as E}from"./main-BtydHokz.js";import{D as I,a as W,b as G,c as J,d as K,e as Q}from"./dialog-BI66C03T.js";import{B as D}from"./button-pkZcz0fw.js";import{I as f}from"./input-DevW5dIO.js";import{L as r}from"./label-Do1Gcpls.js";import{T as X}from"./textarea-BolYe6PH.js";import{C as Y}from"./checkbox-ByVj5oTw.js";import{S as j}from"./switch-BZnWEHpm.js";import{u as Z}from"./use-toast-BD7ojcJx.js";import{U as ee}from"./users-CntpuLnR.js";import{C as se}from"./circle-alert-COBXyI8K.js";import{C as te}from"./calendar-xkfkZRmm.js";const ge=({activities:t,classes:v,onClose:y,onSuccess:P})=>{const{toast:c}=Z(),[l,k]=i.useState([]),[d,F]=i.useState(""),[h,T]=i.useState(t[0]?.max_score||10),[p,L]=i.useState(1),[x,q]=i.useState(""),[$,z]=i.useState(!1),[b,M]=i.useState(!1),[w,U]=i.useState(!0),[g,N]=i.useState(!1),O=H.useMemo(()=>!t||t.length===0?!1:t.every(s=>{const a=(s.activity_type||s.type||"").toLowerCase();return a?!["quiz","closed","objective","project"].includes(a):!0}),[t]),R=s=>{k(a=>a.includes(s)?a.filter(m=>m!==s):[...a,s])},B=async()=>{if(l.length===0){c({title:"Erro",description:"Selecione pelo menos uma turma.",variant:"destructive"});return}if(!d){c({title:"Erro",description:"Defina uma data de entrega.",variant:"destructive"});return}try{N(!0);for(const s of t)for(const a of l){const{data:m}=await n.from("activity_class_assignments").select("id").eq("activity_id",s.id);let C=s.id;const _=(s.activity_type||s.type||"").toLowerCase()==="project"?!1:b;if(m&&m.length>0){const{data:o,error:u}=await n.from("activities").insert({title:s.title,description:s.description,content:s.content,type:s.type,max_score:h,due_date:d,weight:p,instructions:x||s.instructions,plagiarism_enabled:_,status:"published",created_by:s.created_by}).select().single();if(u)throw u;C=o.id}else{const{error:o}=await n.from("activities").update({due_date:d,max_score:h,weight:p,instructions:x||s.instructions,plagiarism_enabled:_,status:"published"}).eq("id",s.id);if(o)throw o}const{error:S}=await n.from("activity_class_assignments").insert({activity_id:C,class_id:a});if(S)throw S;const{error:A}=await n.from("classes").update({updated_at:new Date().toISOString()}).eq("id",a);if(A&&E.warn("Erro ao atualizar updated_at da turma ao postar atividade:",A),w){const{data:o}=await n.from("class_members").select("user_id").eq("class_id",a).eq("role","student");if(o){const u=o.map(V=>({user_id:V.user_id,title:"Nova Atividade Postada",message:`A atividade "${s.title}" foi postada e está disponível.`,type:"activity_posted",data:{activity_id:s.id,class_id:a,due_date:d}}));await n.from("notifications").insert(u)}}}c({title:"Sucesso!",description:`Atividade${t.length>1?"s":""} postada${t.length>1?"s":""} em ${l.length} turma${l.length>1?"s":""}.`}),P()}catch(s){E.error("Erro ao postar atividade:",s),c({title:"Erro",description:"Não foi possível postar a atividade.",variant:"destructive"})}finally{N(!1)}};return e.jsx(I,{open:!0,onOpenChange:y,children:e.jsxs(W,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(G,{children:[e.jsxs(J,{children:["Postar Atividade",t.length>1?"s":"",": ",t[0]?.title,t.length>1&&` (+${t.length-1})`]}),e.jsx(K,{children:"Configure as opções de postagem e selecione as turmas"})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{children:[e.jsxs(r,{className:"text-base font-semibold mb-3 flex items-center gap-2",children:[e.jsx(ee,{className:"w-5 h-5"}),"Selecionar Turmas"]}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto border rounded-lg p-3",children:v.length===0?e.jsxs("div",{className:"text-center py-4 text-gray-500",children:[e.jsx(se,{className:"w-8 h-8 mx-auto mb-2 text-gray-400"}),e.jsx("p",{children:"Você não tem turmas ativas."}),e.jsx("p",{className:"text-sm",children:"Crie uma turma primeiro."})]}):v.map(s=>e.jsxs("div",{className:"flex items-center space-x-2 p-2 hover:bg-gray-50 dark:hover:bg-gray-800 rounded",children:[e.jsx(Y,{id:s.id,checked:l.includes(s.id),onCheckedChange:()=>R(s.id)}),e.jsx(r,{htmlFor:s.id,className:"flex-1 cursor-pointer",children:s.name})]},s.id))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs(r,{htmlFor:"dueDate",className:"flex items-center gap-2",children:[e.jsx(te,{className:"w-4 h-4"}),"Prazo de Entrega *"]}),e.jsx(f,{id:"dueDate",type:"datetime-local",value:d,onChange:s=>F(s.target.value),className:"mt-1",required:!0})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"maxScore",children:"Pontuação Total *"}),e.jsx(f,{id:"maxScore",type:"number",min:"0",step:"0.1",value:h,onChange:s=>T(parseFloat(s.target.value)),className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"weight",children:"Peso na Média"}),e.jsx(f,{id:"weight",type:"number",min:"0",step:"0.1",value:p,onChange:s=>L(parseFloat(s.target.value)),className:"mt-1"})]})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"instructions",children:"Instruções Adicionais (Opcional)"}),e.jsx(X,{id:"instructions",placeholder:"Adicione instruções específicas para esta postagem...",value:x,onChange:s=>q(s.target.value),className:"mt-1 min-h-[100px]"})]}),e.jsxs("div",{className:"space-y-3 p-4 bg-gray-50 dark:bg-gray-900 rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Configurações Avançadas"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(r,{htmlFor:"allowLate",className:"cursor-pointer",children:"Permitir Envio Atrasado"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Alunos poderão submeter após o prazo"})]}),e.jsx(j,{id:"allowLate",checked:$,onCheckedChange:z})]}),O&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(r,{htmlFor:"plagiarism",className:"cursor-pointer",children:"Ativar Antiplágio"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Verificar originalidade das respostas"})]}),e.jsx(j,{id:"plagiarism",checked:b,onCheckedChange:M})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(r,{htmlFor:"notify",className:"cursor-pointer",children:"Notificar Alunos"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Enviar notificação sobre nova atividade"})]}),e.jsx(j,{id:"notify",checked:w,onCheckedChange:U})]})]})]}),e.jsxs(Q,{children:[e.jsx(D,{variant:"outline",onClick:y,disabled:g,children:"Cancelar"}),e.jsx(D,{onClick:B,disabled:g||l.length===0,children:g?"Postando...":"Postar Agora"})]})]})})};export{ge as P};
