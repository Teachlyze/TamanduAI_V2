import{s as o,l as x,h as $,u as A,d as B,b as P,r as v,j as e,a as I}from"./main-BSajwT7t.js";import{B as E}from"./button-49_9eRW2.js";import{C as _}from"./card-Bocxgg1Q.js";import{E as S,N as M,C as O}from"./classService-CFhyXg_Z.js";import{C as L}from"./circle-check-big-DQlvzzB6.js";import{C as F}from"./circle-x-BxcNQ7l5.js";import{B as V}from"./book-open-BqVBcqQl.js";import{U as H}from"./users-De1bkoUV.js";class q{static async createInvite(t,a={}){const{maxUses:i=10,expiresInHours:r=168,recipientEmail:u,role:p="student",invitationType:h=u?"email":"link"}=a,{data:{user:n}}=await o.auth.getUser();if(!n)throw new Error("User not authenticated");const[{data:f},{data:s}]=await Promise.all([o.from("classes").select("id, created_by, name, description").eq("id",t).single(),o.from("class_members").select("id").eq("class_id",t).eq("user_id",n.id).eq("role","teacher").maybeSingle()]);if(!f||f.created_by!==n.id&&!s)throw new Error("Unauthorized: Only class owner/teacher can create invites");const b=new Date;b.setHours(b.getHours()+r);const y=this.generateInvitationCode(),{data:d,error:N}=await o.from("class_invitations").insert([{class_id:t,created_by:n.id,invitation_code:y,invitation_type:h,target_email:u||null,role:p,max_uses:i,current_uses:0,expires_at:b.toISOString(),status:"active"}]).select().single();if(N)throw N;try{if(u){const{data:g}=await o.from("classes").select("name, created_by").eq("id",t).single(),{data:C}=await o.from("profiles").select("full_name").eq("id",g?.created_by).single(),k=`${window?.location?.origin||""}/join/${d.invitation_code}`;await S.sendClassInvite({to:u,className:g?.name||"Turma",teacherName:C?.full_name||"Professor",acceptUrl:k,language:"pt"})}}catch(g){x.warn("Falha ao enviar email de convite:",g)}return d}static async getInvitesByClass(t){const{data:a,error:i}=await o.from("class_invitations").select("*").eq("class_id",t).order("created_at",{ascending:!1});if(i)throw i;return a}static async revokeInvite(t){const{error:a}=await o.from("class_invitations").update({status:"cancelled"}).eq("id",t);if(a)throw a;return!0}static async getInviteDetails(t){const{data:a,error:i}=await o.from("class_invitations").select(`
        *,
        class:classes (
          id,
          name,
          description,
          created_by,
          teacher:profiles!created_by (
            id,
            full_name,
            avatar_url
          )
        )
      `).eq("invitation_code",t).single();if(i)throw new Error("Invalid invitation code");if(a.status!=="active")throw new Error("Invitation is no longer active");if(new Date(a.expires_at)<new Date)throw new Error("Invitation has expired");if(a.max_uses!=null&&a.current_uses>=a.max_uses)throw new Error("Invitation has reached maximum uses");return a}static async acceptInvite(t,a,i={}){const r=await this.getInviteDetails(t),{data:u}=await o.from("class_members").select("id").eq("class_id",r.class_id).eq("user_id",a).maybeSingle();if(u)return{success:!0,alreadyMember:!0,classId:r.class_id};const{error:p}=await o.from("class_members").insert([{class_id:r.class_id,user_id:a,role:r.role||"student",invited_by:r.created_by,joined_at:new Date().toISOString()}]);if(p)throw p;const{error:h}=await o.from("invitation_usages").insert([{invitation_id:r.id,user_id:a}]);h&&x.warn("Failed to record invitation usage",h);try{const{data:n}=await o.from("classes").select("id, name, created_by").eq("id",r.class_id).single(),{data:f}=await o.from("profiles").select("full_name, email").eq("id",a).single(),{data:s}=await o.from("profiles").select("email").eq("id",n?.created_by).single();n?.created_by&&s?.email&&(await S.sendClassInviteAccepted({to:s.email,studentName:f?.full_name||"Aluno",className:n?.name||"Turma",time:new Date().toLocaleString("pt-BR"),language:"pt"}),await M.send("classInviteAccepted",{userId:n.created_by,variables:{studentName:f?.full_name||"Aluno",className:n?.name||"Turma"},channelOverride:"push",metadata:{classId:n.id,inviteId:r.id}}))}catch(n){x.warn("Falha ao notificar convite aceito:",n)}return{success:!0}}static generateInvitationCode(){const t="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let a="";for(let i=0;i<8;i++)a+=t.charAt(Math.floor(Math.random()*t.length));return a}static getInviteLink(t){return`${window?.location?.origin||"https://tamanduai.com"}/join/${t}`}}const Y=()=>{const{invitationCode:j}=$(),t=A(),a=B(),{user:i,profile:r,loading:u}=P(),[p,h]=v.useState(!0),[n,f]=v.useState(!1),[s,b]=v.useState(null),[y,d]=v.useState(null),[N,g]=v.useState(!1),[C,k]=v.useState(null);v.useEffect(()=>{if(!u){if(!i||!r){t("/login",{replace:!0,state:{redirectTo:a.pathname+a.search}});return}T()}},[u,i,r,j,t,a]);const T=async()=>{try{h(!0),d(null),k(null);const m=j?.replace(/\s/g,"").trim().toUpperCase();if(!m){d("C√≥digo de convite inv√°lido");return}let c=null,w=null;try{const l=await q.getInviteDetails(m);l?.class&&(w=l,c={...l.class,invite_code:m,profiles:l.class.teacher?{full_name:l.class.teacher.full_name}:void 0})}catch(l){if(l?.message==="Invitation is no longer active"||l?.message==="Invitation has expired"||l?.message==="Invitation has reached maximum uses"){d("Este convite n√£o est√° mais v√°lido. Pe√ßa um novo link ao professor.");return}x.warn("C√≥digo n√£o encontrado em class_invitations, tentando classes.invite_code",l)}if(!c)try{const l=await O.getClassByInviteCode(m);c={...l,profiles:l.teacher?{full_name:l.teacher.full_name}:l.profiles}}catch(l){x.error("Erro ao buscar turma por c√≥digo:",l),d("Turma n√£o encontrada ou c√≥digo inv√°lido");return}if(!c){d("Turma n√£o encontrada ou c√≥digo inv√°lido");return}k(w),b(c);const{data:U}=await o.from("class_members").select("id").eq("class_id",c.id).eq("user_id",i.id).maybeSingle();if(U){d("Voc√™ j√° √© membro desta turma"),setTimeout(()=>{r.role==="student"?t(`/students/classes/${c.id}`):t(`/dashboard/classes/${c.id}`)},2e3);return}}catch(m){x.error("Erro ao carregar turma:",m),d("Erro ao processar convite")}finally{h(!1)}},D=async()=>{if(!(!s||!i))try{f(!0),d(null);const m=j?.replace(/\s/g,"").trim().toUpperCase();if(C)try{const c=await q.acceptInvite(m,i.id);g(!0);const w=c.classId||C.class_id||s.id;setTimeout(()=>{r.role==="student"?t(`/students/classes/${w}`):t(`/dashboard/classes/${w}`)},1500)}catch(c){x.error("Erro ao aceitar convite:",c),d(c.message||"Erro ao entrar na turma. Tente novamente.")}else{const{error:c}=await o.from("class_members").insert({class_id:s.id,user_id:i.id,role:r.role==="teacher"?"teacher":"student",joined_at:new Date().toISOString()});if(c)throw c;g(!0),setTimeout(()=>{r.role==="student"?t(`/students/classes/${s.id}`):t(`/dashboard/classes/${s.id}`)},1500)}}catch(m){x.error("Erro ao entrar na turma:",m),d("Erro ao entrar na turma. Tente novamente.")}finally{f(!1)}};return p?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-cyan-50 to-purple-50 dark:from-slate-950 dark:to-slate-900 flex items-center justify-center p-6",children:e.jsxs(_,{className:"p-12 text-center max-w-md w-full",children:[e.jsx(I,{className:"w-16 h-16 mx-auto mb-4 text-blue-600 animate-spin"}),e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Carregando convite..."}),e.jsx("p",{className:"text-slate-600 dark:text-slate-400",children:"Aguarde um momento"})]})}):N?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 dark:from-slate-950 dark:to-slate-900 flex items-center justify-center p-6",children:e.jsxs(_,{className:"p-12 text-center max-w-md w-full",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-6 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center",children:e.jsx(L,{className:"w-12 h-12 text-green-600 dark:text-green-400"})}),e.jsx("h2",{className:"text-2xl font-bold mb-2 text-green-900 dark:text-green-100",children:"üéâ Bem-vindo(a)!"}),e.jsxs("p",{className:"text-lg text-slate-600 dark:text-slate-400 mb-4",children:["Voc√™ entrou na turma ",e.jsx("strong",{children:s?.name})]}),e.jsx("p",{className:"text-sm text-slate-500",children:"Redirecionando..."})]})}):y?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-red-50 via-orange-50 to-yellow-50 dark:from-slate-950 dark:to-slate-900 flex items-center justify-center p-6",children:e.jsxs(_,{className:"p-12 text-center max-w-md w-full",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-6 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center",children:e.jsx(F,{className:"w-12 h-12 text-red-600 dark:text-red-400"})}),e.jsx("h2",{className:"text-2xl font-bold mb-2 text-red-900 dark:text-red-100",children:"Ops! Algo deu errado"}),e.jsx("p",{className:"text-lg text-slate-600 dark:text-slate-400 mb-6",children:y}),e.jsxs("div",{className:"flex gap-3 justify-center",children:[e.jsx(E,{variant:"outline",onClick:()=>t(-1),children:"Voltar"}),e.jsx(E,{onClick:()=>{r?.role==="student"?t("/student/classes"):t("/dashboard")},children:"Ir para Dashboard"})]})]})}):s?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-cyan-50 to-purple-50 dark:from-slate-950 dark:to-slate-900 flex items-center justify-center p-6",children:e.jsxs(_,{className:"p-8 max-w-lg w-full",children:[e.jsx("div",{className:`h-32 -mx-8 -mt-8 mb-6 rounded-t-xl bg-gradient-to-r ${s.banner_color||"from-blue-500 to-purple-500"} flex items-center justify-center`,children:e.jsx(V,{className:"w-16 h-16 text-white"})}),e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2 text-slate-900 dark:text-white",children:"Convite para Turma"}),e.jsx("p",{className:"text-slate-600 dark:text-slate-400",children:"Voc√™ foi convidado(a) para entrar em:"})]}),e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800 rounded-xl p-6 mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-900 dark:text-white mb-2",children:s.name}),s.subject&&e.jsxs("p",{className:"text-lg text-slate-700 dark:text-slate-300 mb-3",children:["üìö ",s.subject]}),s.description&&e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400 mb-3",children:s.description}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-500",children:[e.jsx(H,{className:"w-4 h-4"}),e.jsxs("span",{children:["Professor(a): ",s.profiles?.full_name||"Professor"]})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(E,{variant:"outline",className:"flex-1",onClick:()=>t(-1),disabled:n,children:"Cancelar"}),e.jsx(E,{className:"flex-1 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white",onClick:D,disabled:n,children:n?e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"w-4 h-4 mr-2 animate-spin"}),"Entrando..."]}):"Entrar na Turma"})]}),e.jsxs("div",{className:"mt-6 text-center",children:[e.jsx("p",{className:"text-xs text-slate-500 mb-2",children:"C√≥digo de Convite"}),e.jsx("code",{className:"text-sm font-mono bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded",children:s.invite_code})]})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 flex items-center justify-center p-6",children:e.jsx(_,{className:"p-12 text-center max-w-md w-full",children:e.jsx("p",{className:"text-slate-600 dark:text-slate-400",children:"Carregando informa√ß√µes da turma..."})})})};export{Y as default};
