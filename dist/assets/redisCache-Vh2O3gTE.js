const r="https://wapbwaimkurbuihatmix.supabase.co/functions/v1/redis-cache",c="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhcGJ3YWlta3VyYnVpaGF0bWl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODY3MjksImV4cCI6MjA3NDg2MjcyOX0.x-NQQ2TtRgaUjjBZCf6j49eWOW4XSqjTFKC_KB1L56A",i={classStats:300,students:600,activities:300,materials:900,posts:180,default:300};class l{constructor(){this.enabled=!0}async request(e,t={}){if(!this.enabled)return null;try{const s=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({action:e,...t})});if(!s.ok)return s.status===500&&(this.enabled=!1,console.info("[Redis] Cache temporariamente desabilitado (Edge Function não disponível)")),null;const a=await s.json();return a.success?a.result:null}catch{return this.enabled=!1,console.info("[Redis] Cache desabilitado devido a erro de conexão"),null}}async get(e){const t=await this.request("get",{key:e});if(t)try{return JSON.parse(t)}catch{return t}return null}async set(e,t,s=null){const a=typeof t=="string"?t:JSON.stringify(t),n=s||i.default;return await this.request("set",{key:e,value:a,ttl:n})}async delete(e){return await this.request("del",{key:e})}async deletePattern(e){try{const t=await this.request("keys",{pattern:e});if(t&&t.length>0){const s=t.map(a=>({command:"DEL",args:[a]}));return await this.request("batch",{operations:s})}}catch(t){console.warn("Error deleting pattern:",t)}return null}async cacheQuery(e,t,s=null){const a=await this.get(e);if(a!==null)return console.log(`[Cache HIT] ${e}`),a;console.log(`[Cache MISS] ${e}`);const n=await t();return n!=null&&await this.set(e,n,s),n}generateKey(e,...t){return`${e}:${t.join(":")}`}async invalidateClass(e){await this.deletePattern(`class:${e}:*`),await this.deletePattern(`stats:${e}:*`),console.log(`[Cache] Invalidated class ${e}`)}async invalidateUser(e){await this.deletePattern(`user:${e}:*`),console.log(`[Cache] Invalidated user ${e}`)}async getClassStats(e,t){const s=this.generateKey("stats",e,"overview");return await this.cacheQuery(s,t,i.classStats)}async getClassStudents(e,t){const s=this.generateKey("class",e,"students");return await this.cacheQuery(s,t,i.students)}async getClassActivities(e,t){const s=this.generateKey("class",e,"activities");return await this.cacheQuery(s,t,i.activities)}async getClassMaterials(e,t){const s=this.generateKey("class",e,"materials");return await this.cacheQuery(s,t,i.materials)}async getClassPosts(e,t){const s=this.generateKey("class",e,"posts");return await this.cacheQuery(s,t,i.posts)}async ping(){try{return await this.request("ping")==="PONG"}catch{return!1}}disable(){this.enabled=!1,console.warn("[Cache] Disabled")}enable(){this.enabled=!0,console.log("[Cache] Enabled")}}const u=new l;export{u as r};
